

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title> &#8212; Challenges, Skills, and Opportunities</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'act_0/act_0_0/act_0_0_7/act_0_0_7_14';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="https://raw.githubusercontent.com/jhutrc/jhutrc.github.io/main/png/hub_and_spoke.jpg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="https://raw.githubusercontent.com/jhutrc/jhutrc.github.io/main/png/hub_and_spoke.jpg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    Welcome to Fena
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Challenges</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../act_1/act_1_0/act_1_0_0/act_1_0_0_1.html">1. Rigor</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../../act_1/act_1_0/act_1_0_0/act_1_0_0_2.html">2. Error</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../../act_1/act_1_0/act_1_0_0/act_1_0_0_3.html">3. Sloppiness</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Project</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../act_1/act_1_0/act_1_0_1/act_1_0_1_1.html">4. Manuscripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../act_1/act_1_0/act_1_0_1/act_1_0_1_2.html">5. Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../act_1/act_1_0/act_1_0_1/act_1_0_1_3.html">6. Git</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Numeracy</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../act_2/act_2_2/act_2_2_0/act_2_2_0_1.html">7. Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../act_2/act_2_2/act_2_2_0/act_2_2_0_2.html">8. R</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../act_2/act_2_2/act_2_2_0/act_2_2_0_3.html">9. Stata</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Literacy</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../act_3/act_3_0/act_3_0_0/act_3_0_0_1.html">10. Open Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../act_3/act_3_0/act_3_0_0/act_3_0_0_2.html">11. Self-Publishing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../act_3/act_3_0/act_3_0_0/act_3_0_0_3.html">12. Grants</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Workflow</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../act_3/act_3_1/act_3_1_0/act_3_1_0_1.html">13. Automate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../act_3/act_3_1/act_3_1_0/act_3_1_0_2.html">14. Bash</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../act_3/act_3_1/act_3_1_0/act_3_1_0_3.html">15. Unix</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_1/act_3_1_1/act_3_1_1_1.html"></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_1/act_3_1_1/act_3_1_1_2.html"></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_1/act_3_1_1/act_3_1_1_3.html"></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_2/act_3_2_0/act_3_2_0_1.html"></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_2/act_3_2_0/act_3_2_0_2.html"></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_2/act_3_2_0/act_3_2_0_3.html"></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_2/act_3_2_1/act_3_2_1_1.html"></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_2/act_3_2_1/act_3_2_1_2.html"></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../act_3/act_3_2/act_3_2_1/act_3_2_1_3.html"></a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/act_0/act_0_0/act_0_0_7/act_0_0_7_14.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coefplot">1. coefplot</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#matchrun">2. matchrun</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lungdx">3. lungdx</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhdemo">4. nhdemo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhexam">5. nhexam</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhmerge">6. nhmerge</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhmort">7. nhmort</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhsurv">8. nhsurv</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table1">9. table1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kaplan-meier">10. kaplan-meier</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#r">11. r</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#intro">11.1 Intro</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">11.2 Methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#packages">11.3 Packages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#surv">11.4 Surv</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#results">11.5 Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">11.6 Conclusion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table1-options">12. table1_options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#irmatch">13. irmatch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulatepopulation">14. simulatepopulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intervalcensoring">15. intervalcensoring</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-semi-para">16. non-semi-para</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelselection">17. modelselection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stsgraph">18. stsgraph</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1><a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h1>
<section id="coefplot">
<h2>1. coefplot<a class="headerlink" href="#coefplot" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="c1">// Import data</span>
<span class="k">use</span> 18_nhtable102feb2023<span class="m">.</span>dta

<span class="c1">// Write model</span>
<span class="k">logistic</span> female sbp age i<span class="m">.</span>race i<span class="m">.</span>educ income dm smk bmi

<span class="c1">// Command for figure</span>
coefplot,<span class="k"> drop</span>(_cons) eform <span class="cs">/// this is the most important part</span>
    title(<span class="s">&quot;Title name here&quot;</span>, size(med) margin(medsmall) color(black)) <span class="cs">///</span>
    xline(<span class="m">1</span>, lwidth(thin) lpattern(dash) lcolor(red%<span class="m">50</span>)) <span class="cs">///</span>
    xscale(log) <span class="cs">///</span>
    xtitle(<span class="s">&quot;Odds Ratios and 95% Confidence Intervals&quot;</span>, margin(medsmall)) <span class="cs">///</span>
    mlabel<span class="k"> format</span>(<span class="nx">%9.2f</span>) mlabposition(<span class="m">12</span>) mlabgap(<span class="o">*</span>.<span class="m">5</span>) <span class="cs">///</span>
    legend(off) ciopts(lwidth(<span class="o">*</span><span class="m">1</span> <span class="o">*</span><span class="m">5</span>)) <span class="cs">///</span>
<span class="k">    levels</span>(<span class="m">95</span>) msym(s) mfcolor(white) <span class="cs">///</span>
<span class="k">    note</span>(<span class="s">&quot;put anything you want&quot;</span> <span class="cs">///</span>
         ,span size(vsmall)) <span class="cs">///</span>
    plotregion(margin(zero)) <span class="cs">///</span>
    graphregion(color(white))
<span class="k">graph</span> export <span class="s">&quot;model_example.png&quot;</span>,<span class="k"> as</span>(png)<span class="k"> replace</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="matchrun">
<h2>2. matchrun<a class="headerlink" href="#matchrun" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="c1">*Purpose: Pull match run sequence number for organs (designed for lung) that were transplanted</span>
<span class="c1">*Designed by Mary Grace Bowring, adapted by Jess Ruck (any mistakes are definitely Jess&#39;s)</span>
<span class="c1">*Last updated: 1/18/23</span>

<span class="k">capture log close</span>
<span class="k">clear</span>

<span class="k">global</span> DATA <span class="o">/</span>dcs04<span class="o">/</span>legacy<span class="o">-</span>dcs01<span class="o">-</span>igm<span class="o">/</span>segevlab<span class="o">/</span>data<span class="o">/</span>srtr<span class="o">/</span>srtr2211<span class="o">/</span>saf<span class="o">/</span>stata
<span class="k">global</span> FILE <span class="o">/</span>users<span class="o">/</span> <span class="c1">//update with your file path</span>
<span class="k">global</span> LAS <span class="o">/</span>users<span class="o">/</span> <span class="c1">//update with your file path</span>
<span class="k">global</span> START <span class="nf">mdy</span>(<span class="m">01</span>,<span class="m">01</span>,<span class="m">2015</span>) <span class="c1">//update this for your start date</span>
<span class="k">global</span> END <span class="nf">mdy</span>(<span class="m">12</span>,<span class="m">31</span>,<span class="m">2021</span>) <span class="c1">//update this for your end date (last transplant date included)</span>
<span class="k">global</span> CENS <span class="nf">mdy</span>(<span class="m">11</span>,<span class="m">01</span>,<span class="m">2022</span>) <span class="c1">//update this with your censoring date</span>
<span class="k">global</span> OFFERS1 <span class="o">/</span>dcs04<span class="o">/</span>legacy<span class="o">-</span>dcs01<span class="o">-</span>igm<span class="o">/</span>segevlab<span class="o">/</span>data<span class="o">/</span>srtr<span class="o">/</span>srtr2106<span class="o">/</span>ptr <span class="c1">//this folder has all of 2015-2020</span>
<span class="k">global</span> OFFERS2 <span class="o">/</span>dcs04<span class="o">/</span>legacy<span class="o">-</span>dcs01<span class="o">-</span>igm<span class="o">/</span>segevlab<span class="o">/</span>data<span class="o">/</span>srtr<span class="o">/</span>srtr2208<span class="o">/</span>ptr<span class="o">/</span>stata <span class="c1">//this folder has all of 2021 to part of 2022. NOTE: missing heart match run data for 2021</span>

<span class="k">use</span> rec_tx_dt px_id donor_id rec_tx_org_ty rec_age_at_tx <span class="cs">///</span>
don_ty rec_tx_procedure_ty using <span class="vg">${DATA}</span><span class="o">/</span>tx_lu<span class="m">.</span>dta,<span class="k"> clear</span>


<span class="c1">//inclusion/exclusion</span>
<span class="k">keep if</span> <span class="nf">inrange</span>(rec_tx_dt, <span class="vg">$START</span>, <span class="vg">$END</span>)
<span class="k">keep if</span> rec_tx_org_ty<span class="o">==</span><span class="s">&quot;LU&quot;</span> <span class="c1">//lung; update as needed</span>
<span class="k">keep if</span> rec_age_at<span class="o">&gt;=</span><span class="m">18</span> <span class="c1">//adults only; update as needed</span>
<span class="k">keep if</span> don_ty<span class="o">==</span><span class="s">&quot;C&quot;</span> <span class="c1">//deceased donor transplants only</span>
<span class="k">drop if</span> <span class="nf">inlist</span>(rec_tx_procedure,<span class="m">605</span>,<span class="m">606</span>) <span class="c1">//drop lobar transplants for lung</span>

<span class="k">keep</span> donor_id px_id rec_tx_procedure_ty rec_tx_dt

<span class="k">tempfile</span> lu_tx
<span class="k">save</span> <span class="nv">`lu_tx&#39;</span>,replace 
<span class="c1">***************************************************************************</span>
<span class="c1">//2021 offer data </span>

<span class="k">merge</span> <span class="m">1</span>:m px_id donor_id using <span class="vg">$OFFERS2</span><span class="o">/</span>ptr_lu_20210101_20211231_pub<span class="m">.</span>dta,<span class="k"> keep</span>(master match) keepusing(match_id match_submit_dt ptr_sequence_num ptr_offer_id ptr_offer_acpt ptr_org_placed )

<span class="c1">//checking that those that didnt match were outside of offer data dates</span>
<span class="k">codebook</span> rec_tx_dt<span class="k"> if</span> _merge<span class="o">==</span><span class="m">1</span>
<span class="k">codebook</span> rec_tx_dt<span class="k"> if</span> _merge<span class="o">==</span><span class="m">3</span>
<span class="k">list</span> rec_tx_dt<span class="k"> if</span> _merge<span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> <span class="nf">inrange</span>(rec_tx_dt, <span class="nf">mdy</span>(<span class="m">12</span>,<span class="m">25</span>,<span class="m">2020</span>),<span class="nf">mdy</span>(<span class="m">1</span>,<span class="m">09</span>,<span class="m">2022</span>))
<span class="k">tab</span> rec_tx_proc<span class="k"> if</span> _merge<span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> <span class="nf">inrange</span>(rec_tx_dt, <span class="nf">mdy</span>(<span class="m">12</span>,<span class="m">25</span>,<span class="m">2020</span>),<span class="nf">mdy</span>(<span class="m">1</span>,<span class="m">09</span>,<span class="m">2022</span>))
<span class="c1">//9 on the fringe- hopefully in the other data</span>

<span class="k">drop if</span> _merge<span class="o">==</span><span class="m">1</span>
<span class="k">drop</span> _merge

<span class="c1">//at this point ptr_seq isnt missing </span>
<span class="c1">//but might be mulitple match_id/match runs for each pair</span>
<span class="k">codebook</span> ptr_seq
<span class="k">sort</span> match_id px_id donor_id

<span class="k">bys</span> px_id donor_id (match_id) :<span class="k"> gen n</span>=_n
<span class="k">order n</span> match_id px_id donor_id ptr_seq ptr_offer_id ptr_offer_acpt
<span class="k">tab n</span>
<span class="k">bys</span> px_id donor_id :<span class="k"> gen</span> N=_N
<span class="k">order</span> N
<span class="k">list if</span> N<span class="o">==</span><span class="m">3</span>,sepby(px_id)
<span class="k">list if</span> N<span class="o">==</span><span class="m">2</span>,sepby(px_id)

<span class="c1">//keep the larger match_id for each pair</span>
<span class="k">codebook</span> px_id 
<span class="k">codebook</span> donor_id

<span class="c1">//keeps largest match run</span>
<span class="k">keep if</span> N<span class="o">==</span>n

<span class="k">codebook</span> px_id
<span class="k">codebook</span> donor_id

<span class="k">keep</span> px_id donor_id ptr_sequence_numa rec_tx_dt
<span class="k">tempfile</span> offers_2021
<span class="k">save</span> <span class="nv">`offers_2021&#39;</span>,replace

<span class="c1">***************************************************************************</span>
<span class="c1">***************************************************************************</span>
<span class="c1">//now a loop for other years </span>

<span class="k">forvalues</span> i=<span class="m">2015</span><span class="o">/</span><span class="m">2020</span> {
<span class="k">use</span> <span class="nv">`lu_tx&#39;</span>,clear


<span class="k">	merge</span> <span class="m">1</span>:m px_id donor_id using <span class="vg">$OFFERS1</span><span class="o">/</span>ptr_lu_<span class="nv">`i&#39;</span>0101_<span class="nv">`i&#39;</span><span class="m">1231.</span>dta,<span class="k"> keep</span>(master match) keepusing(match_id match_submit_dt ptr_sequence_num ptr_offer_id ptr_offer_acpt ptr_org_placed )
	
	<span class="c1">//checking that those that didnt match were outside of offer data dates</span>
<span class="k">	sum</span> rec_tx_dt<span class="k"> if</span> _merge<span class="o">==</span><span class="m">3</span>
<span class="k">	local</span> min = <span class="nf">r</span>(min)
<span class="k">	local</span> max = <span class="nf">r</span>(max)
<span class="k">	list</span> rec_tx_dt<span class="k"> if</span> _merge<span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> <span class="nf">inrange</span>(rec_tx_dt, <span class="nv">`min&#39;</span>,<span class="nv">`max&#39;</span>)
<span class="k">	tab</span> rec_tx_proc<span class="k"> if</span> _merge<span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> <span class="nf">inrange</span>(rec_tx_dt, <span class="nv">`min&#39;</span>, <span class="nv">`max&#39;</span>)

<span class="k">	drop if</span> _merge<span class="o">==</span><span class="m">1</span>
<span class="k">	drop</span> _merge

	<span class="c1">//at this point ptr_seq isnt missing </span>
	<span class="c1">//but might be mulitple match_id/match runs for each pair</span>
<span class="k">	codebook</span> ptr_seq
<span class="k">	sort</span> match_id px_id donor_id

<span class="k">	bys</span> px_id donor_id (match_id) :<span class="k"> gen n</span>=_n
<span class="k">	order n</span> match_id px_id donor_id ptr_seq ptr_offer_id ptr_offer_acpt
<span class="k">	tab n</span>
<span class="k">	bys</span> px_id donor_id :<span class="k"> gen</span> N=_N
<span class="k">	order</span> N
<span class="k">	list if</span> N<span class="o">==</span><span class="m">3</span>,sepby(px_id)
<span class="k">	list if</span> N<span class="o">==</span><span class="m">2</span>,sepby(px_id)

	<span class="c1">//at this point i think reasonable to keep the larger match_id for each pair</span>
<span class="k">	codebook</span> px_id 
<span class="k">	codebook</span> donor_id 

	<span class="c1">//keeps largest match run</span>
<span class="k">	keep if</span> N<span class="o">==</span>n

<span class="k">	codebook</span> px_id 
<span class="k">	codebook</span> donor_id 

<span class="k">	keep</span> px_id donor_id ptr_sequence_num rec_tx_dt 
<span class="k">	tempfile</span> offers_<span class="nv">`i&#39;</span>

<span class="k">	save</span> <span class="nv">`offers_`i&#39;&#39;</span>,replace 
}
<span class="c1">***************************************************************************</span>
<span class="c1">***************************************************************************</span>
<span class="k">use</span> <span class="nv">`offers_2015&#39;</span>,clear
<span class="k">merge</span> <span class="m">1</span>:<span class="m">1</span> px_id donor_id ptr_seq using <span class="nv">`offers_2016&#39;</span>, nogen
<span class="k">merge</span> <span class="m">1</span>:<span class="m">1</span> px_id donor_id ptr_seq using <span class="nv">`offers_2017&#39;</span>, nogen
<span class="k">merge</span> <span class="m">1</span>:<span class="m">1</span> px_id donor_id ptr_seq using <span class="nv">`offers_2018&#39;</span>, nogen
<span class="k">merge</span> <span class="m">1</span>:<span class="m">1</span> px_id donor_id ptr_seq using <span class="nv">`offers_2019&#39;</span>, nogen
<span class="k">merge</span> <span class="m">1</span>:<span class="m">1</span> px_id donor_id ptr_seq using <span class="nv">`offers_2020&#39;</span>, nogen
<span class="k">merge</span> <span class="m">1</span>:<span class="m">1</span> px_id donor_id ptr_seq using <span class="nv">`offers_2021&#39;</span>, nogen

<span class="k">save</span> <span class="vg">$FILE</span><span class="o">/</span>lung_offers<span class="m">.</span>dta,replace


<span class="c1">*******************************************************************************</span>
<span class="c1">//the method above may provide slightly higher ptr_seq number (bypass are included in that count)</span>
<span class="c1">//below we recalculate ptr_seq for each donor before merging with transplants </span>

<span class="cm">/*</span>
<span class="cm">use match_id px_id donor_id match_submit_dt ptr_sequence_num ptr_offer_id ptr_offer_acpt ptr_org_placed using  $OFFERS2/ptr_lu_20210101_20211231_pub.dta,clear</span>

<span class="cm">sort match_id donor_id ptr_seq</span>
<span class="cm">bys donor_id : egen final_match_id = max(match_id)</span>
<span class="cm">order final_match_id</span>
<span class="cm">drop if final_match_id !=match_id</span>
<span class="cm">//drop if ptr_offer_acpt==&quot;B&quot;</span>
<span class="cm">isid match_id px_id donor_id</span>
<span class="cm">bys match_id (ptr_seq) : gen new_sequence = _n</span>
<span class="cm">compare ptr_seq new_seq</span>

<span class="cm">merge m:1 px_id donor_id using `lu_tx&#39;,keep(using match)</span>
<span class="cm">sort rec_tx_dt </span>
<span class="cm">list rec_tx_dt rec_tx_pro if _merge==2 &amp; inrange(rec_tx_dt, mdy(12,25,2020),mdy(1,09,2022)) ,sep(100)</span>
<span class="cm">codebook px_id donor_id if _merge==3</span>

<span class="cm">//we&#39;re losing ~50 pateitns and donors with this latter method- best to just do the first</span>
<span class="cm">//median seq numbers arent that different after dropping bypasses anyway </span>
<span class="cm">*/</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="lungdx">
<h2>3. lungdx<a class="headerlink" href="#lungdx" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="c1">*Standardized Lung Diagnosis Recoding for TRC</span>
<span class="c1">*Input from OPTN guidelines and Dr. Christian Merlo</span>
<span class="c1">*Last updated: 1/18/23</span>

<span class="k">recode</span> rec_dgn (<span class="m">100</span> <span class="m">103</span> <span class="m">105</span> <span class="m">107</span> <span class="m">109</span> <span class="m">111</span> <span class="m">113</span> <span class="m">114</span> <span class="m">116</span> <span class="m">214</span> <span class="m">410</span> <span class="m">412</span> <span class="m">433</span> <span class="m">450</span> <span class="m">452</span> <span class="m">1603</span> <span class="m">1606</span><span class="o">/</span><span class="m">1608</span> <span class="m">1611</span> = <span class="m">1</span> <span class="s">&quot;Obstructive&quot;</span>) <span class="cs">///</span>
(<span class="m">200</span> <span class="m">202</span> <span class="m">203</span> <span class="m">205</span> <span class="m">206</span> <span class="m">208</span><span class="o">/</span><span class="m">210</span> <span class="m">212</span> <span class="m">216</span> <span class="m">218</span> <span class="m">220</span> <span class="m">442</span> <span class="m">1500</span><span class="o">/</span><span class="m">1502</span> <span class="m">1517</span> <span class="m">1548</span> <span class="m">1549</span> <span class="m">1600</span> <span class="m">1601</span> <span class="m">1614</span> <span class="m">1615</span> = <span class="m">2</span> <span class="s">&quot;Pulm Vascular&quot;</span>) <span class="cs">///</span>
(<span class="m">300</span> <span class="m">302</span> <span class="m">303</span> <span class="m">305</span> <span class="m">1602</span> = <span class="m">3</span> <span class="s">&quot;CF and Immunodeficiency&quot;</span>) <span class="cs">///</span>
(<span class="m">106</span> <span class="m">213</span> <span class="m">215</span> <span class="m">217</span> <span class="m">219</span> <span class="m">400</span><span class="o">/</span><span class="m">411</span> <span class="m">413</span><span class="o">/</span><span class="m">420</span> <span class="m">422</span><span class="o">/</span><span class="m">424</span> <span class="m">432</span><span class="o">/</span><span class="m">434</span> <span class="m">437</span> <span class="m">438</span> <span class="m">440</span><span class="o">/</span><span class="m">442</span> <span class="m">444</span> <span class="m">446</span><span class="o">/</span><span class="m">449</span> <span class="m">451</span><span class="o">/</span><span class="m">454</span> <span class="m">1518</span><span class="o">/</span><span class="m">1525</span> <span class="m">1550</span><span class="o">/</span><span class="m">1557</span> <span class="m">1599</span> <span class="m">1604</span> <span class="m">1605</span> <span class="m">1609</span> <span class="m">1610</span> <span class="m">1612</span> <span class="m">1613</span> <span class="m">1616</span><span class="o">/</span><span class="m">1617</span> = <span class="m">4</span> <span class="s">&quot;Restrictive&quot;</span>) <span class="cs">///</span>
(<span class="m">1997</span> <span class="m">1999</span> = <span class="m">5</span> <span class="s">&quot;Other&quot;</span>),<span class="k"> gen</span>(dgn)
<span class="k">lab var</span> dgn <span class="s">&quot;Recipient Diagnosis&quot;</span>

<span class="k">tab</span> dgn,m
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="nhdemo">
<h2>4. nhdemo<a class="headerlink" href="#nhdemo" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span>cls

<span class="c1">*! demographics</span>
<span class="c1">*! essence: #41</span>

<span class="k">quietly</span> {

<span class="k">     capture log close</span>
<span class="k">     global</span> date:<span class="k"> di</span> <span class="nx">%td</span> <span class="nf">date</span>(<span class="nf">c</span>(current_date),<span class="s">&quot;DMY&quot;</span>)
<span class="k">     quietly log</span> using <span class="s">&quot;03_nhdemo</span><span class="vg">$date</span><span class="s">.log&quot;</span>,<span class="k"> replace</span>
<span class="k">     version</span> <span class="m">12</span>

<span class="k">     global</span> nh3 https:<span class="o">//</span>wwwn<span class="m">.</span>cdc<span class="m">.</span>gov<span class="o">/</span>nchs<span class="o">/</span>data<span class="o">/</span>nhanes3<span class="o">/</span>1a<span class="o">/</span>
<span class="k">     global</span> start = <span class="nf">clock</span>(<span class="nf">c</span>(current_time),<span class="s">&quot;hms&quot;</span>)<span class="o">/</span><span class="m">10</span><span class="o">^</span><span class="m">3</span>

	
	 <span class="c1">//1988-1994</span>
<span class="k">	     noi di</span> <span class="s">&quot;loading... 1988-1994 from </span><span class="vg">$nh3</span><span class="s">&quot;</span>
<span class="k">     infix</span> seqn <span class="m">1-5</span> dmpstat <span class="m">11</span> dmarethn <span class="m">12</span> dmaethnr <span class="m">14</span> hssex <span class="m">15</span> hsageir	<span class="m">18-19</span> <span class="cs">///</span>
	     hfa8r <span class="m">1256-1257</span> hff19r <span class="m">1409-1410</span> sdpphase <span class="m">42</span> using <span class="vg">${nh3}</span>adult<span class="m">.</span>DAT,<span class="k"> clear</span>
<span class="k">	 tempfile</span> surv1
<span class="k">	 gen</span> surv=<span class="m">1</span>
<span class="k">     save</span> <span class="nv">`surv1&#39;</span> 

     <span class="c1">//1999-2017</span>
<span class="k">     global</span> nhanes <span class="s">&quot;https://wwwn.cdc.gov/Nchs/Nhanes&quot;</span>  
<span class="k">     tokenize</span> <span class="s">&quot;</span><span class="nv">`c(ALPHA)&#39;</span><span class="s">&quot;</span> <span class="c1">//i.e., &quot;`2&#39;&quot; -&gt; B, &quot;`3&#39;&quot; -&gt; C, etc.</span>
<span class="k">	 local</span> Letter=<span class="m">1</span> <span class="c1">//tokens: B-J</span>
<span class="k">     local</span> N=<span class="m">2</span> <span class="c1">//surveys: 1999-2017   </span>
<span class="k">	 </span>
<span class="k">	 foreach</span> y of<span class="k"> numlist</span> <span class="m">1999</span> <span class="m">2001</span> <span class="m">2003</span> <span class="m">2005</span> <span class="m">2007</span> <span class="m">2009</span> <span class="m">2011</span> <span class="m">2013</span> <span class="m">2015</span> <span class="m">2017</span> {  
<span class="k">	 	</span>
<span class="k">         local</span> yplus1=<span class="nv">`y&#39;</span> <span class="o">+</span> <span class="m">1</span>  
<span class="k">		 if</span> <span class="nv">`y&#39;</span><span class="o">==</span><span class="m">1999</span> {
<span class="k">		 	 local</span> letter:<span class="k"> di</span> <span class="s">&quot;&quot;</span>
		 }
<span class="k">		 if</span> <span class="nv">`y&#39;</span> <span class="o">&gt;</span><span class="m">2000</span> {
<span class="k">		     local</span> letter:<span class="k"> di</span> <span class="s">&quot;_</span><span class="nv">``Letter&#39;&#39;</span><span class="s">&quot;</span>  
		 }
		 
         import sasxport5 <span class="s">&quot;</span><span class="vg">$nhanes</span><span class="s">/</span><span class="nv">`y&#39;</span><span class="s">-</span><span class="nv">`yplus1&#39;</span><span class="s">/DEMO</span><span class="nv">`letter&#39;</span><span class="s">.XPT&quot;</span>,<span class="k"> clear</span>   
<span class="k">	     noi di</span> <span class="s">&quot;loading... </span><span class="nv">`y&#39;</span><span class="s">-</span><span class="nv">`yplus1&#39;</span><span class="s"> from </span><span class="vg">$nhanes</span><span class="s">&quot;</span>
<span class="k">	     tempfile</span> surv<span class="nv">`N&#39;</span>
<span class="k">		 gen</span> surv=<span class="nv">`N&#39;</span>
<span class="k">         save</span> <span class="nv">`surv`N&#39;&#39;</span> 
<span class="k">	     local</span> N=<span class="nv">`N&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">	     local</span> Letter=<span class="nv">`Letter&#39;</span> <span class="o">+</span> <span class="m">1</span>

     }
<span class="k">	 </span>
<span class="k">	 clear</span>
<span class="k">	 noi di</span> <span class="s">&quot;...&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;LOADED!&quot;</span>
<span class="k">     forvalues</span> i=<span class="m">1</span><span class="o">/</span><span class="m">11</span> {
<span class="k">	 	 append</span> using <span class="nv">`surv`i&#39;&#39;</span>
     }

<span class="k">	 compress</span>
<span class="k">	 local sample</span>=<span class="m">100</span>
<span class="k">	 sample</span> <span class="nv">`sample&#39;</span>
<span class="k">     lab</span> dat <span class="s">&quot;</span><span class="nv">`sample&#39;</span><span class="s">% of NHANES 1988-2018, Demographics&quot;</span>
<span class="k">     save</span> <span class="s">&quot;02_nhdemo</span><span class="vg">$date</span><span class="s">&quot;</span>,<span class="k"> replace</span> 
<span class="k">	 noi di</span> <span class="s">&quot;&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;02_nhdemo</span><span class="vg">$date</span><span class="s">.dta saved to &quot;</span> <span class="nf">word</span>(<span class="s">&quot;</span><span class="nv">`c(pwd)&#39;</span><span class="s">&quot;</span>,<span class="m">1</span>)
     
	 <span class="c1">//big data!</span>
<span class="k">	 noi di</span> <span class="s">&quot;&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;rows x columns:&quot;</span>
<span class="k">	 noi count</span>
<span class="k">	 ds</span> 
<span class="k">	 noi di</span> <span class="nf">wordcount</span>(<span class="nf">r</span>(varlist))
<span class="k">	 </span>
<span class="k">     global</span> finish  = <span class="nf">clock</span>(<span class="nf">c</span>(current_time),<span class="s">&quot;hms&quot;</span>)<span class="o">/</span><span class="m">10</span><span class="o">^</span><span class="m">3</span>
<span class="k">     global</span> duration = <span class="nf">round</span>((<span class="vg">$finish</span> <span class="o">-</span> <span class="vg">$start</span>)<span class="o">/</span><span class="m">60</span>,<span class="m">1</span>)

<span class="k">     noi di</span> <span class="s">&quot;runtime = </span><span class="vg">$duration</span><span class="s"> minute(s)&quot;</span>
<span class="k">     log close</span>

}
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="nhexam">
<h2>5. nhexam<a class="headerlink" href="#nhexam" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span>cls

<span class="c1">*! assemble datasets</span>
<span class="c1">*! exam, lab, q&amp;a </span>
<span class="c1">*! do so for all nh surveys</span>

<span class="k">quietly</span> {
<span class="k">	</span>
<span class="k">     capture log close</span>
<span class="k">     global</span> date:<span class="k"> di</span> <span class="nx">%td</span> <span class="nf">date</span>(<span class="nf">c</span>(current_date),<span class="s">&quot;DMY&quot;</span>)
<span class="k">     log</span> using <span class="s">&quot;06_nhexam</span><span class="vg">$date</span><span class="s">.log&quot;</span>,<span class="k"> replace</span>
<span class="k">     version</span> <span class="m">12</span> 

<span class="k">     global</span> nh3 https:<span class="o">//</span>wwwn<span class="m">.</span>cdc<span class="m">.</span>gov<span class="o">/</span>nchs<span class="o">/</span>data<span class="o">/</span>nhanes3<span class="o">/</span>1a<span class="o">/</span>
<span class="k">     global</span> nhanes <span class="s">&quot;https://wwwn.cdc.gov/Nchs/Nhanes&quot;</span> 
<span class="k">     global</span> start = <span class="nf">clock</span>(<span class="nf">c</span>(current_time),<span class="s">&quot;hms&quot;</span>)<span class="o">/</span><span class="m">10</span><span class="o">^</span><span class="m">3</span>
	
	 
     <span class="c1">//1988-1994</span>
<span class="k">	 noi di</span> <span class="s">&quot;processing... 1988-1994/EXAM.DAT&quot;</span> 
<span class="k">     infix</span> seqn <span class="m">1-5</span> pepmnk1r <span class="m">1423-1425</span> pepmnk5r <span class="m">1428-1430</span> bmpbmi <span class="m">1524-1527</span> <span class="cs">/// </span>
	     using <span class="vg">${nh3}</span>exam<span class="m">.</span>dat,<span class="k"> clear</span>
<span class="k">     tempfile</span> exam
<span class="k">     save</span> <span class="nv">`exam&#39;</span>

<span class="k">	 noi di</span> <span class="s">&quot;processing... 1988-1994/LAB.DAT&quot;</span> 
<span class="k">	 infix</span> seqn <span class="m">1-5</span> ghp <span class="m">1861-1864</span> ubp <span class="m">1965-1970</span> urp <span class="m">1956-1960</span> sgpsi <span class="m">1761-1765</span> <span class="cs">/// </span>
		 cep <span class="m">1784-1787</span> using <span class="vg">${nh3}</span>lab<span class="m">.</span>dat,<span class="k"> clear</span>
<span class="k">     tempfile lab</span>
<span class="k">     save</span> <span class="nv">`lab&#39;</span>
<span class="k">	 </span>
<span class="k">	 noi di</span> <span class="s">&quot;processing... 1988-1994/ADULT.DAT&quot;</span> 
<span class="k">     infix</span> seqn <span class="m">1-5</span> hae4d2 <span class="m">1605</span> had1 <span class="m">1561</span> had6 <span class="m">1568</span> had10 <span class="m">1578</span> hak1 <span class="m">1855</span> <span class="cs">/// </span>
	     hae2 <span class="m">1598</span> hae5a <span class="m">1610</span> hat1met <span class="m">2393-2395</span> har1 <span class="m">2281</span> <span class="cs">///</span>
		 using <span class="vg">${nh3}</span>adult<span class="m">.</span>DAT,<span class="k"> clear</span>
<span class="k">		 </span>
<span class="k">     tempfile</span> qa 
<span class="k">     save</span> <span class="nv">`qa&#39;</span>  
<span class="k">	 </span>
<span class="k">     use</span> <span class="nv">`exam&#39;</span>,<span class="k"> clear</span> 
<span class="k">     merge</span> <span class="m">1</span>:<span class="m">1</span> seqn using <span class="nv">`lab&#39;</span>, nogen
<span class="k">     merge</span> <span class="m">1</span>:<span class="m">1</span> seqn using <span class="nv">`qa&#39;</span>, nogen 
<span class="k">	 	 </span>
<span class="k">     gen</span> surv=<span class="m">1</span>
<span class="k">	 tempfile</span> exam_0
<span class="k">     save</span> <span class="nv">`exam_0&#39;</span> 
	 
	 <span class="c1">//1999-2018</span>
<span class="k">	 tokenize</span> <span class="s">&quot;</span><span class="nv">`c(ALPHA)&#39;</span><span class="s">&quot;</span> <span class="c1">//i.e., &quot;`2&#39;&quot; -&gt; B, &quot;`3&#39;&quot; -&gt; C, etc.</span>
<span class="k">     local</span> surv=<span class="m">2</span>
<span class="k">	 </span>
<span class="k">	 local</span> y=<span class="m">1999</span>
<span class="k">	 </span>
<span class="k">	 forvalues</span> i=<span class="m">1</span><span class="o">/</span><span class="m">10</span>  { <span class="c1">//nhanes survey</span>
<span class="k">	 	</span>
<span class="k">		 local</span> yp1=<span class="nv">`y&#39;</span><span class="o">+</span><span class="m">1</span>
<span class="k">		 </span>
<span class="k">  		 forvalues</span> j=<span class="m">1</span><span class="o">/</span><span class="m">11</span> { <span class="c1">//specific datafile</span>
<span class="k">	     </span>
<span class="k">		 local</span> DATA1 BPX BMX LAB10 LAB16  LAB18  ALQ DIQ KIQ   BPQ PAQ SMQ  	
<span class="k">         local</span> DATA2 BPX BMX L10   L16    L40    ALQ DIQ KIQ_U BPQ PAQ SMQ 
<span class="k">         local</span> DATA3 BPX BMX GHB   ALB_CR BIOPRO ALQ DIQ KIQ_U BPQ PAQ SMQ 
<span class="k">		 </span>
<span class="k">		 if</span> <span class="nv">`i&#39;</span><span class="o">==</span><span class="m">1</span> {
<span class="k">		 	 local</span> letter:<span class="k"> di</span> <span class="s">&quot;&quot;</span> 
<span class="k">			 local</span> DATA <span class="nv">`DATA1&#39;</span>
		 }
<span class="k">		 if</span> <span class="nf">inlist</span>(<span class="nv">`i&#39;</span>, <span class="m">2</span>, <span class="m">3</span>) {
<span class="k">		 	 local</span> letter:<span class="k"> di</span> <span class="s">&quot;_</span><span class="nv">``i&#39;&#39;</span><span class="s">&quot;</span>  
<span class="k">			 local</span> DATA <span class="nv">`DATA2&#39;</span>
		 }
<span class="k">		 if</span> <span class="nf">inrange</span>(<span class="nv">`i&#39;</span>, <span class="m">4</span>,<span class="m">11</span>) {
<span class="k">		 	 local</span> letter:<span class="k"> di</span> <span class="s">&quot;_</span><span class="nv">``i&#39;&#39;</span><span class="s">&quot;</span>
<span class="k">			 local</span> DATA <span class="nv">`DATA3&#39;</span>
		 }
<span class="k">		 </span>
<span class="k">		 local</span> DATA:<span class="k"> di</span> <span class="nf">word</span>(<span class="s">&quot;</span><span class="nv">`DATA&#39;</span><span class="s">&quot;</span>,<span class="nv">`j&#39;</span>) 	<span class="c1">//jth datafile </span>
	     import sasxport5 <span class="s">&quot;</span><span class="vg">$nhanes</span><span class="s">/</span><span class="nv">`y&#39;</span><span class="s">-</span><span class="nv">`yp1&#39;</span><span class="s">/</span><span class="nv">`DATA&#39;`letter&#39;</span><span class="s">.XPT&quot;</span>,<span class="k"> clear</span>  
<span class="k">		 noi di</span> <span class="s">&quot;processing... </span><span class="nv">`y&#39;</span><span class="s">-</span><span class="nv">`yp1&#39;</span><span class="s">/</span><span class="nv">`DATA&#39;`letter&#39;</span><span class="s">.XPT&quot;</span>
<span class="k">         tempfile</span> dat<span class="nv">`j&#39;</span>
<span class="k">         save</span> <span class="nv">`dat`j&#39;&#39;</span> 
	
	     }
<span class="k">   </span>
<span class="k">         use</span> <span class="nv">`dat1&#39;</span>,<span class="k"> clear</span>
<span class="k">         forvalues</span> k=<span class="m">2</span><span class="o">/</span><span class="m">11</span> { <span class="c1">//merge k datafiles from 1 year</span>
<span class="k">             merge</span> <span class="m">1</span>:<span class="m">1</span> seqn using <span class="nv">`dat`k&#39;&#39;</span>,<span class="k"> gen</span>(merge<span class="nv">`k&#39;</span>)
         }

<span class="k">	     gen</span> surv=<span class="nv">`surv&#39;</span>
<span class="k">	     local</span> surv=<span class="nv">`surv&#39;</span><span class="o">+</span><span class="m">1</span>
<span class="k">	 </span>
<span class="k">	     tempfile</span> exam_<span class="nv">`i&#39;</span>
<span class="k">	     save</span> <span class="nv">`exam_`i&#39;&#39;</span> <span class="c1">//one datafile from ith survey </span>
<span class="k">		 local</span> y=<span class="nv">`y&#39;</span><span class="o">+</span><span class="m">2</span> 
		 
     }
<span class="k">	 </span>
<span class="k">	 clear</span>
<span class="k">	 use</span> <span class="nv">`exam_0&#39;</span> <span class="c1">//1988-1994: nhanes 3</span>
<span class="k">     forvalues</span> i=<span class="m">1</span><span class="o">/</span><span class="m">10</span> {
<span class="k">	 append</span> using <span class="nv">`exam_`i&#39;&#39;</span> <span class="c1">//1999-2018: continuous nhanes</span>

     }
<span class="k">	 </span>
<span class="k">     lab</span> dat <span class="s">&quot;NHANES 1988-2018, Q&amp;A/Exam/Labs&quot;</span>
<span class="k">	 lookfor</span> smq
<span class="k">     save</span> <span class="s">&quot;05_nhexam</span><span class="vg">$date</span><span class="s">&quot;</span>,<span class="k"> replace</span>
<span class="k">	 noi di</span> <span class="s">&quot;&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;05_nhexam</span><span class="vg">$date</span><span class="s">.dta saved to &quot;</span> <span class="nf">word</span>(<span class="s">&quot;</span><span class="nv">`c(pwd)&#39;</span><span class="s">&quot;</span>,<span class="m">1</span>)
	 
	 <span class="c1">//big data!</span>
<span class="k">	 noi di</span> <span class="s">&quot;&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;rows x columns:&quot;</span>
<span class="k">	 noi count</span>
<span class="k">	 ds</span> 
<span class="k">	 noi di</span> <span class="nf">wordcount</span>(<span class="nf">r</span>(varlist))
<span class="k">	 </span>
<span class="k">global</span> finish  = <span class="nf">clock</span>(<span class="nf">c</span>(current_time),<span class="s">&quot;hms&quot;</span>)<span class="o">/</span><span class="m">10</span><span class="o">^</span><span class="m">3</span>
<span class="k">global</span> duration = <span class="nf">round</span>((<span class="vg">$finish</span> <span class="o">-</span> <span class="vg">$start</span>)<span class="o">/</span><span class="m">60</span>,<span class="m">1</span>)

<span class="k">noi di</span> <span class="s">&quot;runtime = </span><span class="vg">$duration</span><span class="s"> minute(s)&quot;</span>

<span class="k">log close</span>
	 
}



<span class="c1">*! quietly, loops, indent</span>
<span class="c1">*! collapsing, debugging</span>
<span class="c1">*! this is a pro-tip :)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="nhmerge">
<h2>6. nhmerge<a class="headerlink" href="#nhmerge" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span>cls
macro drop _all

*! merge nhdemo &amp; nhexam 
*! rename variables
*! selection criteria



quietly {
	
	 capture log close
     global date: di %td date(c(current_date),&quot;DMY&quot;)
     log using &quot;09_nhtable$date.log&quot;, replace
     version 12
     global start = clock(c(current_time),&quot;hms&quot;)/10^3 
	
     //1.data
	 
     use 05_nhexam$date, clear  
	 replace seqn=-1*seqn if surv==1  //restore unique seqn across surveys 
	 tempfile 05_nhexam  
	 save `05_nhexam&#39;
	
     use 02_nhdemo$date, clear
	 replace seqn=-1*seqn if surv==1
	 merge 1:1 seqn using `05_nhexam&#39; //enforce a strictly 1:1 merge 
	 
	 keep if _merge==3

}



quietly {
	 
	 //2.variables
	 
	 //seqn
	 isid seqn
	 
	 //survey
	 g year=surv
	 lab var year &quot;Year of Donation, %&quot;
	 label define Year ///
	     1 &quot;1988-1998&quot; ///
		 2 &quot;1999-2000&quot; ///
		 3 &quot;2001-2002&quot; ///
		 4 &quot;2003-2004&quot; ///
		 5 &quot;2005-2006&quot; ///
		 6 &quot;2007-2008&quot; ///
		 7 &quot;2009-2010&quot; ///
		 8 &quot;2011-2012&quot; ///
		 9 &quot;2013-2014&quot; ///
		 10 &quot;2015-2016&quot; ///
		 11 &quot;2017-2018&quot; 
	 label values year Year
	 
	 //eligibility
	     //1988-1998
	 drop if inlist(dmpstat,1,3)
	 
	     //1999-2018
	 drop if ridstatr==1
	 
	 //race
	     //1988-1998
	 g race=dmarethn
	 label var race &quot;Race/ethnicity, %&quot;
	 label define Race 1 &quot;White&quot; 2 &quot;Black&quot; 3 &quot;Hispanic&quot; 4 &quot;Other&quot; 
	 label values race Race
	 
	    //1999-2018
	 recode ridreth1 (3=1)(4=2)(1 2=3)(5=4)
	 replace race=ridreth1 if inrange(year,2,11)
	 
	 recode ridreth3 (3=1)(4=2)(1 2=3)(6=4)(7=5),gen(race2)
	 label var race2 &quot;Race/ethnicity, %&quot;
	 label define Race2 1 &quot;White&quot; 2 &quot;Black&quot; 3 &quot;Hispanic&quot; 4 &quot;Asian&quot; 5 &quot;Other&quot; 
	 label values race2 Race2
	 
	 //sex
	     //1988-1998
	 recode hssex (1=0)(2=1),gen(female)
	 label var female &quot;Female, %&quot;
	 
	     //1999-2018
	 recode riagendr (1=0)(2=1)
	 replace female=riagendr if inrange(year,2,11)
	 
	 //age
	     //1988-1998
     g age=hsageir 
	 label var age &quot;Age, y, median [IQR]&quot;
	 
	     //1999-2018
	 replace age=ridageyr if inrange(year,2,11)
	 
	     //eligibility
	 drop if !inrange(age,18,90)
	 
	 //education
	     //1988-1998
     recode hfa8r ///  
     (0/8=1) ///k-8
	 (9/12 13=2) ///highsch, diploma
	 (14/15=3) ///some coll/assoc
	 (16/17=4) ///coll/above
	 (66/99=.), gen(educ)
	 
	     //1999-2018
	 recode dmdeduc2 ///
	 (2 3=2) ///
	 (4=3) ///
	 (5=4) ///
	 (7 9=.)
	 replace educ=dmdeduc2 if inrange(year,2,11)
	 
     label define Educ /// 
     1 &quot;K-8&quot; ///
	 2 &quot;High school, Diploma/equivalent&quot; ///
	 3 &quot;Some college/associate&quot; ///
	 4 &quot;College graduate/above&quot; 
     label values educ Educ
	 label var educ &quot;Education, %&quot;
		 
	 //income
	     //1988-1998
	 g income=hff19r
	 label var income &quot;Income, $, median [IQR]&quot;
	 
	 replace income=. if inlist(income,88,99) 
     replace income=round(rweibull(2, 5000, 0)) if inrange(income,0,2)
     
	 forvalues i=3/20 {
	     replace income=round(runiform((`i&#39;000-1000),`i&#39;000)) if income==`i&#39;
     }
    
	 local lb=20000
     forvalues i=21/26 {
	     local ub=`lb&#39; + 4999
	     di &quot;`lb&#39;&quot; &quot; `ub&#39;&quot;
	     replace income=round(runiform(`lb&#39;,`ub&#39;)) if income==`i&#39;
	     local lb=`ub&#39; + 1
     }
   
     replace income=round(rweibull(1.09, 25000, 50000)) if income==27
	 
	     //1999-2018
		 
	 replace income=indhhinc  if inrange(year,2,5)
	 replace income=indhhin2  if inrange(year,6,11)
	 local lb=0
     foreach i of numlist 1 2 3 4 5 {
         local ub=`lb&#39; + 4999	     
		 replace income=runiform(`lb&#39;,`ub&#39;) if income==`i&#39; &amp; year!=1
		 local lb=`ub&#39; + 1
     }
    
	 local lb=25000
     foreach i of numlist 6 7 8 9 10 11 {
	     local ub=`lb&#39; + 9999
	     replace income=runiform(`lb&#39;,`ub&#39;) if income==`i&#39; &amp; year!=1
	     local lb=`ub&#39; + 1
     }
   
	 //dm
	     //1988-1998
	 recode had1 (2=0)(8 9=.), gen(dm)  
	 label var dm &quot;Diabetes, %&quot;
	 
	     //1999-2018
	 recode diq010 (1 3=1)(2=0)(7 9=.)
	 replace dm=diq010 if inrange(year,2,11)
		 
	 //htn
	     //1988-1998
	 recode hae2 (2=0)(8 9=.), gen(htn)  
	 label var htn &quot;Hypertension, %&quot;
	 
	     //1999-2018
     recode bpq020 (2=0)(9=.)
	 replace htn=bpq020 if inrange(year,2,11)
	 
	 //ckd 
	     //1988-1998
	 ***
		   
		 //1999-2018
	 recode kiq020 (2=0)(7 9=.) if inlist(year,2),gen(ckd)
	 recode kiq022 (2=0)(7 9=.) if inrange(year,3,11)
	 replace ckd=kiq022 if inrange(year,3,11)
	 label var ckd &quot;CKD, %&quot;
	 
	 //smoke
	     //1988-1998
	 recode har1 (2=0),gen(smk)
	 label var smk &quot;Smoke, %&quot;
	 
	     //1999-2018
	 recode smq020 (2=0)(7 9=.)
	 replace smk=smq020 if inrange(year,2,11)
	 
	 //bp
	     //1988-1998
	 g sbp=pepmnk1r
	 label var sbp &quot;SBP, mmHg, median [IQR]&quot;
	 g dbp=pepmnk5r
	 label var dbp &quot;DBP, mmHg, median [IQR]&quot;
	 
	     //1999-2018
	 replace sbp=bpxsar if inrange(year,2,4)
	 replace dbp=bpxdar if inrange(year,2,4)
	 
	 replace sbp=bpxsy1 if inrange(year,5,11)
	 replace dbp=bpxdi1 if inrange(year,5,11)

	 //bmi
	     //1988-1998
	 g bmi=bmpbmi
	 label var bmi &quot;BMI, kg/m2, median [IQR]&quot;
	 
	     //1999-2018
	 replace bmi=bmxbmi if inrange(year,2,11)

	 //hba1c
	     //1988-1998
	 g hba1c=ghp
	 label var hba1c &quot;HBA1c, %, median [IQR]&quot;
	 
	     //1988-1998
	 replace hba1c=lbxgh if inrange(year,2,11)
	 
	 //uacr
	     //1988-1998
	 g acr=(ubp*1/10^-3)/(urp*1/10^-1) 
	 label var acr &quot;uACR, mg/g, median [IQR]&quot;
	 
	     //1999-2018
     replace acr=(urxuma*1/10^-3)/(urxucr*1/10^-1) if inrange(year,2,11)
	
	g logacr=log(acr)
	 label var logacr &quot;Log uACR, log(mg/g), median [IQR]&quot;	
	 
	 //glucose
	     //1988-1998
	 g glucose=sgpsi*18/10
	 label var glucose &quot;Glucose, mg/L, median [IQR]&quot;
	 
	     //1999-2018
	 replace glucose=lbxsgl*1/10^1 if inrange(year,2,11)
	 
	 //creatinine
	     //1988-1998
	 g creat=cep
	 label var creat &quot;Serum Creatinine, mg/dL, median [IAR]&quot;
	 
	     //1999-2018
	 replace creat=lbdscrsi/88.42 if inrange(year,2,11)

     
	 //ckd-epi
     replace creat=0.960*creat-0.184 if year==1
     local k=cond(female==1,0.7,0.9)
     local alpha=cond(female==1,-0.329,-0.411)
     g egfr=141*min(creat/`k&#39;,1)^`alpha&#39;* ///
	            max(creat/`k&#39;,1)^-1.209* ///
			    0.993^age* ///
				1.018^female* ///
				1.159^(race==2) if !missing(creat)
 	 label var egfr &quot;eGFR, ml/min/1.73m2, median [IAR]&quot;
	 
	
}

quietly {
	
	 //3.keep variables 
	     keep seqn age female race race2 educ income dm htn smk ///
		     sbp dbp bmi hba1c glucose acr logacr creat egfr year
}

	 
     lab dat &quot;NHANES 1988-2018, Demographic &amp; Health Characteristics&quot;
     save &quot;08_nhtable$date&quot;, replace
	
	
quietly {
	
		 //big data!
	 noi di &quot;&quot;
	 noi di &quot;rows x columns:&quot;
	 noi count
	 ds 
	 noi di wordcount(r(varlist))
	 
     global finish  = clock(c(current_time),&quot;hms&quot;)/10^3
     global duration = round(($finish - $start)/60,1)

     noi di &quot;runtime = $duration minute(s)&quot;	

     log close
	
}



</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="nhmort">
<h2>7. nhmort<a class="headerlink" href="#nhmort" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span>cls
<span class="k">clear</span>

<span class="c1">*! mortality linkage</span>
<span class="c1">*! cruxes at lines 35 &amp; 47</span>



<span class="k">quietly</span> {
<span class="k">	</span>
<span class="k">     capture log close</span>
<span class="k">     global</span> date:<span class="k"> di</span> <span class="nx">%td</span> <span class="nf">date</span>(<span class="nf">c</span>(current_date),<span class="s">&quot;DMY&quot;</span>)
<span class="k">     log</span> using <span class="s">&quot;12_nhmort</span><span class="vg">$date</span><span class="s">.log&quot;</span>,<span class="k"> replace</span>
<span class="k">     version</span> <span class="m">12</span>

<span class="k">     global</span> start = <span class="nf">clock</span>(<span class="nf">c</span>(current_time),<span class="s">&quot;hms&quot;</span>)<span class="o">/</span><span class="m">10</span><span class="o">^</span><span class="m">3</span>	

     <span class="c1">//1.data</span>
<span class="k">     global</span> nchs https:<span class="o">//</span>ftp<span class="m">.</span>cdc<span class="m">.</span>gov<span class="o">/</span>pub<span class="o">/</span>Health_Statistics<span class="o">/</span>NCHS<span class="o">/</span>
<span class="k">     global</span> linkage datalinkage<span class="o">/</span>linked_mortality<span class="o">/</span>
<span class="k">	 global</span> nh3 NHANES_III
<span class="k">     global</span> mort _MORT_2019_PUBLIC<span class="m">.</span>dat
<span class="k">     global varlist</span> <span class="cs">///</span>
         seqn <span class="m">1-6</span> <span class="cs">///</span>
         eligstat <span class="m">15</span> <span class="cs">///</span>
	     mortstat <span class="m">16</span> <span class="cs">///</span>
	     ucod_leading <span class="m">17-19</span> <span class="cs">///</span>
         diabetes <span class="m">20</span> <span class="cs">///</span>
	     hyperten <span class="m">21</span> <span class="cs">///</span>
	     permth_int <span class="m">43-45</span> <span class="cs">///</span>
	     permth_exm <span class="m">46-48</span> 
	 
	 <span class="c1">//1988-1994</span>
<span class="k">	 infix</span> <span class="vg">$varlist</span> using <span class="vg">$nchs$linkage$nh3$mort</span>,<span class="k"> clear</span>
<span class="k">	 replace</span> seqn=<span class="o">-</span><span class="m">1</span><span class="o">*</span>seqn
<span class="k">	 tempfile</span> dat0
<span class="k">	 save</span> <span class="nv">`dat0&#39;</span>
     
	 <span class="c1">//1999-2018</span>
<span class="k">     local</span> N=<span class="m">1</span>

<span class="k">     foreach</span> y of<span class="k"> numlist</span> <span class="m">1999</span> <span class="m">2001</span> <span class="m">2003</span> <span class="m">2005</span> <span class="m">2007</span> <span class="m">2009</span> <span class="m">2011</span> <span class="m">2013</span> <span class="m">2015</span> <span class="m">2017</span> {
<span class="k">         local</span> yplus1=<span class="nv">`y&#39;</span> <span class="o">+</span> <span class="m">1</span>  
<span class="k">         	</span>
<span class="k">	     local</span> nhanes NHANES_<span class="nv">`y&#39;</span>_<span class="nv">`yplus1&#39;</span>
<span class="k">         infix</span> <span class="vg">$varlist</span> using <span class="vg">$nchs$linkage</span><span class="nv">`nhanes&#39;</span><span class="vg">$mort</span>,<span class="k"> clear</span>
<span class="k">	     tempfile</span> dat<span class="nv">`N&#39;</span>
<span class="k">	     save</span> <span class="nv">`dat`N&#39;&#39;</span>
<span class="k">	     local</span> N=<span class="nv">`N&#39;</span><span class="o">+</span><span class="m">1</span>
     }
<span class="k">	 </span>
<span class="k">	 use</span> <span class="nv">`dat0&#39;</span>,<span class="k"> clear</span>
<span class="k">     forvalues</span> i=<span class="m">1</span><span class="o">/</span><span class="m">10</span> {
<span class="k">	</span>
<span class="k">	     append</span> using <span class="nv">`dat`i&#39;&#39;</span>
		 
     }
	
	
}


<span class="k">quietly</span> {
	
	 <span class="c1">//2.values</span>
<span class="k">     lab</span> def premiss .z <span class="s">&quot;Missing&quot;</span>
<span class="k">     lab</span> def eligfmt <span class="m">1</span> <span class="s">&quot;Eligible&quot;</span> <span class="m">2</span> <span class="s">&quot;Under age 18, not available for public release&quot;</span> <span class="m">3</span> <span class="s">&quot;Ineligible&quot;</span> 
<span class="k">     lab</span> def mortfmt <span class="m">0</span> <span class="s">&quot;Assumed alive&quot;</span> <span class="m">1</span> <span class="s">&quot;Assumed deceased&quot;</span> .z <span class="s">&quot;Ineligible or under age 18&quot;</span>
<span class="k">     lab</span> def flagfmt <span class="m">0</span> <span class="s">&quot;No - Condition not listed as a multiple cause of death&quot;</span> <span class="cs">///</span>
	                      <span class="m">1</span> <span class="s">&quot;Yes - Condition listed as a multiple cause of death&quot;</span>	<span class="cs">///</span>
						  .z <span class="s">&quot;Assumed alive, under age 18, ineligible for mortality follow-up, or MCOD not available&quot;</span>
<span class="k">     lab</span> def qtrfmt <span class="m">1</span> <span class="s">&quot;January-March&quot;</span> <span class="cs">///</span>
	                     <span class="m">2</span> <span class="s">&quot;April-June&quot;</span> <span class="cs">///</span>
						 <span class="m">3</span> <span class="s">&quot;July-September&quot;</span> <span class="cs">///</span>
						 <span class="m">4</span> <span class="s">&quot;October-December&quot;</span> <span class="cs">///</span>
						 .z <span class="s">&quot;Ineligible, under age 18, or assumed alive&quot;</span>
<span class="k">     lab</span> def dodyfmt .z <span class="s">&quot;Ineligible, under age 18, or assumed alive&quot;</span>
<span class="k">     lab</span> def ucodfmt <span class="m">1</span> <span class="s">&quot;Diseases of heart (I00-I09, I11, I13, I20-I51)&quot;</span>                           
<span class="k">     lab</span> def ucodfmt <span class="m">2</span> <span class="s">&quot;Malignant neoplasms (C00-C97)&quot;</span>                                            , add
<span class="k">     lab</span> def ucodfmt <span class="m">3</span> <span class="s">&quot;Chronic lower respiratory diseases (J40-J47)&quot;</span>                             , add
<span class="k">     lab</span> def ucodfmt <span class="m">4</span> <span class="s">&quot;Accidents (unintentional injuries) (V01-X59, Y85-Y86)&quot;</span>                    , add
<span class="k">     lab</span> def ucodfmt <span class="m">5</span> <span class="s">&quot;Cerebrovascular diseases (I60-I69)&quot;</span>                                       , add
<span class="k">     lab</span> def ucodfmt <span class="m">6</span> <span class="s">&quot;Alzheimer&#39;s disease (G30)&quot;</span>                                                , add
<span class="k">     lab</span> def ucodfmt <span class="m">7</span> <span class="s">&quot;Diabetes mellitus (E10-E14)&quot;</span>                                              , add
<span class="k">     lab</span> def ucodfmt <span class="m">8</span> <span class="s">&quot;Influenza and pneumonia (J09-J18)&quot;</span>                                        , add
<span class="k">     lab</span> def ucodfmt <span class="m">9</span> <span class="s">&quot;Nephritis, nephrotic syndrome and nephrosis (N00-N07, N17-N19, N25-N27)&quot;</span>  , add
<span class="k">     lab</span> def ucodfmt <span class="m">10</span> <span class="s">&quot;All other causes (residual)&quot;</span>                                             , add
<span class="k">     lab</span> def ucodfmt .z <span class="s">&quot;Ineligible, under age 18, assumed alive, or no cause of death data&quot;</span>      , add
<span class="k">	 </span>
<span class="k">	 </span>
<span class="k">	 replace</span> mortstat = .z<span class="k"> if</span> mortstat <span class="o">&gt;=</span>.
<span class="k">     replace</span> ucod_leading = .z<span class="k"> if</span> ucod_leading <span class="o">&gt;=</span>.
<span class="k">     replace</span> diabetes = .z<span class="k"> if</span> diabetes <span class="o">&gt;=</span>.
<span class="k">     replace</span> hyperten = .z<span class="k"> if</span> hyperten <span class="o">&gt;=</span>.
<span class="k">     replace</span> permth_int = .z<span class="k"> if</span> permth_int <span class="o">&gt;=</span>.
<span class="k">     replace</span> permth_exm = .z<span class="k"> if</span> permth_exm <span class="o">&gt;=</span>.
	
}

<span class="k">quietly</span> {
	
	 <span class="c1">//3.define</span>
<span class="k">	 </span>
<span class="k">     label var</span> seqn <span class="s">&quot;NHANES Respondent Sequence Number&quot;</span>
<span class="k">     label var</span> eligstat <span class="s">&quot;Eligibility Status for Mortality Follow-up&quot;</span>
<span class="k">     label var</span> mortstat <span class="s">&quot;Final Mortality Status&quot;</span>
<span class="k">     label var</span> ucod_leading <span class="s">&quot;Underlying Cause of Death: Recode&quot;</span>
<span class="k">     label var</span> diabetes <span class="s">&quot;Diabetes flag from Multiple Cause of Death&quot;</span>
<span class="k">     label var</span> hyperten <span class="s">&quot;Hypertension flag from Multiple Cause of Death&quot;</span>
<span class="k">     label var</span> permth_int <span class="s">&quot;Person-Months of Follow-up from NHANES Interview date&quot;</span>
<span class="k">     label var</span> permth_exm <span class="s">&quot;Person-Months of Follow-up from NHANES Mobile Examination Center (MEC) Date&quot;</span>

<span class="k">     label</span> values eligstat eligfmt
<span class="k">     label</span> values mortstat mortfmt
<span class="k">     label</span> values ucod_leading ucodfmt
<span class="k">     label</span> values diabetes flagfmt
<span class="k">     label</span> values hyperten flagfmt
<span class="k">     label</span> value permth_int premiss
<span class="k">     label</span> value permth_exm premiss

<span class="k">     noi des</span> 
	 
	 <span class="c1">//eligibility</span>
<span class="k">	 drop if</span> <span class="nf">inlist</span>(eligstat,<span class="m">2</span>,<span class="m">3</span>)
<span class="k">	 duplicates drop</span> 

<span class="k">	 keep</span> seqn mortstat permth_int permth_exm 
<span class="k">	 save</span> <span class="s">&quot;11_nhmort</span><span class="vg">$date</span><span class="s">&quot;</span>,<span class="k"> replace</span> 
	 
	 <span class="c1">//big data!</span>
<span class="k">	 noi di</span> <span class="s">&quot;&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;rows x columns:&quot;</span>
<span class="k">	 noi count</span>
<span class="k">	 ds</span> 
<span class="k">	 noi di</span> <span class="nf">wordcount</span>(<span class="nf">r</span>(varlist))
<span class="k">	 </span>
<span class="k">     global</span> finish  = <span class="nf">clock</span>(<span class="nf">c</span>(current_time),<span class="s">&quot;hms&quot;</span>)<span class="o">/</span><span class="m">10</span><span class="o">^</span><span class="m">3</span>
<span class="k">     global</span> duration = <span class="nf">round</span>((<span class="vg">$finish</span> <span class="o">-</span> <span class="vg">$start</span>)<span class="o">/</span><span class="m">60</span>,<span class="m">1</span>)

<span class="k">     noi di</span> <span class="s">&quot;runtime = </span><span class="vg">$duration</span><span class="s"> minute(s)&quot;</span>	 
<span class="k">	 </span>
<span class="k">	 log close</span>
}
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="nhsurv">
<h2>8. nhsurv<a class="headerlink" href="#nhsurv" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span>cls
<span class="k">clear</span>

<span class="c1">*! baseline 08_nhtable.dta</span>
<span class="c1">*! outcome 11_nhmort.dta</span>
<span class="c1">*! km curve 30y mortality</span>

<span class="k">quietly</span> {
<span class="k">	</span>
<span class="k">     capture log close</span>
<span class="k">     global</span> date:<span class="k"> di</span> <span class="nx">%td</span> <span class="nf">date</span>(<span class="nf">c</span>(current_date),<span class="s">&quot;DMY&quot;</span>)
<span class="k">     log</span> using <span class="s">&quot;14_nhsurv</span><span class="vg">$date</span><span class="s">.log&quot;</span>,<span class="k"> replace</span>
<span class="k">     version</span> <span class="m">15</span>

<span class="k">     global</span> start = <span class="nf">clock</span>(<span class="nf">c</span>(current_time),<span class="s">&quot;hms&quot;</span>)<span class="o">/</span><span class="m">10</span><span class="o">^</span><span class="m">3</span>
	 
	 <span class="c1">//0.final eligibility criterion</span>
<span class="k">	 use</span> 08_nhtable<span class="vg">$date</span>,<span class="k"> clear</span>
<span class="k">	 noi merge</span> <span class="m">1</span>:<span class="m">1</span> seqn using 11_nhmort<span class="vg">$date</span>,<span class="k"> keep</span>(matched) nogen
<span class="k">	 gen</span> died=mortstat
<span class="k">	 gen</span> years=permth_exm<span class="o">/</span>(<span class="m">12</span>)
	 
	 <span class="c1">//1.healthy nondonor</span>
<span class="k">	 g</span> healthy=.
<span class="k">	 replace</span> healthy=<span class="m">1</span><span class="k"> if</span> <span class="cs">///</span>
		 <span class="nf">inrange</span>(sbp,<span class="m">0</span>,<span class="m">140</span>) <span class="o">&amp;</span> <span class="cs">/// </span>
		 <span class="nf">inrange</span>(dbp,<span class="m">50</span>,<span class="m">85</span>)  <span class="o">&amp;</span> <span class="cs">/// </span>
		 <span class="nf">inrange</span>(bmi,<span class="m">0</span>,<span class="m">30</span>) <span class="o">&amp;</span> <span class="cs">/// </span>
		 <span class="nf">inrange</span>(egfr,<span class="m">100</span>,<span class="m">160</span>) <span class="o">&amp;</span> <span class="cs">/// </span>
		 <span class="nf">inrange</span>(hba1c,<span class="m">0</span>,<span class="m">7</span>) <span class="o">&amp;</span> <span class="cs">/// </span>
		 <span class="nf">inrange</span>(acr,<span class="m">2</span>,<span class="m">10</span>) <span class="o">&amp;</span> <span class="cs">/// </span>
		 dm<span class="o">==</span><span class="m">0</span> <span class="o">&amp;</span> <span class="cs">///</span>
		 htn<span class="o">==</span><span class="m">0</span> 
<span class="k">		</span>
<span class="k">	 replace</span> healthy=<span class="m">0</span><span class="k"> if</span> <span class="nf">missing</span>(healthy)
<span class="k">	 </span>
<span class="k">	 save</span> <span class="s">&quot;15_nhsurv</span><span class="vg">$date</span><span class="s">&quot;</span>,<span class="k"> replace</span> 
	 
	 
}	 

<span class="k">if</span> <span class="m">13</span> {

	 <span class="c1">//big data!</span>
<span class="k">	 noi di</span> <span class="s">&quot;&quot;</span>
<span class="k">	 noi di</span> <span class="s">&quot;rows x columns:&quot;</span>
<span class="k">	 noi count</span>
<span class="k">	 ds</span> 
<span class="k">	 noi di</span> <span class="nf">wordcount</span>(<span class="nf">r</span>(varlist))
<span class="k">	 </span>
<span class="k">     global</span> finish  = <span class="nf">clock</span>(<span class="nf">c</span>(current_time),<span class="s">&quot;hms&quot;</span>)<span class="o">/</span><span class="m">10</span><span class="o">^</span><span class="m">3</span>
<span class="k">     global</span> duration = <span class="nf">round</span>((<span class="vg">$finish</span> <span class="o">-</span> <span class="vg">$start</span>)<span class="o">/</span><span class="m">60</span>,<span class="m">1</span>)

<span class="k">     noi di</span> <span class="s">&quot;runtime = </span><span class="vg">$duration</span><span class="s"> minute(s)&quot;</span>	
	 	 
}

<span class="k">quietly</span> {
	
	 <span class="c1">//2.just short of median survival</span>
<span class="k">	 stset</span> years, fail(died)
<span class="k">     sts graph</span>, <span class="cs">///</span>
<span class="k">	     by</span>(healthy) <span class="cs">///</span>
         fail per(<span class="m">100</span>) <span class="cs">///</span>
	     ti(<span class="s">&quot;&quot;</span>) yti(<span class="s">&quot;%&quot;</span>,orient(horizontal)) xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
	     ylab(<span class="m">0</span>(<span class="m">10</span>)<span class="m">50</span>, angle(<span class="m">360</span>)<span class="k"> format</span>(<span class="nx">%3.0f</span>)) 
<span class="k">	 graph</span> export morality_nondonor<span class="m">.</span>png,<span class="k"> replace</span> 
<span class="k">	 gen</span> inelig=healthy<span class="o">==</span><span class="m">0</span>
<span class="k">	 noi stcox</span> inelig
<span class="k">     sts list</span>, fail<span class="k"> by</span>(healthy) saving(16_nhkm<span class="vg">$date</span>,<span class="k"> replace</span>)
<span class="k">	 </span>
<span class="k">	 preserve</span>
<span class="k">	      use</span> 16_nhkm<span class="vg">$date</span>,<span class="k"> clear</span>
<span class="k">		  replace</span> failure=failure<span class="o">*</span><span class="m">100</span>
		  
    <span class="c1">//see results of segev/jama/2010		  </span>
<span class="k">	 noi list</span> healthy time failure<span class="k"> if</span> <span class="nf">inrange</span>(time,<span class="m">4.9</span>,<span class="m">5.1</span>)
<span class="k">	 noi list</span> healthy time failure<span class="k"> if</span> <span class="nf">inrange</span>(time,<span class="m">11.9</span>,<span class="m">12.1</span>)
<span class="k">	 restore</span> 
<span class="k">	 noi tab</span> healthy
<span class="k">	 sts graph if</span> healthy<span class="o">==</span><span class="m">1</span>, <span class="cs">///</span>
	       ha<span class="k"> by</span>(healthy) <span class="cs">///</span>
		   ylab(<span class="m">0</span>(.<span class="m">005</span>).<span class="m">02</span>, angle(<span class="m">360</span>)) <span class="cs">///</span>
		   yti(<span class="s">&quot;{&amp;lambda}&quot;</span>, size(<span class="m">6</span>) <span class="cs">///</span>
		        orient(horizontal)) <span class="cs">///</span>
		   xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
		   ti(<span class="s">&quot;Nonparametric&quot;</span>, size(<span class="m">3</span>))
<span class="k">	 graph save</span> nonparm_ha ,<span class="k"> replace</span> 
<span class="k">	 </span>
<span class="k">	 preserve</span> 
<span class="k">	 keep if</span> healthy<span class="o">==</span><span class="m">1</span>
<span class="k">	 drop</span> _st _d _t _t0 healthy inelig
<span class="k">	 save</span> nh_nondonors<span class="vg">$date</span>,<span class="k"> replace</span> <span class="c1">//for donor vs nondonor analysis</span>
<span class="k">	 restore</span>
	 
}

<span class="k">quietly</span> {
<span class="k">	</span>
<span class="k">	 if</span> <span class="m">0</span> {
<span class="k">	 	</span>
<span class="k">	 </span>
<span class="k">	</span>
<span class="k">	 noi streg if</span> healthy<span class="o">==</span><span class="m">1</span>,<span class="k"> d</span>(weibull) <span class="c1">//beta = .0012, lambda=1.6, sigma=.6</span>
<span class="k">	 noi streg if</span> healthy<span class="o">==</span><span class="m">1</span>,<span class="k"> d</span>(ggamma)
<span class="k">	 predict</span> f_gg, ha
<span class="k">	 matrix list e</span>(b)
<span class="k">	 matrix</span> define b=<span class="nf">e</span>(b)
<span class="k">	 local</span> beta:<span class="k"> di</span> <span class="nx">%2.1f</span> b[<span class="m">1</span>,<span class="m">1</span>]
<span class="k">	 local</span> lambda:<span class="k"> di</span> <span class="nx">%2.1f</span> b[<span class="m">1</span>,<span class="m">3</span>]
<span class="k">	 local</span> sigma:<span class="k"> di</span> <span class="nx">%2.1f</span> <span class="nf">exp</span>(b[<span class="m">1</span>,<span class="m">2</span>])
<span class="k">	 line</span> f_gg _t, <span class="cs">///</span>
<span class="k">	      sort</span> <span class="cs">///</span>
		   ylab(<span class="m">0</span>(.<span class="m">005</span>).<span class="m">02</span>, angle(<span class="m">360</span>)) <span class="cs">///</span>
		   yti(<span class="s">&quot; &quot;</span>, <span class="cs">///</span>
		        orient(horizontal)) <span class="cs">///</span>
		   xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
		   ti(<span class="s">&quot;{&amp;beta}{subscript:gg} = </span><span class="nv">`beta&#39;</span><span class="s">, {&amp;lambda}{subscript:gg} = </span><span class="nv">`lambda&#39;</span><span class="s">, {&amp;sigma}{subscript:gg} = </span><span class="nv">`sigma&#39;</span><span class="s"> &quot;</span>, size(<span class="m">3</span>))	 
<span class="k">	 graph save</span> parm_ha,<span class="k"> replace</span> 
<span class="k">	 graph</span> combine nonparm_ha<span class="m">.</span>gph parm_ha<span class="m">.</span>gph, ycommon
<span class="k">	 graph</span> export parmnonparm_ha<span class="m">.</span>png,<span class="k"> replace</span> 
<span class="k">	 matrix</span> ggpars=<span class="nf">r</span>(table)
	 
	 <span class="c1">//slope:  di (.015-.003)/(27-0) = .00044</span>
	 <span class="c1">//dL/dt = .00044; L = .00044t + 0.001</span>
<span class="k">	 preserve</span>
<span class="k">	     clear</span>
<span class="k">	     set</span> obs <span class="m">1000</span>
<span class="k">	     g</span> t=_n<span class="o">*</span><span class="m">30</span><span class="o">/</span><span class="m">1000</span>
<span class="k">	     g</span> L=.<span class="m">00045</span><span class="o">*</span>t <span class="o">+</span> <span class="m">0.003</span> <span class="c1">//from slope of non-parametric ha</span>
		    <span class="c1">//.003/12 gives the perioperative mortality!!!</span>
<span class="k">	     line</span> L t, <span class="cs">///</span>
		   ylab(<span class="m">0</span>(.<span class="m">005</span>).<span class="m">02</span>, angle(<span class="m">360</span>)) <span class="cs">///</span>
		   yti(<span class="s">&quot; &quot;</span>, <span class="cs">///</span>
		        orient(horizontal)) <span class="cs">///</span>
		   xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
		   ti(<span class="s">&quot;{&amp;lambda}{subscript:nonparm} ~ .00044t + .003&quot;</span>, size(<span class="m">3</span>))	
<span class="k">	     graph save</span> L<span class="m">.</span>gph,<span class="k"> replace</span> 
<span class="k">	     graph</span> combine nonparm_ha<span class="m">.</span>gph <span class="cs">///</span>
		       parm_ha<span class="m">.</span>gph <span class="cs">///</span>
			   L<span class="m">.</span>gph, ycommon row(<span class="m">1</span>)
<span class="k">		 graph</span> export lambda<span class="m">.</span>png,<span class="k"> replace</span> 
		 <span class="c1">//consistent with &quot;di (1/1000)*(3/12)&quot; perioperative mortality </span>
		 <span class="c1">//consistent: https://www.cdc.gov/nchs/fastats/deaths.htm</span>
	     <span class="c1">//1 death per 100 population; or hazard of .01 per person</span>
	      <span class="c1">//3.5m deaths/350m population </span>
<span class="k">	 restore</span> 
<span class="k">	 </span>
<span class="k">	 	 preserve</span> 	 
		 <span class="c1">//https://en.wikipedia.org/wiki/GompertzMakeham_law_of_mortality</span>
<span class="k">		 clear</span>
<span class="k">	     set</span> obs <span class="m">1000</span>
<span class="k">	     g</span> t=_n<span class="o">*</span><span class="m">100</span><span class="o">/</span><span class="m">1000</span>
<span class="k">		 g</span> b=.<span class="m">085</span>
<span class="k">		 g</span> a=<span class="m">1</span>
<span class="k">		 g</span> A=<span class="o">-</span><span class="m">1</span>
<span class="k">		 g l</span>=<span class="m">1</span>
<span class="k">		 g h</span>=a<span class="o">*</span><span class="nf">exp</span>(b<span class="o">*</span>t)<span class="o">+</span>l 
<span class="k">		 g</span> H=(A<span class="o">*</span><span class="nf">exp</span>(b<span class="o">*</span>t)<span class="o">+</span>l)<span class="o">+</span><span class="m">5000</span>

<span class="k">		 line h</span> H t 
<span class="k">		 restore</span> 
		 
	 }
		 	 
}	 	 


<span class="k">if</span> <span class="m">0</span> {
	
     <span class="c1">//3.table1 user input</span>
<span class="k">	 </span>
<span class="k">     global</span> title:<span class="k"> di</span> <span class="cs">///</span>
	    <span class="s">&quot;Table 1 Demographic and health characteristics of NHANES participants&quot;</span>
<span class="k">     global</span> excelfile:<span class="k"> di</span> <span class="s">&quot;Table1_Nondonors&quot;</span>
<span class="k">     global</span> byvar healthy 
<span class="k">     global</span> contvars age sbp dbp creat egfr bmi hba1c acr logacr glucose income  
<span class="k">     global</span> binaryvars female dm htn smk  
<span class="k">     global</span> multivars race race2 educ year  
<span class="k">     global</span> footnotes1 Age SBP DBP CREAT eGFR BMI HBA1c uACR LoguACR Glucose Income 
<span class="k">     global</span> footnotes2 Female Diabetes Hypertension Smoke
<span class="k">     global</span> footnotes3 Race Race2 Education Cohort  	
	 

}

<span class="k">	 </span>
<span class="k">if</span> <span class="m">0</span> {
	
     <span class="c1">//command</span>
<span class="k">     which</span> table1_options
     table1_options, <span class="cs">///           </span>
	 title(<span class="s">&quot;</span><span class="vg">$title</span><span class="s">&quot;</span>) <span class="cs">/// by($byvar) </span><span class="c1">///</span>
		 cont(<span class="vg">$contvars</span>) <span class="cs">///</span>
		 binary(<span class="vg">$binaryvars</span>) <span class="cs">///</span>
		 multi(<span class="vg">$multivars</span>)  <span class="cs">///</span>
		 foot(<span class="s">&quot;</span><span class="vg">$footnotes1</span><span class="s"> </span><span class="vg">$footnotes2</span><span class="s"> </span><span class="vg">$footnotes3</span><span class="s">&quot;</span>) <span class="cs">///</span>
		 excel(<span class="s">&quot;</span><span class="vg">$excelfile</span><span class="s">&quot;</span>) 
<span class="k">		 </span>
<span class="k">	 clear</span>
<span class="k">	 svmat</span> ggpars
<span class="k">	 save</span> 17_ggpars,<span class="k"> replace</span> 
 
}

<span class="k">	 log close</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="table1">
<h2>9. table1<a class="headerlink" href="#table1" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span>cls 

<span class="c1">* requires Tasks/006_Ado_Files/table_options.ado, ind_translator.ado </span>
<span class="c1">* adapted from Tasks/003_NHANES/13_nhsurv_4trc.do</span>
<span class="c1">* copied lines 169-204</span>
<span class="c1">* edited  line 169, 188</span>
<span class="c1">* deleted lines 200-202</span>
<span class="c1">* added lines 16-19 below </span>
<span class="c1">* these create log file, import dataset</span>
<span class="c1">* outputs file called Table1_Nondonors.xlsx</span>
<span class="c1">* you may edit output file name at line 27</span>


<span class="k">if</span> <span class="m">1</span> {
<span class="k">	</span>
<span class="k">     capture log close</span>
<span class="k">     global</span> date:<span class="k"> di</span> <span class="nx">%td</span> <span class="nf">date</span>(<span class="nf">c</span>(current_date),<span class="s">&quot;DMY&quot;</span>)
<span class="k">     log</span> using <span class="s">&quot;02_nhtable1</span><span class="vg">$date</span><span class="s">.log&quot;</span>,<span class="k"> replace</span>
<span class="k">     use</span> 15_nhsurv30jan2023

	
     <span class="c1">//3.table1 user input</span>
<span class="k">	 </span>
<span class="k">     global</span> title:<span class="k"> di</span> <span class="cs">///</span>
	    <span class="s">&quot;Table 1 Demographic and health characteristics of NHANES participants&quot;</span>
<span class="k">     global</span> excelfile:<span class="k"> di</span> <span class="s">&quot;Table1_Nondonors&quot;</span>
<span class="k">     global</span> byvar healthy 
<span class="k">     global</span> contvars age sbp dbp creat egfr bmi hba1c acr logacr glucose income  
<span class="k">     global</span> binaryvars female dm htn smk  
<span class="k">     global</span> multivars race race2 educ year  
<span class="k">     global</span> footnotes1 Age SBP DBP CREAT eGFR BMI HBA1c uACR LoguACR Glucose Income 
<span class="k">     global</span> footnotes2 Female Diabetes Hypertension Smoke
<span class="k">     global</span> footnotes3 Race Race2 Education Cohort  	
	 

}

<span class="k">	 </span>
<span class="k">if</span> <span class="m">2</span> {
	
     <span class="c1">//command</span>
<span class="k">     which</span> table1_options
     table1_options, <span class="cs">///           </span>
	 title(<span class="s">&quot;</span><span class="vg">$title</span><span class="s">&quot;</span>) <span class="cs">/// </span>
<span class="k">	     by</span>(<span class="vg">$byvar</span>) <span class="cs">///</span>
		 cont(<span class="vg">$contvars</span>) <span class="cs">///</span>
		 binary(<span class="vg">$binaryvars</span>) <span class="cs">///</span>
		 multi(<span class="vg">$multivars</span>)  <span class="cs">///</span>
		 foot(<span class="s">&quot;</span><span class="vg">$footnotes1</span><span class="s"> </span><span class="vg">$footnotes2</span><span class="s"> </span><span class="vg">$footnotes3</span><span class="s">&quot;</span>) <span class="cs">///</span>
		 excel(<span class="s">&quot;</span><span class="vg">$excelfile</span><span class="s">&quot;</span>) 

 
}

<span class="k">	 log close</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="kaplan-meier">
<h2>10. kaplan-meier<a class="headerlink" href="#kaplan-meier" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span>cls

<span class="c1">*! adapted from Tasks/003_NHANES/13_nhsurv_4trc.do</span>
<span class="c1">*! copied &amp; pasted lines 61-66</span>
<span class="c1">*! then added lines 10-14 below</span>

<span class="k">quietly</span> {
	
	 <span class="c1">//settings</span>
<span class="k">     capture log close</span>
<span class="k">     global</span> date:<span class="k"> di</span> <span class="nx">%td</span> <span class="nf">date</span>(<span class="nf">c</span>(current_date),<span class="s">&quot;DMY&quot;</span>)
<span class="k">     log</span> using <span class="s">&quot;02_survival_analysis_</span><span class="vg">$date</span><span class="s">.log&quot;</span>,<span class="k"> replace</span>
<span class="k">	 use</span> 15_nhsurv30jan2023,<span class="k"> clear</span>
<span class="k">     version</span> <span class="m">15</span>
	 
	 
	 <span class="c1">//exploration</span>
<span class="k">	 noi tab</span> healthy
<span class="k">	 sort</span> healthy 
<span class="k">	 noi list</span> years died healthy<span class="k"> in</span> <span class="m">60210</span><span class="o">/</span><span class="m">60218</span>
		 
	 <span class="c1">//analysis</span>
<span class="k">	 stset</span> years, fail(died)
<span class="k">     sts graph</span>, <span class="cs">///</span>
<span class="k">	 by</span>(healthy) <span class="cs">///</span>
     fail per(<span class="m">100</span>) <span class="cs">///</span>
	 ti(<span class="s">&quot;&quot;</span>) yti(<span class="s">&quot;%&quot;</span>,orient(horizontal)) xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
	 ylab(<span class="m">0</span>(<span class="m">10</span>)<span class="m">50</span>, angle(<span class="m">360</span>)<span class="k"> format</span>(<span class="nx">%3.0f</span>)) 
<span class="k"> </span>
<span class="k">	 log close</span> 
}
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="r">
<h2>11. r<a class="headerlink" href="#r" title="Permalink to this heading">#</a></h2>
<section id="intro">
<h3>11.1 Intro<a class="headerlink" href="#intro" title="Permalink to this heading">#</a></h3>
<p>Survival Analysis in R<br />
For TRC<br />
01/31/22</p>
</section>
<section id="methods">
<h3>11.2 Methods<a class="headerlink" href="#methods" title="Permalink to this heading">#</a></h3>
<p>Data Source:<br />
Tasks/003_NHANES/13_nhsurv_4trc.do<br />
Outputs 15_nhsurv30jan2023.dta</p>
</section>
<section id="packages">
<h3>11.3 Packages<a class="headerlink" href="#packages" title="Permalink to this heading">#</a></h3>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># good practice to start clean</span>
<span class="c1"># install.packages(&quot;haven)</span>
<span class="c1"># install.packages(&quot;survival&quot;)</span>

<span class="nf">rm</span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ls</span><span class="p">())</span><span class="w"> </span>
<span class="nf">library</span><span class="p">(</span><span class="n">haven</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">survival</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="surv">
<h3>11.4 Surv<a class="headerlink" href="#surv" title="Permalink to this heading">#</a></h3>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># requires library(haven)</span>
<span class="n">dat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">read_dta</span><span class="p">(</span><span class="s">&quot;15_nhsurv30jan2023.dta&quot;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

<span class="c1"># head(dat)</span>

<span class="c1"># View(dat)</span>

<span class="c1"># requires library(survival)</span>
<span class="nf">attach</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
<span class="n">dat1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">cbind</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">died</span><span class="p">)</span>
<span class="n">dat1</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,]</span>
<span class="n">mysurv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">Surv</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="w"> </span><span class="n">died</span><span class="p">)</span>
<span class="n">mysurv</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">,]</span>
</pre></div>
</div>
</section>
<section id="results">
<h3>11.5 Results<a class="headerlink" href="#results" title="Permalink to this heading">#</a></h3>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># overall K-M</span>
<span class="c1"># K-M by group  </span>

<span class="n">myKM1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">survfit</span><span class="p">(</span><span class="n">mysurv</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">healthy</span><span class="p">)</span>

<span class="c1"># myKM1  </span>
<span class="n">myKM1sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="n">myKM1</span><span class="p">)</span>

<span class="c1">#myKM1sum</span>

<span class="nf">plot</span><span class="p">(</span><span class="n">myKM1</span><span class="p">,</span><span class="w"> </span>
<span class="w">     </span><span class="n">main</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;Kaplan-Meier estimate with 95% confidence bounds&quot;</span><span class="p">),</span><span class="w"> </span>
<span class="w">     </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;event&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;years&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Survival function&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="c1"># plot with axes and title</span>
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cox PHM</span>
<span class="c1"># data attached so no need to state</span>

<span class="n">myfit1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">coxph</span><span class="p">(</span><span class="n">mysurv</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">healthy</span><span class="p">,</span>
<span class="w">         </span><span class="n">ties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;breslow&quot;</span><span class="p">)</span><span class="w"> </span>
<span class="nf">summary</span><span class="p">(</span><span class="n">myfit1</span><span class="p">)</span>
<span class="nf">confint</span><span class="p">(</span><span class="n">myfit1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="conclusion">
<h3>11.6 Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading">#</a></h3>
<p>Survival Analysis in R<br />
Just as easy as in Stata<br />
Very similar output</p>
</section>
</section>
<hr class="docutils" />
<section id="table1-options">
<h2>12. table1_options<a class="headerlink" href="#table1-options" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="c1">*! inspired by 340.600.71 </span>
<span class="c1">*! by Zhenghao(Vincent) Jin &amp; Abi Muzaale</span>
<span class="c1">*! July 5, 2022 </span>
<span class="c1">*! version 3.01</span>
<span class="c1">*! fixed rounding issue for non-by table</span>
<span class="c1">*! a space added to between median and IQR for cont vars</span>

<span class="k">capture program drop</span> table1_options
<span class="k">program</span> define table1_options
<span class="k">     syntax</span> [if],  title(string) <span class="cs">///  </span>
	              [cont(varlist)] <span class="cs">///  </span>
			      [binary(varlist)]  <span class="cs">/// </span>
			      [multi(varlist)] <span class="cs">/// </span>
				  [foot(string)] <span class="cs">///  </span>
				  [by(varname)] <span class="cs">///</span>
				  [excel(string)]
<span class="k">				  </span>
<span class="k">	quietly</span> {
		
		<span class="c1">// sreen if if syntax is called</span>
<span class="k">		if</span> <span class="s">&quot;</span><span class="nv">`if&#39;</span><span class="s">&quot;</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> {
<span class="k">			local</span> if_helper = <span class="nf">substr</span>(<span class="s">&quot;</span><span class="nv">`if&#39;</span><span class="s">&quot;</span>, <span class="m">3</span>, .)
<span class="k">			local</span> if_helper :<span class="k"> di</span> <span class="s">&quot;&amp; &quot;</span> <span class="s">&quot;</span><span class="nv">`if_helper&#39;</span><span class="s">&quot;</span>
		}
		
		<span class="c1">// screen if excel option got called</span>
<span class="k">		if</span> <span class="s">&quot;</span><span class="nv">`excel&#39;</span><span class="s">&quot;</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> {
<span class="k">			local</span> excel_name :<span class="k"> di</span> <span class="s">&quot;table1_option_output&quot;</span>
		}
<span class="k">		else</span> {
<span class="k">			local</span> excel_name :<span class="k"> di</span> <span class="s">&quot;</span><span class="nv">`excel&#39;</span><span class="s">&quot;</span>
		}
		
		<span class="c1">// generate an excel file</span>
		putexcel<span class="k"> set</span> <span class="nv">`excel_name&#39;</span>,<span class="k"> replace</span>
<span class="k">		local</span> alphabet <span class="s">&quot;</span><span class="nv">`c(ALPHA)&#39;</span><span class="s">&quot;</span>
<span class="k">		tokenize</span> <span class="nv">`alphabet&#39;</span>
<span class="k">		if</span> <span class="s">&quot;</span><span class="nv">`by&#39;</span><span class="s">&quot;</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> {		 
			
			<span class="c1">// generate row and col indicator in excel</span>
<span class="k">			local</span> excel_row_c = <span class="m">1</span>
<span class="k">			local</span> excel_col_c = <span class="m">1</span>
			
			<span class="c1">//columns</span>
<span class="k">			local</span> col1:<span class="k"> di</span> <span class="s">&quot;_col(40)&quot;</span>
<span class="k">			capture local</span> col2:<span class="k"> di</span> <span class="s">&quot;_col(50)&quot;</span>
			
			<span class="c1">//title string</span>
<span class="k">			noisily di</span> <span class="s">&quot;</span><span class="nv">`title&#39;</span><span class="s">&quot;</span>
			ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
			putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`title&#39;</span><span class="s">&quot;</span>
<span class="k">			 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span>
<span class="k">			 count</span> <span class="nv">`if&#39;</span>
<span class="k">			 local</span> total_N=<span class="nf">r</span>(N)
<span class="k">			 di</span> <span class="nv">`col1&#39;</span> <span class="s">&quot;N=</span><span class="nv">`total_N&#39;</span><span class="s">&quot;</span>
<span class="k">			 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
			 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
			 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;N=</span><span class="nv">`total_N&#39;</span><span class="s">&quot;</span>
<span class="k">			 </span>
<span class="k">			 foreach</span> v of<span class="k"> varlist</span> <span class="nv">`cont&#39;</span> {
<span class="k">				 quietly sum</span> <span class="nv">`v&#39;</span> <span class="nv">`if&#39;</span>, detail
<span class="k">				 local</span> row_lab_c: variable<span class="k"> label</span> <span class="nv">`v&#39;</span>
<span class="k">				 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">				 local</span> excel_col_c = <span class="m">1</span>
				 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
				 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`row_lab_c&#39;</span><span class="s">&quot;</span>
<span class="k">				 local</span> D <span class="nx">%2.0f</span>
<span class="k">				 local</span> med_iqr_c:<span class="k"> di</span> <span class="cs">///</span>
									 <span class="nv">`D&#39;</span> <span class="nv">`col1&#39;</span> <span class="nf">r</span>(p50) <span class="s">&quot; [&quot;</span> <span class="cs">///</span>
									 <span class="nv">`D&#39;</span> <span class="nf">r</span>(p25) <span class="s">&quot;,&quot;</span> <span class="cs">///</span>
									 <span class="nv">`D&#39;</span> <span class="nf">r</span>(p75) <span class="s">&quot;]&quot;</span>
<span class="k">				 local</span> med_iqr_c2:<span class="k"> di</span> <span class="cs">///</span>
									 <span class="nv">`D&#39;</span> <span class="nf">r</span>(p50) <span class="s">&quot; [&quot;</span> <span class="cs">///</span>
									 <span class="nv">`D&#39;</span> <span class="nf">r</span>(p25) <span class="s">&quot;,&quot;</span> <span class="cs">///</span>
									 <span class="nv">`D&#39;</span> <span class="nf">r</span>(p75) <span class="s">&quot;]&quot;</span>
<span class="k">				 local</span> row_c:<span class="k"> di</span> <span class="s">&quot;</span><span class="nv">`row_lab_c&#39;</span><span class="s"> </span><span class="nv">`med_iqr_c&#39;</span><span class="s">&quot;</span>
<span class="k">				 local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
				 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
				 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`med_iqr_c2&#39;</span><span class="s">&quot;</span>
				 
				 <span class="c1">//continuous varlist</span>
<span class="k">				 noisily di</span> <span class="s">&quot;</span><span class="nv">`row_c&#39;</span><span class="s">&quot;</span>
			 }
<span class="k">			 </span>
<span class="k">			 foreach</span> v of<span class="k"> varlist</span> <span class="nv">`binary&#39;</span> {
<span class="k">				 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">				 local</span> excel_col_c = <span class="m">1</span>
				 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
<span class="k">				 quietly sum</span> <span class="nv">`v&#39;</span> <span class="nv">`if&#39;</span>, detail
<span class="k">				 local</span> row_lab_b: variable<span class="k"> label</span> <span class="nv">`v&#39;</span>
				 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`row_lab_b&#39;</span><span class="s">&quot;</span>
<span class="k">				 local</span> D <span class="nx">%2.0f</span>
<span class="k">				 local</span> percent:<span class="k"> di</span> <span class="nv">`D&#39;</span> <span class="nv">`col1&#39;</span> <span class="nf">r</span>(mean)<span class="o">*</span><span class="m">100</span> 
<span class="k">				 local</span> percent2:<span class="k"> di</span> <span class="nv">`D&#39;</span> <span class="nf">r</span>(mean)<span class="o">*</span><span class="m">100</span>
<span class="k">				 local</span> row_b:<span class="k"> di</span> <span class="s">&quot;</span><span class="nv">`row_lab_b&#39;</span><span class="s"> </span><span class="nv">`percent&#39;</span><span class="s">&quot;</span>
<span class="k">				 local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
				 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
				 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`percent2&#39;</span><span class="s">&quot;</span>
				 <span class="c1">//binary varlist</span>
<span class="k">				 noisily di</span> <span class="s">&quot;</span><span class="nv">`row_b&#39;</span><span class="s">&quot;</span>
			 }
<span class="k">			 </span>
<span class="k">				foreach</span> v of<span class="k"> varlist</span> <span class="nv">`multi&#39;</span> { 
<span class="k">					 local</span> row_var_lab: variable<span class="k"> label</span> <span class="nv">`v&#39;</span>
<span class="k">					 local</span> row_lab_m: value<span class="k"> label</span> <span class="nv">`v&#39;</span>
					 
					 <span class="c1">// count without missing</span>
<span class="k">					 quietly count if</span> <span class="o">!</span><span class="nf">missing</span>(<span class="nv">`v&#39;</span>) <span class="nv">`if_helper&#39;</span>
<span class="k">					 local total</span> = <span class="nf">r</span>(N)
<span class="k">					 </span>
<span class="k">					 quietly levelsof</span> <span class="nv">`v&#39;</span> <span class="nv">`if&#39;</span>,<span class="k"> local</span>(levels)
					 
					 <span class="c1">// putexcel the variable name</span>
<span class="k">					 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">					 local</span> excel_col_c = <span class="m">1</span>
				  	 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
					 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`row_var_lab&#39;</span><span class="s">&quot;</span>
					 
					 <span class="c1">//multinomial varlist</span>
<span class="k">					 noisily di</span> <span class="s">&quot;</span><span class="nv">`row_var_lab&#39;</span><span class="s">&quot;</span>
<span class="k">					 </span>
<span class="k">					 local</span> nlevels=<span class="nf">r</span>(r)
<span class="k">					 </span>
<span class="k">					 forvalues l</span>=<span class="m">1</span><span class="o">/</span><span class="nv">`nlevels&#39;</span> {
<span class="k">						 local</span> excel_col_c = <span class="m">1</span>
<span class="k">						 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">						 capture local levels</span>:<span class="k"> label</span> <span class="nv">`row_lab_m&#39;</span> <span class="nv">`l&#39;</span>
						 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
						 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;     </span><span class="nv">`levels&#39;</span><span class="s">&quot;</span>
<span class="k">						 local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">						 quietly count if</span> <span class="nv">`v&#39;</span><span class="o">==</span><span class="nv">`l&#39;</span> <span class="nv">`if_helper&#39;</span>
<span class="k">						 local</span> num=<span class="nf">r</span>(N)
<span class="k">						 local</span> percent_v:<span class="k"> di</span> <span class="nv">`D&#39;</span> <span class="nv">`col1&#39;</span> <span class="nv">`num&#39;</span><span class="o">*</span><span class="m">100</span><span class="o">/</span><span class="nv">`total&#39;</span>
<span class="k">						 local</span> percent_v2:<span class="k"> di</span> <span class="nv">`D&#39;</span> <span class="nv">`num&#39;</span><span class="o">*</span><span class="m">100</span><span class="o">/</span><span class="nv">`total&#39;</span>
						 
						 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
						 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`percent_v2&#39;</span><span class="s">&quot;</span>
<span class="k">					 noisily di</span> <span class="s">&quot;     </span><span class="nv">`levels&#39;</span><span class="s"> </span><span class="nv">`percent_v&#39;</span><span class="s">&quot;</span>	
<span class="k">						 local l</span>=<span class="nv">`l&#39;</span><span class="o">+</span><span class="m">1</span>
						 
					 }
			 
			}
<span class="k">			</span>

<span class="k">			local</span>  oldvarname:<span class="k"> di</span> <span class="s">&quot;</span><span class="nv">`cont&#39;</span><span class="s"> </span><span class="nv">`binary&#39;</span><span class="s"> </span><span class="nv">`multi&#39;</span><span class="s">&quot;</span>
<span class="k">			preserve</span>
<span class="k">			rename</span> (<span class="nv">`oldvarname&#39;</span>)(<span class="nv">`foot&#39;</span>)
<span class="k">			local</span> missvar <span class="s">&quot;</span><span class="nv">`foot&#39;</span><span class="s">&quot;</span>
<span class="k">			di</span> <span class="s">&quot;&quot;</span>
<span class="k">			foreach</span> v of<span class="k"> varlist</span> <span class="nv">`missvar&#39;</span> {
<span class="k">				 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">				 local</span> excel_col_c = <span class="m">1</span>

<span class="k">				 quietly count</span> <span class="nv">`if&#39;</span>
<span class="k">				 local</span> denom=<span class="nf">r</span>(N)
<span class="k">				 quietly count if</span> <span class="nf">missing</span>(<span class="nv">`v&#39;</span>) <span class="nv">`if_helper&#39;</span>
<span class="k">				 local</span> vlab: variable<span class="k"> label</span> <span class="nv">`v&#39;</span>
<span class="k">				 local</span> num=<span class="nf">r</span>(N) 
<span class="k">				 local</span> missing=<span class="nv">`num&#39;</span><span class="o">*</span><span class="m">100</span><span class="o">/</span><span class="nv">`denom&#39;</span>
<span class="k">				 local</span> missingness:<span class="k"> di</span> _col(<span class="m">25</span>) <span class="nx">%2.1f</span> <span class="nv">`missing&#39;</span>
<span class="k">				 local</span> missing2 :<span class="k"> di</span> <span class="nx">%2.1f</span> <span class="nv">`missing&#39;</span>
<span class="k">				 noisily di</span> <span class="s">&quot;</span><span class="nv">`v&#39;</span><span class="s">:  </span><span class="nv">`missingness&#39;</span><span class="s">% missing&quot;</span>
				 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
				 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`v&#39;</span><span class="s">: </span><span class="nv">`missing2&#39;</span><span class="s">% missing&quot;</span>
			}
<span class="k">			noisily di</span> <span class="s">&quot;</span><span class="nv">`if&#39;</span><span class="s">&quot;</span>
<span class="k">			local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">			local</span> excel_col_c = <span class="m">1</span>
			ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
			putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`if&#39;</span><span class="s">&quot;</span>
<span class="k">			restore</span>
		} 
<span class="k">		else</span> {
			
			<span class="c1">// generate a screener to see if user inputted a by varaible in table 1</span>
			<span class="c1">// this will not influence the table but will influence the footnote missing value section</span>
<span class="k">			local</span> dual_screener = <span class="m">0</span>
<span class="k">			local</span> var_screener <span class="nv">`cont&#39;</span> <span class="nv">`binary&#39;</span> <span class="nv">`multi&#39;</span>
<span class="k">			foreach var in</span> <span class="nv">`var_screener&#39;</span> {
<span class="k">				if</span> <span class="s">&quot;</span><span class="nv">`by&#39;</span><span class="s">&quot;</span> <span class="o">==</span> <span class="s">&quot;</span><span class="nv">`var&#39;</span><span class="s">&quot;</span>{
<span class="k">					local</span> dual_screener = <span class="m">1</span>
				}
			}
<span class="k">			if</span> <span class="nv">`dual_screener&#39;</span> <span class="o">==</span> <span class="m">1</span> {
<span class="k">				noisily di</span> <span class="s">&quot;Wrong Input: The stratifying variable should not be inputted as table 1 variable&quot;</span>
			} 
<span class="k">			else</span> {
				
				<span class="c1">// generate row and col indicator in excel</span>
<span class="k">				local</span> excel_row_c = <span class="m">1</span>
<span class="k">				local</span> excel_col_c = <span class="m">1</span>
				
				<span class="c1">// first detect how many categories the variable has</span>
<span class="k">				levelsof</span>(<span class="nv">`by&#39;</span>)
				<span class="c1">// save values to a macro</span>
<span class="k">				local</span> by_var_val = <span class="nf">r</span>(levels)
				<span class="cm">/*</span>
<span class="cm">				// count how many values the variable has</span>
<span class="cm">				local val_count = 0</span>
<span class="cm">				foreach count in `by_var_val&#39; {</span>
<span class="cm">					val_count = `val_count&#39; + 1</span>
<span class="cm">				}</span>
<span class="cm">				*/</span>
				<span class="c1">// prepare a spacing factor to separate columns</span>
<span class="k">				local</span> col_fac = <span class="m">20</span>
				<span class="c1">// prepare a spacing parameter for actual separation</span>
				<span class="c1">// and the default should be 40 for the first column</span>
<span class="k">				local</span> col_sep = <span class="m">40</span>
				<span class="c1">// prepare for column heading</span>
<span class="k">				local</span> col_lab_m: value<span class="k"> label</span> <span class="nv">`by&#39;</span>
				<span class="c1">// display first line</span>
<span class="k">				noisily di</span> <span class="s">&quot;</span><span class="nv">`title&#39;</span><span class="s">&quot;</span>
				
				<span class="c1">// put the title line into excel</span>
				ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
				putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`title&#39;</span><span class="s">&quot;</span>
				
				<span class="c1">// di second line (the column heading)</span>
<span class="k">				local</span> col_header_count = <span class="m">0</span>
				<span class="c1">// for second line, add excel row count for 1</span>
<span class="k">				local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">				foreach</span> col_h<span class="k"> in</span> <span class="nv">`by_var_val&#39;</span> {
					<span class="c1">// calculate appropriate identation for each column header</span>
					<span class="c1">// an identation is calculated based on basic identation for second column + identation factor per column * column number of each heading</span>
<span class="k">					local</span> col_sep_temp = <span class="nv">`col_sep&#39;</span> <span class="o">+</span> <span class="nv">`col_header_count&#39;</span> <span class="o">*</span> <span class="nv">`col_fac&#39;</span>
					<span class="c1">// adjust for the excel column counts to make sure it gets inputted to correct place</span>
<span class="k">					local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">					local</span> col_s <span class="s">&quot;_col(</span><span class="nv">`col_sep_temp&#39;</span><span class="s">)&quot;</span>
					ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
<span class="k">					capture local</span> col_level :<span class="k"> label</span> <span class="nv">`col_lab_m&#39;</span> <span class="nv">`col_h&#39;</span>
<span class="k">					noisily di</span> <span class="nv">`col_s&#39;</span> <span class="s">&quot;</span><span class="nv">`col_level&#39;</span><span class="s">&quot;</span> _continue
					<span class="c1">// output to excel cells</span>
					putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`col_level&#39;</span><span class="s">&quot;</span>
					<span class="c1">// correctly counting for the header numbers</span>
<span class="k">					local</span> col_header_count = <span class="nv">`col_header_count&#39;</span> <span class="o">+</span> <span class="m">1</span>
				}
				<span class="c1">// use this to stop _continue</span>
<span class="k">				noisily di</span> <span class="s">&quot;&quot;</span>
				
				<span class="c1">// reset col_header_count</span>
<span class="k">				local</span> col_header_count = <span class="m">0</span>
				<span class="c1">// reset excel_col_c to 1 so that new lines can be inputted to first cell of each lines</span>
<span class="k">				local</span> excel_col_c = <span class="m">1</span>
				
				<span class="c1">// the third line (N=xxx)</span>
				<span class="c1">// first set the excel row count to correct numbers</span>
<span class="k">				local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">				foreach</span> col_h<span class="k"> in</span> <span class="nv">`by_var_val&#39;</span> {
					<span class="c1">// calculate correct identation</span>
<span class="k">					local</span> col_sep_temp = <span class="nv">`col_sep&#39;</span> <span class="o">+</span> <span class="nv">`col_header_count&#39;</span> <span class="o">*</span> <span class="nv">`col_fac&#39;</span>
<span class="k">					local</span> col_s <span class="s">&quot;_col(</span><span class="nv">`col_sep_temp&#39;</span><span class="s">)&quot;</span>
					<span class="c1">// adjust for the excel column counts to make sure it gets inputted to correct place</span>
<span class="k">					local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">					count if</span> <span class="nv">`by&#39;</span> <span class="o">==</span> <span class="nv">`col_h&#39;</span> <span class="nv">`if_helper&#39;</span>
<span class="k">					local</span> col_count = <span class="nf">r</span>(N)
<span class="k">					noisily di</span> <span class="nv">`col_s&#39;</span> <span class="s">&quot;N=</span><span class="nv">`col_count&#39;</span><span class="s">&quot;</span> _continue
					<span class="c1">// output to excel cells</span>
					ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
					putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;N=</span><span class="nv">`col_count&#39;</span><span class="s">&quot;</span>
<span class="k">					local</span> col_header_count = <span class="nv">`col_header_count&#39;</span> <span class="o">+</span> <span class="m">1</span>
				}
				<span class="c1">// use this to stop _continue</span>
<span class="k">				noisily di</span> <span class="s">&quot;&quot;</span>
				
				<span class="c1">// for counting variables</span>
<span class="k">				foreach</span> v of<span class="k"> varlist</span> <span class="nv">`cont&#39;</span> {
					 <span class="c1">// reset header count</span>
<span class="k">					 local</span> col_header_count = <span class="m">0</span>
					 <span class="c1">// count for excel row numbers</span>
<span class="k">					 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
					 <span class="c1">// reset excel_col_c to 1 so that new lines can be inputted to first cell of each lines</span>
<span class="k">					 local</span> excel_col_c = <span class="m">1</span>
					 <span class="c1">// label name and displaying status</span>
<span class="k">					 local</span> row_lab_c: variable<span class="k"> label</span> <span class="nv">`v&#39;</span>
					 <span class="c1">// set format</span>
<span class="k">					 local</span> D <span class="nx">%1.0f</span>
					 <span class="c1">// print variable name</span>
<span class="k">					 noisily di</span> <span class="s">&quot;</span><span class="nv">`row_lab_c&#39;</span><span class="s">&quot;</span> _continue
					 <span class="c1">// put variable name into cell</span>
					 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
					 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`row_lab_c&#39;</span><span class="s">&quot;</span>
					 <span class="c1">// print for each column</span>
<span class="k">					 foreach</span> col_h<span class="k"> in</span> <span class="nv">`by_var_val&#39;</span> {
						<span class="c1">// get correct separation space</span>
<span class="k">						local</span> col_sep_temp = <span class="nv">`col_sep&#39;</span> <span class="o">+</span> <span class="nv">`col_header_count&#39;</span> <span class="o">*</span> <span class="nv">`col_fac&#39;</span>
<span class="k">						local</span> col_s <span class="s">&quot;_col(</span><span class="nv">`col_sep_temp&#39;</span><span class="s">)&quot;</span>
						<span class="c1">// count for excel columns</span>
<span class="k">						local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
						<span class="c1">// get median and IQR info</span>
<span class="k">						quietly sum</span> <span class="nv">`v&#39;</span><span class="k"> if</span> <span class="nv">`by&#39;</span> <span class="o">==</span> <span class="nv">`col_h&#39;</span> <span class="nv">`if_helper&#39;</span>, detail
						<span class="c1">// display each column</span>
<span class="k">						local</span> col_percent :<span class="k"> di</span> <span class="nv">`D&#39;</span> <span class="nf">r</span>(p50) <span class="s">&quot; [&quot;</span> <span class="cs">///</span>
											<span class="nv">`D&#39;</span> <span class="nf">r</span>(p25) <span class="s">&quot;,&quot;</span> <span class="cs">///</span>
											<span class="nv">`D&#39;</span> <span class="nf">r</span>(p75) <span class="s">&quot;]&quot;</span>
<span class="k">						noisily di</span> <span class="nv">`col_s&#39;</span> <span class="s">&quot;</span><span class="nv">`col_percent&#39;</span><span class="s">&quot;</span>, _continue
						<span class="c1">// output to excel for median &amp; IQR</span>
						ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
						putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`col_percent&#39;</span><span class="s">&quot;</span>
<span class="k">						local</span> col_header_count = <span class="nv">`col_header_count&#39;</span> <span class="o">+</span> <span class="m">1</span>
					 }
					<span class="c1">// finish the line</span>
<span class="k">					noisily di</span> <span class="s">&quot;&quot;</span>
				 }
				 
				 <span class="c1">// for binary variables</span>
<span class="k">				 foreach</span> v of<span class="k"> varlist</span> <span class="nv">`binary&#39;</span> {
					 <span class="c1">// reset header count</span>
<span class="k">					 local</span> col_header_count = <span class="m">0</span>
					 <span class="c1">// label name and displaying status</span>
<span class="k">					 local</span> row_lab_b: variable<span class="k"> label</span> <span class="nv">`v&#39;</span>
					 <span class="c1">// set format</span>
<span class="k">					 local</span> D <span class="nx">%1.0f</span>
					 <span class="c1">// count for excel row numbers</span>
<span class="k">					 local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
					 <span class="c1">// reset excel_col_c to 1 so that new lines can be inputted to first cell of each lines</span>
<span class="k">					 local</span> excel_col_c = <span class="m">1</span>
					 <span class="c1">// put variable name into cell</span>
					 ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
					 putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`row_lab_b&#39;</span><span class="s">&quot;</span>
					 <span class="c1">// print variable name</span>
<span class="k">					 noisily di</span> <span class="s">&quot;</span><span class="nv">`row_lab_b&#39;</span><span class="s">&quot;</span> _continue
					 <span class="c1">// print for each column</span>
<span class="k">					 foreach</span> col_h<span class="k"> in</span> <span class="nv">`by_var_val&#39;</span> {
						<span class="c1">// get correct separation space</span>
<span class="k">						local</span> col_sep_temp = <span class="nv">`col_sep&#39;</span> <span class="o">+</span> <span class="nv">`col_header_count&#39;</span> <span class="o">*</span> <span class="nv">`col_fac&#39;</span>
<span class="k">						local</span> col_s <span class="s">&quot;_col(</span><span class="nv">`col_sep_temp&#39;</span><span class="s">)&quot;</span>
						<span class="c1">// count for excel columns</span>
<span class="k">						local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">						quietly sum</span> <span class="nv">`v&#39;</span><span class="k"> if</span> <span class="nv">`by&#39;</span> <span class="o">==</span> <span class="nv">`col_h&#39;</span> <span class="nv">`if_helper&#39;</span>, detail
<span class="k">						local</span> percent:<span class="k"> di</span> <span class="nv">`D&#39;</span> <span class="nv">`col1&#39;</span> <span class="nf">r</span>(mean)<span class="o">*</span><span class="m">100</span> 
<span class="k">						noisily di</span> <span class="nv">`D&#39;</span> <span class="nv">`col_s&#39;</span> <span class="nv">`percent&#39;</span>, _continue
						<span class="c1">// output to excel for median &amp; IQR</span>
						ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
						putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`percent&#39;</span><span class="s">&quot;</span>
<span class="k">						local</span> col_header_count = <span class="nv">`col_header_count&#39;</span> <span class="o">+</span> <span class="m">1</span>
					 }
<span class="k">					 noisily di</span> <span class="s">&quot;&quot;</span>
					 
				 }
				 
				 <span class="c1">// for categorical variables</span>
<span class="k">				 foreach</span> v of<span class="k"> varlist</span> <span class="nv">`multi&#39;</span> { 
					<span class="c1">// set format</span>
<span class="k">					 local</span> D <span class="nx">%1.0f</span>
<span class="k">					local</span> row_var_lab: variable<span class="k"> label</span> <span class="nv">`v&#39;</span>
<span class="k">					local</span> row_lab_m: value<span class="k"> label</span> <span class="nv">`v&#39;</span>
					<span class="c1">// get levels of the categorical variable</span>
<span class="k">					levelsof</span> <span class="nv">`v&#39;</span>
<span class="k">					local</span> var_level = <span class="nf">r</span>(levels)
					<span class="c1">// count for excel row numbers</span>
<span class="k">					local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
					<span class="c1">// reset excel_col_c to 1 so that new lines can be inputted to first cell of each lines</span>
<span class="k">					local</span> excel_col_c = <span class="m">1</span>
					<span class="c1">// put variable name into cell</span>
					ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
					putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`row_lab_m&#39;</span><span class="s">&quot;</span>
					<span class="c1">// display variable name</span>
<span class="k">					noisily di</span> <span class="s">&quot;</span><span class="nv">`row_var_lab&#39;</span><span class="s">&quot;</span>
					<span class="c1">// get value range in case some variables have extreme values like 0	 </span>
<span class="k">					sum</span> <span class="nv">`v&#39;</span> <span class="nv">`if&#39;</span>, detail
<span class="k">					local</span> v_min = <span class="nf">r</span>(min)
<span class="k">					local</span> v_max = <span class="nf">r</span>(max)
					<span class="c1">// loop from min to max</span>
<span class="k">					forvalues</span> v_val = <span class="nv">`v_min&#39;</span><span class="o">/</span><span class="nv">`v_max&#39;</span> {
						<span class="c1">// when loop from min to max, it is necessary to get rid off non-existing values</span>
						<span class="c1">// achieve this by count if the variable has the value or not</span>
<span class="k">						count if</span> <span class="nv">`v&#39;</span> <span class="o">==</span> <span class="nv">`v_val&#39;</span> <span class="nv">`if_helper&#39;</span>
<span class="k">						local</span> v_level_count = <span class="nf">r</span>(N)
<span class="k">						if</span> <span class="nv">`v_level_count&#39;</span> <span class="o">!=</span> <span class="m">0</span> {
							<span class="c1">// reset header count</span>
<span class="k">							local</span> col_header_count = <span class="m">0</span>
							<span class="c1">// reset excel_col_c to 1 so that new lines can be inputted to first cell of each lines</span>
<span class="k">							local</span> excel_col_c = <span class="m">1</span>
							<span class="c1">// label name and displaying variable value</span>
<span class="k">							local</span> v_level:<span class="k"> label</span> <span class="nv">`row_lab_m&#39;</span> <span class="nv">`v_val&#39;</span>
							<span class="c1">// count for excel row and output variable values</span>
<span class="k">							local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
							ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
							putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;     </span><span class="nv">`v_level&#39;</span><span class="s">&quot;</span>
<span class="k">							noisily di</span> _col(<span class="m">5</span>) <span class="s">&quot;</span><span class="nv">`v_level&#39;</span><span class="s">&quot;</span>, _continue
<span class="k">							foreach</span> col_h<span class="k"> in</span> <span class="nv">`by_var_val&#39;</span> {
								<span class="c1">// get correct separation space</span>
<span class="k">								local</span> col_sep_temp = <span class="nv">`col_sep&#39;</span> <span class="o">+</span> <span class="nv">`col_header_count&#39;</span> <span class="o">*</span> <span class="nv">`col_fac&#39;</span>
<span class="k">								local</span> col_s <span class="s">&quot;_col(</span><span class="nv">`col_sep_temp&#39;</span><span class="s">)&quot;</span>
								<span class="c1">// count for excel colmns</span>
<span class="k">								local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">								count if</span> <span class="nv">`v&#39;</span><span class="o">==</span><span class="nv">`v_val&#39;</span> <span class="o">&amp;</span> <span class="nv">`by&#39;</span> <span class="o">==</span> <span class="nv">`col_h&#39;</span> <span class="o">&amp;</span> <span class="o">!</span><span class="nf">missing</span>(<span class="nv">`v&#39;</span>) <span class="nv">`if_helper&#39;</span>
<span class="k">								local</span> num=<span class="nf">r</span>(N)
<span class="k">								count if</span> <span class="nv">`by&#39;</span> <span class="o">==</span> <span class="nv">`col_h&#39;</span> <span class="o">&amp;</span> <span class="o">!</span><span class="nf">missing</span>(<span class="nv">`v&#39;</span>) <span class="nv">`if_helper&#39;</span>
<span class="k">								local</span> t_num = <span class="nf">r</span>(N)
<span class="k">								local</span> v_percent = <span class="nv">`num&#39;</span> <span class="o">*</span> <span class="m">100</span> <span class="o">/</span> <span class="nv">`t_num&#39;</span>
<span class="k">								local</span> v_percent2 :<span class="k"> di</span> <span class="nv">`D&#39;</span> <span class="nv">`v_percent&#39;</span>
<span class="k">								noisily di</span> <span class="nv">`D&#39;</span> <span class="nv">`col_s&#39;</span> <span class="nv">`v_percent&#39;</span>, _continue
								<span class="c1">// output to excel</span>
								ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
								putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`v_percent2&#39;</span><span class="s">&quot;</span>
<span class="k">								local</span> col_header_count = <span class="nv">`col_header_count&#39;</span> <span class="o">+</span> <span class="m">1</span>
							}
<span class="k">							noisily di</span> <span class="s">&quot;&quot;</span>
						}					 
					}
				}
				
				<span class="c1">// missing values</span>
<span class="k">				local</span>  oldvarname:<span class="k"> di</span> <span class="s">&quot;</span><span class="nv">`cont&#39;</span><span class="s"> </span><span class="nv">`binary&#39;</span><span class="s"> </span><span class="nv">`multi&#39;</span><span class="s">&quot;</span>
<span class="k">				preserve</span>
<span class="k">				rename</span> (<span class="nv">`oldvarname&#39;</span>)(<span class="nv">`foot&#39;</span>)
<span class="k">				local</span> missvar <span class="s">&quot;</span><span class="nv">`foot&#39;</span><span class="s">&quot;</span>
				<span class="c1">// a line spacer</span>
<span class="k">				noisily di</span> <span class="s">&quot;&quot;</span>
				<span class="c1">// put the line separator into excel</span>
<span class="k">				local</span> excel_col_c = <span class="m">1</span>
<span class="k">				local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
				ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
				putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;&quot;</span>
<span class="k">				foreach</span> v of<span class="k"> varlist</span> <span class="nv">`missvar&#39;</span> {
<span class="k">					noisily di</span> <span class="s">&quot;</span><span class="nv">`v&#39;</span><span class="s">&quot;</span>, _continue
					<span class="c1">// output variable name into excel</span>
<span class="k">					local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">					local</span> excel_col_c = <span class="m">1</span>
					ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
					putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`v&#39;</span><span class="s">&quot;</span>
					<span class="c1">// reset col_header_count</span>
<span class="k">					local</span> col_header_count = <span class="m">0</span>
<span class="k">					foreach</span> col_h<span class="k"> in</span> <span class="nv">`by_var_val&#39;</span> {
<span class="k">						local</span> col_sep_temp = <span class="nv">`col_sep&#39;</span> <span class="o">+</span> <span class="nv">`col_header_count&#39;</span> <span class="o">*</span> <span class="nv">`col_fac&#39;</span>
<span class="k">						local</span> col_s <span class="s">&quot;_col(</span><span class="nv">`col_sep_temp&#39;</span><span class="s">)&quot;</span>
						<span class="c1">// count for excel col</span>
<span class="k">						local</span> excel_col_c = <span class="nv">`excel_col_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">						count if</span> <span class="nv">`by&#39;</span> <span class="o">==</span> <span class="nv">`col_h&#39;</span>
<span class="k">						local</span> denom = <span class="nf">r</span>(N)
<span class="k">						count if</span> <span class="nf">missing</span>(<span class="nv">`v&#39;</span>) <span class="o">&amp;</span> <span class="nv">`by&#39;</span> <span class="o">==</span> <span class="nv">`col_h&#39;</span>
<span class="k">						local</span> neu = <span class="nf">r</span>(N)
<span class="k">						local</span> per = <span class="nv">`neu&#39;</span> <span class="o">/</span> <span class="nv">`denom&#39;</span> <span class="o">*</span> <span class="m">100</span>
<span class="k">						local</span> per2 = <span class="nf">round</span>(<span class="nv">`per&#39;</span> <span class="o">*</span> <span class="m">10</span>) <span class="o">/</span> <span class="m">10</span> 
						<span class="c1">// output to excel</span>
						ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
						putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`per2&#39;</span><span class="s">% missing&quot;</span>
<span class="k">						noisily di</span> <span class="nv">`col_s&#39;</span> <span class="nx">%2.1f</span> <span class="nv">`per&#39;</span> <span class="s">&quot;% missing&quot;</span>, _continue
<span class="k">						local</span> col_header_count = <span class="nv">`col_header_count&#39;</span> <span class="o">+</span> <span class="m">1</span>
					}
<span class="k">					noisily di</span> <span class="s">&quot;&quot;</span>
				}
<span class="k">				noisily di</span> <span class="s">&quot;</span><span class="nv">`if&#39;</span><span class="s">&quot;</span>
<span class="k">				local</span> excel_row_c = <span class="nv">`excel_row_c&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">				local</span> excel_col_c = <span class="m">1</span>
				ind_translator, row(<span class="nv">`excel_row_c&#39;</span>) col(<span class="nv">`excel_col_c&#39;</span>)
				putexcel <span class="vg">$ul_cell</span> = <span class="s">&quot;</span><span class="nv">`if&#39;</span><span class="s">&quot;</span>
<span class="k">				restore</span>
			}
			
			
			
			
		}
		
		
		
		
		
	}
<span class="k">	</span>
<span class="k">end</span>
<span class="k">capture program drop</span> _all
<span class="k">program</span> define ind_translator
<span class="k">	syntax</span>, row(int) col(int)

	<span class="c1">// tokenize the alphabet</span>
<span class="k">	local</span> alphabet <span class="s">&quot;</span><span class="nv">`c(ALPHA)&#39;</span><span class="s">&quot;</span>
<span class="k">	tokenize</span> <span class="nv">`alphabet&#39;</span>
	<span class="c1">// now translate col</span>
<span class="k">	local</span> col_helper = <span class="nv">`col&#39;</span>
<span class="k">	</span>
<span class="k">	</span>
<span class="k">    while</span> (<span class="nv">`col_helper&#39;</span> <span class="o">&gt;</span> <span class="m">0</span>) {
<span class="k">		local</span> temp_helper2 = (<span class="nv">`col_helper&#39;</span> <span class="o">-</span> <span class="m">1</span>)
<span class="k">		local</span> temp_helper = <span class="nf">mod</span>(<span class="nv">`temp_helper2&#39;</span>, <span class="m">26</span>) <span class="o">+</span> <span class="m">1</span>
<span class="k">        local</span> col_name :<span class="k"> di</span> <span class="s">&quot;</span><span class="nv">``temp_helper&#39;&#39;</span><span class="s">&quot;</span> <span class="s">&quot;</span><span class="nv">`col_name&#39;</span><span class="s">&quot;</span>
<span class="k">        local</span> col_helper = (<span class="nv">`col_helper&#39;</span> <span class="o">-</span> <span class="nv">`temp_helper&#39;</span>) <span class="o">/</span> <span class="m">26</span>
    } 
	
	
	<span class="c1">// generate a global macro that can be used in main program</span>
<span class="k">	global</span> ul_cell <span class="s">&quot;</span><span class="nv">`col_name&#39;`row&#39;</span><span class="s">&quot;</span>
<span class="k">	</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="irmatch">
<h2>13. irmatch<a class="headerlink" href="#irmatch" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="c1">//TODO:</span>

<span class="c1">// currently does not work with abbreviated variable names</span>

<span class="c1">//- is there a way to implement / generalize Dorry&#39;s &quot;maxedout&quot; option?</span>
<span class="c1">//  (if no match, pick somebody with age within 5y, BMI 20-30, BP 100-140)</span>

<span class="c1">//TODO: radii are reported incorrectly in posted dataset</span>
<span class="c1">//(always reported as maximum allowable radius)</span>
<span class="c1">//for exmaple, in ltmatch_k2_without, &quot;init_age&quot; always = 5 even though actual radius is usu 1 or 2</span>

<span class="c1">//- k&gt;1 and &quot;without are IMPLEMENTED!</span>

<span class="k">program</span> define irmatch
<span class="c1">//rmatch 0.03</span>
<span class="c1">//by Allan Massie and Dorry Segev, Segev lab</span>
<span class="c1">//Department of Surgery, Johns Hopkins School of Medicine</span>

<span class="k">syntax</span> anything using, case(varname) id(varname) <span class="cs">///</span>
    [k(int <span class="m">1</span>)] [seed(real <span class="m">420</span>)] [without] [replace] [verbose] [pedantic]
   <span class="c1">//without = without replacement</span>

<span class="k">    disp in</span> smcl <span class="s">&quot;{hline}&quot;</span>
<span class="k">    disp</span> <span class="s">&quot;rmatch 0.03.&quot;</span>
<span class="k">    disp</span> <span class="s">&quot;When using this code, please cite:&quot;</span>
<span class="k">    disp in</span> smcl <span class="s">&quot;Massie et al 2013, {hi:&#39;Stata Journal Article&#39;}&quot;</span>
<span class="k">    disp</span> <span class="s">&quot;For a good reference on the radius matching techniques, consider:&quot;</span>
<span class="k">    disp in</span> smcl <span class="s">&quot;James et al 2013, {hi:&#39;Iterative Expanding Radius matching for observational studies&#39;},&quot;</span> <span class="cs">///</span>
    <span class="s">&quot; PMID {hi:XXXXXX}&quot;</span>
<span class="k">    disp in</span> smcl <span class="s">&quot;{hline}&quot;</span>

<span class="k">    preserve</span>

    <span class="c1">//make a local copy of `0&#39; to parse syntax before we actually get started</span>
    <span class="c1">//local arglist = &quot;`0&#39;&quot;</span>
<span class="k">    local</span> arglist <span class="s">&quot;</span><span class="nv">`0&#39;</span><span class="s">&quot;</span>   <span class="c1">//hopefully this fixes the max-256-char thing</span>

    <span class="c1">//PARSE INPUT</span>
<span class="k">    local n</span> = <span class="m">0</span>
<span class="k">    local</span> repeatvars = <span class="m">0</span>  <span class="c1">//once they start repeating, you can&#39;t add new vars</span>
<span class="k">    gettoken</span> curarg arglist:arglist
<span class="k">    while</span> <span class="s">&quot;</span><span class="nv">`curarg&#39;</span><span class="s">&quot;</span> <span class="o">!=</span> <span class="s">&quot;using&quot;</span> <span class="o">&amp;</span> <span class="nv">`n&#39;</span> <span class="o">&lt;</span> <span class="m">20</span> {
<span class="k">        local n</span> = <span class="nv">`n&#39;</span> <span class="o">+</span> <span class="m">1</span>
        <span class="c1">//gettoken curarg arglist:arglist</span>
        <span class="c1">//curarg = current argument</span>
        <span class="c1">//which should be of the form varname(n1(n2)n3) </span>
        <span class="c1">//NOTE: using &quot;tokenize&quot; here will spoil `1&#39;, `2&#39;, etc.</span>
        <span class="c1">//does not spoil `0&#39;</span>
<span class="k">        tokenize</span> <span class="s">&quot;</span><span class="nv">`curarg&#39;</span><span class="s">&quot;</span>,<span class="k"> parse</span>(<span class="s">&quot;()&quot;</span>)
        <span class="c1">//now, `1&#39; should be a varname</span>
<span class="k">        local</span> badinput = <span class="m">0</span>
<span class="k">        if</span> <span class="s">&quot;</span><span class="nv">`2&#39;`4&#39;`6&#39;`8&#39;</span><span class="s">&quot;</span> <span class="o">!=</span> <span class="s">&quot;(())&quot;</span>{
<span class="k">            local</span> badinput = <span class="m">1</span>
        }
<span class="k">        capture confirm</span> number <span class="nv">`3&#39;</span>
<span class="k">        if</span> _rc {
<span class="k">            local</span> badinput = <span class="m">1</span>
        }
<span class="k">        capture confirm</span> number <span class="nv">`5&#39;</span>
<span class="k">        if</span> _rc {
<span class="k">            local</span> badinput = <span class="m">1</span>
        }
<span class="k">        capture confirm</span> number <span class="nv">`7&#39;</span>
<span class="k">        if</span> _rc {
<span class="k">            local</span> badinput = <span class="m">1</span>
        }
<span class="k">        capture assert</span> <span class="nv">`3&#39;</span> <span class="o">&lt;</span> <span class="nv">`7&#39;</span>
<span class="k">        if</span> _rc {
<span class="k">            local</span> badinput = <span class="m">1</span>
        }
<span class="k">        if</span> <span class="nv">`badinput&#39;</span> <span class="o">==</span> <span class="m">1</span> {
<span class="k">            disp as error in</span> smcl <span class="cs">///</span>
            <span class="s">&quot;Error: each argument must be of the form varname(#1(#2)#3)&quot;</span>
<span class="k">            disp as error in</span> smcl <span class="cs">///</span>
            <span class="s">&quot;Where #1, #2 and #3 are numbers and #1 &lt;= #3&quot;</span>
<span class="k">            disp as error in</span> smcl <span class="cs">///</span>
            <span class="s">&quot;Bad argument </span><span class="nv">`curarg&#39;</span><span class="s">&quot;</span>
<span class="k">            exit</span>
        }
<span class="k">        capture confirm</span> variable <span class="nv">`1&#39;</span>
<span class="k">        if</span> _rc {
<span class="k">            disp as error in</span> smcl <span class="s">&quot;Error: variable </span><span class="nv">`1&#39;</span><span class="s"> does not exist&quot;</span>
<span class="k">            exit</span>
        }
<span class="k">        capture confirm</span> numeric variable <span class="nv">`1&#39;</span>
<span class="k">        if</span> _rc {
<span class="k">            disp as error in</span> smcl <span class="s">&quot;Error: variable </span><span class="nv">`1&#39;</span><span class="s"> is not numeric&quot;</span>
<span class="k">            exit</span>
        }
        <span class="c1">//input for this variable is valid</span>


<span class="k">        if</span> <span class="nv">`repeatvars&#39;</span> <span class="o">==</span> <span class="m">0</span> {
<span class="k">            if</span> <span class="s">&quot;</span><span class="nv">``1&#39;_start&#39;</span><span class="s">&quot;</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> { <span class="c1">//this var has not been listed before</span>
<span class="k">                local</span> <span class="nv">`1&#39;</span>_start = <span class="nv">`3&#39;</span>
<span class="k">                local</span> <span class="nv">`1&#39;</span>_rad = <span class="nv">`3&#39;</span>
<span class="k">                local</span> distinct_vars <span class="s">&quot;</span><span class="nv">`distinct_vars&#39;</span><span class="s"> </span><span class="nv">`1&#39;</span><span class="s">&quot;</span>
            }
<span class="k">            else</span> {  <span class="c1">//this var HAS been listed before</span>
<span class="k">                local</span> repeatvars = <span class="m">1</span>
<span class="k">                local</span> n_distinct = <span class="nv">`n&#39;</span> <span class="o">-</span> <span class="m">1</span>  <span class="c1">//# of distinct variables</span>
            }
        }
<span class="k">        else if</span> <span class="s">&quot;</span><span class="nv">``1&#39;_start &#39;</span><span class="s">&quot;</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> {
<span class="k">            disp as error in</span> smcl <span class="cs">///</span>
                <span class="s">&quot;Error: after listing the same variable twice, you can&#39;t introduce new variables &quot;</span>
<span class="k">            exit</span>
        }

<span class="k">        local var</span><span class="nv">`n&#39;</span>_name = <span class="s">&quot;</span><span class="nv">`1&#39;</span><span class="s">&quot;</span>
<span class="k">        local var</span><span class="nv">`n&#39;</span>_min = <span class="nv">`3&#39;</span>
<span class="k">        local var</span><span class="nv">`n&#39;</span>_step = <span class="nv">`5&#39;</span>
<span class="k">        local var</span><span class="nv">`n&#39;</span>_max = <span class="nv">`7&#39;</span>

<span class="k">        gettoken</span> curarg arglist:arglist
    }
    <span class="c1">//DONE PARSING INPUT</span>
    <span class="c1">//if we get this far, then the function was called correctly</span>

    <span class="c1">//construct the if statements</span>
<span class="k">    local</span> n_ifs = <span class="m">0</span>
    <span class="c1">//iterate over (possibly repeating) list of variables</span>
<span class="k">    forvalues</span> i = <span class="m">1</span><span class="o">/</span><span class="nv">`n&#39;</span> {
        <span class="c1">//iterate stepping from min to max</span>
<span class="k">        local</span> curvar <span class="s">&quot;</span><span class="nv">`var`i&#39;_name&#39;</span><span class="s">&quot;</span>
<span class="c1">//disp  &quot;`var`i&#39;_min&#39;(`var`i&#39;_step&#39;)`var`i&#39;_max&#39;&quot;</span>
<span class="k">        forvalues</span> var_step = <span class="nv">`var`i&#39;_min&#39;</span>(<span class="nv">`var`i&#39;_step&#39;</span>)<span class="nv">`var`i&#39;_max&#39;</span> {
<span class="k">            local</span> <span class="nv">`curvar&#39;</span>_rad = <span class="nv">`var_step&#39;</span>
<span class="c1">//disp &quot;`curvar&#39;   ``curvar&#39;_rad&#39;&quot;</span>
<span class="k">            local</span> n_ifs = <span class="nv">`n_ifs&#39;</span> <span class="o">+</span> <span class="m">1</span>
<span class="k">            local if</span><span class="nv">`n_ifs&#39;</span> = <span class="s">&quot;(1) &quot;</span> <span class="c1">//build the `if&#39; string</span>
            <span class="c1">//iterate over distinct vars to build the `if&#39; string</span>
<span class="k">            foreach</span> vv of<span class="k"> varlist</span> <span class="nv">`distinct_vars&#39;</span> {
                <span class="c1">//construct if statement (see macrotest.do)</span>
                <span class="c1">//later define local `vv&#39;_cur = value of vv for current record</span>
                <span class="c1">//This *seems* to work...</span>
<span class="k">                local</span> cur_if <span class="s">&quot;cond(missing(</span><span class="se">\`</span><span class="nv">`vv&#39;</span><span class="s">_cur\&#39;), 1, abs(</span><span class="nv">`vv&#39;</span><span class="s">-</span><span class="se">\`</span><span class="nv">`vv&#39;</span><span class="s">_cur\&#39;)&lt;=</span><span class="nv">``vv&#39;_rad&#39;</span><span class="s">)&quot;</span>

<span class="k">                local</span> cur_disp = <span class="nf">substr</span>(<span class="s">&quot;</span><span class="nv">`vv&#39;</span><span class="s">&quot;</span>,<span class="m">1</span>,<span class="m">3</span>)
<span class="k">                local</span> cur_disp <span class="s">&quot;</span><span class="nv">`cur_disp&#39;</span><span class="s"> </span><span class="se">\`</span><span class="nv">`vv&#39;</span><span class="s">_cur\&#39;/</span><span class="nv">``vv&#39;_rad&#39;</span><span class="s"> &quot;</span>
<span class="c1">//local age_don_cur &quot;OO&quot;</span>
<span class="c1">//disp `&quot;`cur_if&#39;&quot;&#39;</span>
<span class="c1">//local age_don_cur &quot;PP&quot;</span>
<span class="c1">//disp `&quot;`cur_if&#39;&quot;&#39;</span>
<span class="c1">//macval() keeps `age_don_cur&#39; or whatever from being interpreted at this point</span>

                <span class="c1">//local if`n_ifs&#39; &quot;`if`n_ifs&#39;&#39; &amp; `cur_if&#39;&quot; </span>
<span class="k">                local if</span><span class="nv">`n_ifs&#39;</span> <span class="s">&quot;</span><span class="nv">`macval(if`n_ifs&#39;)&#39;</span><span class="s"> &amp; </span><span class="nv">`macval(cur_if)&#39;</span><span class="s">&quot;</span> 
<span class="k">                local disp</span><span class="nv">`n_ifs&#39;</span> <span class="s">&quot;</span><span class="nv">`macval(disp`n_ifs&#39;)&#39;</span><span class="s"> </span><span class="nv">`macval(cur_disp)&#39;</span><span class="s">&quot;</span> 
<span class="cm">/*</span>
<span class="cm">local age_don_cur &quot;OO&quot;</span>
<span class="cm">disp `&quot;`if`n_ifs&#39;&#39;&quot;&#39;</span>
<span class="cm">local age_don_cur &quot;PP&quot;</span>
<span class="cm">disp `&quot;`if`n_ifs&#39;&#39;&quot;&#39;</span>
<span class="cm">*/</span>
            }
        }
    }
    <span class="c1">//DONE CONSTRUCTING IF STATEMENTS</span>
<span class="c1">//disp &quot;total `n_ifs&#39; if statements&quot;</span>

    <span class="c1">//disp &quot; original: `0&#39;&quot;</span>

<span class="k">    if</span> <span class="o">!</span><span class="nf">inrange</span>(<span class="nv">`k&#39;</span>, <span class="m">1</span>, <span class="m">100</span>) {
<span class="k">        disp in</span> smcl<span class="k"> as error</span> <span class="s">&quot;Error: k must be between 1 and 100&quot;</span> 
<span class="k">        exit</span>
    }

<span class="k">    if</span> <span class="s">&quot;</span><span class="nv">`without&#39;</span><span class="s">&quot;</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> {
<span class="k">        quietly count if</span> <span class="nv">`case&#39;</span> <span class="o">==</span> <span class="m">1</span>
<span class="k">        local</span> ncases = <span class="nf">r</span>(N)
<span class="k">        quietly count if</span> <span class="nv">`case&#39;</span> <span class="o">==</span> <span class="m">0</span>
<span class="k">        local</span> ncontrols = <span class="nf">r</span>(N)
<span class="k">        if</span> ((<span class="nv">`ncases&#39;</span> <span class="o">*</span> <span class="nv">`k&#39;</span>) <span class="o">&gt;</span> <span class="nv">`ncontrols&#39;</span>) {
<span class="k">            disp as error in</span> smcl <span class="cs">///</span>
              <span class="s">&quot;Error: controls must exceed k*cases if &#39;without&#39; option is used&quot;</span> 
<span class="k">            exit</span>
        }
    }

<span class="k">    quietly count if</span> <span class="o">!</span><span class="nf">inlist</span>(<span class="nv">`case&#39;</span>, <span class="m">0</span>, <span class="m">1</span>)
<span class="k">    if</span> <span class="nf">r</span>(N) <span class="o">&gt;</span> <span class="m">0</span> {
<span class="k">        disp as error in</span> smcl <span class="cs">///</span>
            <span class="s">&quot;Error: case variable(</span><span class="nv">`case&#39;</span><span class="s">) must be 0 or 1 for all records&quot;</span>
<span class="k">        exit</span>
    }
<span class="k">    quietly duplicates report</span> <span class="nv">`id&#39;</span>
<span class="k">    if</span> <span class="nf">r</span>(N) <span class="o">!=</span> <span class="nf">r</span>(unique_value) {
<span class="k">        disp as error in</span> smcl <span class="cs">///</span>
            <span class="s">&quot;Error: ID variable(</span><span class="nv">`id&#39;</span><span class="s">) is not a unique identifier&quot;</span>
<span class="k">        exit</span>
    }

<span class="k">    local</span> NUMERIC_ID = <span class="m">1</span>
<span class="k">    local</span> id_type:<span class="k"> type</span> <span class="nv">`id&#39;</span>
<span class="k">    if</span> <span class="nf">substr</span>(<span class="s">&quot;</span><span class="nv">`id_type&#39;</span><span class="s">&quot;</span>, <span class="m">1</span>,<span class="m">3</span>) <span class="o">==</span> <span class="s">&quot;str&quot;</span> {
<span class="k">        local</span> NUMERIC_ID = <span class="m">0</span>
    }

<span class="k">    set</span> seed <span class="nv">`seed&#39;</span>

    <span class="c1">//sort in random order</span>
<span class="k">    tempvar</span> rsort
<span class="k">    gen</span> <span class="nv">`rsort&#39;</span> = uniform()

    <span class="c1">//to match c cases on v variables, Dorry creates c*v local macros</span>
    <span class="c1">//then drops the cases and works with only the controls</span>

<span class="k">    quietly count if</span> <span class="nv">`case&#39;</span> <span class="o">==</span> <span class="m">1</span>
<span class="k">    local</span> ncases = <span class="nf">r</span>(N)
<span class="k">    quietly count if</span> <span class="nv">`case&#39;</span> <span class="o">==</span> <span class="m">0</span>
<span class="k">    local</span> ncontrols = <span class="nf">r</span>(N)

    <span class="c1">//At this point we have `n_ifs&#39; if statements to run for each record</span>


<span class="k">    tempvar</span> to_delete
<span class="k">    gen</span> <span class="nv">`to_delete&#39;</span> = <span class="m">0</span>  <span class="c1">//used for &quot;without&quot; option</span>

    <span class="c1">//create c*v local macros which store all the data for the cases</span>
<span class="k">    disp</span> <span class="s">&quot;Processing matching variables for cases...&quot;</span>
<span class="k">    gsort</span> <span class="o">-</span><span class="nv">`case&#39;</span> <span class="nv">`rsort&#39;</span> <span class="c1">//list cases first</span>
<span class="k">    forvalues</span> i = <span class="m">1</span><span class="o">/</span><span class="nv">`ncases&#39;</span> {
<span class="k">        local</span> id_<span class="nv">`i&#39;</span> = <span class="nv">`id&#39;</span>[<span class="nv">`i&#39;</span>]
<span class="k">        foreach</span> vv of<span class="k"> varlist</span> <span class="nv">`distinct_vars&#39;</span> {
<span class="k">            local</span> <span class="nv">`vv&#39;`i&#39;</span> = <span class="nv">`vv&#39;</span>[<span class="nv">`i&#39;</span>]
        }
    }
<span class="k">    disp</span> <span class="s">&quot;Done.&quot;</span>

<span class="k">    quietly keep if</span> <span class="nv">`case&#39;</span> <span class="o">==</span> <span class="m">0</span>
<span class="k">    tempvar</span> newcontrols alreadymatched
<span class="k">    quietly gen</span> int <span class="nv">`newcontrols&#39;</span> = <span class="m">0</span> <span class="c1">//mark whether a control matches the cur case</span>
<span class="k">    quietly gen</span> int <span class="nv">`alreadymatched&#39;</span> = <span class="m">0</span> <span class="c1">//mark whether record has already been matched to cur case</span>

<span class="k">    capture postclose</span> postit
<span class="k">    postfile</span> postit <span class="nv">`id_type&#39;</span> (<span class="nv">`id&#39;</span>_ctrl <span class="nv">`id&#39;</span>_case) <span class="cs">///</span>
        double <span class="nv">`distinct_vars&#39;</span> maxedout matchnum <span class="cs">///</span>
        <span class="nv">`using&#39;</span>, <span class="nv">`replace&#39;</span>

<span class="k">    local</span> step_size = <span class="m">200</span>
<span class="k">    if</span> (<span class="nv">`ncases&#39;</span> <span class="o">&lt;</span> <span class="m">2000</span>) {
<span class="k">        local</span> step_size = <span class="nf">ceil</span>(<span class="nv">`ncases&#39;</span><span class="o">/</span><span class="m">10</span>)
    }

<span class="k">    disp</span> <span class="s">&quot;Starting matching process for </span><span class="nv">`ncases&#39;</span><span class="s"> cases...&quot;</span>
    <span class="c1">//MAIN LOOP: iterate over the cases</span>
<span class="k">    forvalues</span> i=<span class="m">1</span><span class="o">/</span><span class="nv">`ncases&#39;</span> {
<span class="k">        quietly replace</span> <span class="nv">`alreadymatched&#39;</span> = <span class="m">0</span>   <span class="c1">//haven&#39;t matched to anybody yet</span>
<span class="k">        local</span> id_i <span class="nv">`id_`i&#39;&#39;</span>
<span class="k">        local</span> nc_total = <span class="m">0</span>  <span class="c1">//how many controls have been matched to this case</span>

        <span class="c1">//if var is (e.g.) &quot;age&quot;, we need to define &quot;age_cur&quot; = age for this record</span>
<span class="k">        foreach</span> vv of<span class="k"> varlist</span> <span class="nv">`distinct_vars&#39;</span> {
<span class="k">            local</span> <span class="nv">`vv&#39;</span>_cur = <span class="nv">``vv&#39;`i&#39;&#39;</span>
        }

        <span class="c1">//iterate over the ifs; initialization string</span>
<span class="k">        local</span> if_i <span class="m">1</span>

<span class="k">        local</span> remaining_matches = <span class="nv">`k&#39;</span>   <span class="c1">//how many MORE matches are required?</span>
        <span class="c1">//BEGIN ITERATION over each of the &quot;if&quot; strings that is used to expand the radius</span>
<span class="k">        while</span> <span class="nv">`remaining_matches&#39;</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">&amp;</span> <span class="nv">`if_i&#39;</span> <span class="o">&lt;=</span> <span class="nv">`n_ifs&#39;</span> {

<span class="k">            quietly count if</span> <span class="nv">`if`if_i&#39;&#39;</span> <span class="o">&amp;</span> <span class="nv">`alreadymatched&#39;</span> <span class="o">==</span> <span class="m">0</span>
<span class="k">            local</span> nc_total = <span class="nf">r</span>(N)  

<span class="k">            if</span> <span class="s">&quot;</span><span class="nv">`pedantic&#39;</span><span class="s">&quot;</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> {
<span class="k">             disp</span> <span class="s">&quot;id </span><span class="nv">`id_i&#39;</span><span class="s">: </span><span class="nv">`disp`if_i&#39;&#39;</span><span class="s">: </span><span class="nv">`nc_total&#39;</span><span class="s"> controls</span>
               <span class="c1">// disp &quot;    `if`if_i&#39;&#39;&quot;</span>
            }

            <span class="c1">//if we identified at least one control...</span>
<span class="k">            if</span> <span class="nv">`nc_total&#39;</span> <span class="o">&gt;</span> <span class="m">0</span> {
<span class="k">                quietly replace</span> <span class="nv">`newcontrols&#39;</span> = (<span class="nv">`if`if_i&#39;&#39;</span>) <span class="o">&amp;</span> <span class="nv">`alreadymatched&#39;</span> <span class="o">==</span> <span class="m">0</span>
<span class="k">                gsort</span> <span class="o">-</span><span class="nv">`newcontrols&#39;</span> <span class="nv">`rsort&#39;</span>

<span class="k">                local</span> new_matches = <span class="cs">///</span>
                    <span class="nf">cond</span>(<span class="nv">`nc_total&#39;</span> <span class="o">&lt;</span> <span class="nv">`remaining_matches&#39;</span>, <span class="nv">`nc_total&#39;</span>, <span class="nv">`remaining_matches&#39;</span>)
<span class="k">                forvalues</span> j=<span class="m">1</span><span class="o">/</span><span class="nv">`new_matches&#39;</span> {
<span class="k">                    local</span> nc_num=<span class="nf">floor</span>(uniform()<span class="o">*</span><span class="nv">`nc_total&#39;</span>)<span class="o">+</span><span class="m">1</span>
<span class="k">                    if</span> <span class="nv">`alreadymatched&#39;</span>[<span class="nv">`nc_num&#39;</span>] <span class="o">==</span> <span class="m">1</span> {
<span class="k">                        local</span> counter = <span class="m">0</span>
<span class="k">                        while</span> <span class="nv">`alreadymatched&#39;</span>[<span class="nv">`nc_num&#39;</span>] <span class="o">==</span> <span class="m">1</span> <span class="o">&amp;</span> <span class="nv">`counter&#39;</span> <span class="o">&lt;</span> <span class="m">20</span> {
<span class="k">                            local</span> nc_num=<span class="nf">floor</span>(uniform()<span class="o">*</span><span class="nv">`nc_total&#39;</span>)<span class="o">+</span><span class="m">1</span>
<span class="k">                            local</span> <span class="o">++</span>counter
                        }
                    }
<span class="k">                    if</span> <span class="s">&quot;</span><span class="nv">`verbose&#39;</span><span class="s">&quot;</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> {
<span class="k">                        disp</span> <span class="s">&quot;#</span><span class="nv">`i&#39;</span><span class="s"> of </span><span class="nv">`ncases&#39;</span><span class="s"> id </span><span class="nv">`id_i&#39;</span><span class="s">: &quot;</span> <span class="cs">///</span>
                             <span class="s">&quot;control </span><span class="nv">`j&#39;</span><span class="s"> drawn from control #</span><span class="nv">`nc_num&#39;</span><span class="s"> &quot;</span> <span class="cs">///</span>
                             <span class="s">&quot;id &quot;</span> <span class="nv">`id&#39;</span>[<span class="nv">`nc_num&#39;</span>]
                    }
<span class="k">                    local</span> post_str = <span class="s">&quot;&quot;</span>
<span class="k">                    foreach</span> vv of<span class="k"> varlist</span> <span class="nv">`distinct_vars&#39;</span> {
<span class="k">                        local</span> post_str = <span class="s">&quot;</span><span class="nv">`post_str&#39;</span><span class="s"> (</span><span class="nv">``vv&#39;_rad&#39;</span><span class="s">)&quot;</span>
                    }     <span class="c1">//iterate over vars to construct post string</span>

<span class="k">                    if</span> <span class="nv">`NUMERIC_ID&#39;</span> <span class="o">==</span> <span class="m">1</span> {
<span class="k">                        post</span> postit (<span class="nv">`id&#39;</span>[<span class="nv">`nc_num&#39;</span>]) (<span class="nv">`id_i&#39;</span>) <span class="nv">`post_str&#39;</span> <span class="cs">///</span>
                            (<span class="m">0</span>) (<span class="nv">`nc_total&#39;</span>)   <span class="c1">//(0) = not maxed out</span>
                    }
<span class="k">                    else</span> {
<span class="k">                        local</span> mymatch <span class="nv">`id&#39;</span>[<span class="nv">`nc_num&#39;</span>]
<span class="k">                        post</span> postit (<span class="nv">`mymatch&#39;</span>) (<span class="s">&quot;</span><span class="nv">`id_i&#39;</span><span class="s">&quot;</span>) <span class="nv">`post_str&#39;</span> <span class="cs">///</span>
                            (<span class="m">0</span>) (<span class="nv">`nc_total&#39;</span>)   <span class="c1">//(0) = not maxed out</span>
                    }

                    <span class="c1">//if w/o replacement, mark this control for deletion</span>
<span class="k">                    quietly replace</span> <span class="nv">`to_delete&#39;</span> = <span class="m">1</span><span class="k"> in</span> <span class="nv">`nc_num&#39;</span>
<span class="k">                    quietly replace</span> <span class="nv">`alreadymatched&#39;</span> = <span class="m">1</span><span class="k"> in</span> <span class="nv">`nc_num&#39;</span>
<span class="k">                    local</span> <span class="o">--</span>remaining_matches
                }  <span class="c1">//loop over the new_matches controls to assign</span>
                <span class="c1">//if doing w/o replacement, delete any ctrls that have been used</span>
<span class="k">                if</span> <span class="s">&quot;</span><span class="nv">`without&#39;</span><span class="s">&quot;</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> {
<span class="k">                    quietly drop if</span> <span class="nv">`to_delete&#39;</span> <span class="o">==</span> <span class="m">1</span>
                }
            }

            <span class="c1">//move to next &quot;if&quot; statement</span>
<span class="k">            if</span> <span class="nv">`remaining_matches&#39;</span> <span class="o">&gt;</span> <span class="m">0</span> {
<span class="k">                local</span> <span class="o">++</span>if_i
            }           <span class="c1">//if we haven&#39;t identified enough matches yet</span>
        }               <span class="c1">//while no matches &amp; keepgoing == 1</span>
        <span class="c1">//END ITERATING OVER &quot;IF&quot; STRINGS</span>

<span class="k">        local</span> maxedout = <span class="nv">`remaining_matches&#39;</span> <span class="o">&gt;</span> <span class="m">0</span>

<span class="k">        if</span> <span class="nv">`remaining_matches&#39;</span> <span class="o">&gt;</span> <span class="m">0</span> {          <span class="c1">//if we FAILED to identify enough controls</span>
<span class="k">            if</span> <span class="s">&quot;</span><span class="nv">`verbose&#39;</span><span class="s">&quot;</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> {
<span class="k">                disp</span> <span class="s">&quot;#</span><span class="nv">`i&#39;</span><span class="s"> of </span><span class="nv">`ncases&#39;</span><span class="s"> id </span><span class="nv">`id_i&#39;</span><span class="s">: &quot;</span> <span class="cs">///</span>
                <span class="s">&quot; failed to identify enough controls&quot;</span>
            }
<span class="k">            local</span> post_str = <span class="s">&quot;&quot;</span>
<span class="k">            foreach</span> vv of<span class="k"> varlist</span> <span class="nv">`distinct_vars&#39;</span> {
<span class="k">                local</span> post_str = <span class="s">&quot;</span><span class="nv">`post_str&#39;</span><span class="s"> (</span><span class="nv">``vv&#39;_rad&#39;</span><span class="s">)&quot;</span>
            }     <span class="c1">//iterate over vars to construct post string</span>
            <span class="c1">//post once for each non-match</span>
<span class="k">            forvalues</span> jj = <span class="m">1</span><span class="o">/</span><span class="nv">`remaining_matches&#39;</span> {
<span class="k">                if</span> <span class="nv">`NUMERIC_ID&#39;</span> <span class="o">==</span> <span class="m">1</span> {
<span class="k">                    post</span> postit (.) (<span class="nv">`id_i&#39;</span>) <span class="nv">`post_str&#39;</span> <span class="cs">///</span>
                        (<span class="nv">`maxedout&#39;</span>) (<span class="nv">`nc_total&#39;</span>)
                }
<span class="k">                else</span> {
<span class="k">                    post</span> postit (<span class="s">&quot;&quot;</span>) (<span class="s">&quot;</span><span class="nv">`id_i&#39;</span><span class="s">&quot;</span>) <span class="nv">`post_str&#39;</span> <span class="cs">///</span>
                        (<span class="nv">`maxedout&#39;</span>) (<span class="nv">`nc_total&#39;</span>)
                }
            }
        }   <span class="c1">//if we failed to identify enough controls</span>
<span class="k">        if</span> <span class="s">&quot;</span><span class="nv">`verbose&#39;</span><span class="s">&quot;</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="o">&amp;</span> <span class="nf">mod</span>(<span class="nv">`i&#39;</span>,<span class="nv">`step_size&#39;</span>) <span class="o">==</span> <span class="m">0</span> {
<span class="k">            disp</span> <span class="s">&quot;Finished </span><span class="nv">`i&#39;</span><span class="s"> of </span><span class="nv">`ncases&#39;</span><span class="s"> cases (&quot;</span> <span class="nx">%3.1f</span> <span class="nv">`i&#39;</span><span class="o">*</span><span class="m">100</span><span class="o">/</span><span class="nv">`ncases&#39;</span>  <span class="s">&quot;%)&quot;</span>
        }
    }                   <span class="c1">//loop over each case</span>

<span class="k">    postclose</span> postit
<span class="k">end</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="simulatepopulation">
<h2>14. simulatepopulation<a class="headerlink" href="#simulatepopulation" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">extra credit</span>
<span class="cm">reverse engineer</span>
<span class="cm">polack et al. nejm 2020</span>
<span class="cm">to  appreciate 340.600.71</span>
<span class="cm">from a fresh perspective</span>
<span class="cm">NEJM2020;383:2603-15</span>
<span class="cm">*/</span>

<span class="c1">//1.settings</span>
<span class="k">capture log close</span>
<span class="k">log</span> using BNT162b2<span class="m">.</span>log,<span class="k"> replace</span>
<span class="k">set more</span> off
<span class="k">clear</span> all
<span class="k">version</span> <span class="m">16</span> <span class="c1">//not checked whether it runs on earlier versions</span>

<span class="c1">//2.table1</span>
  <span class="c1">//row1: treatment assignment </span>
<span class="k">set</span> seed <span class="m">34060071</span>  
<span class="k">set</span> obs <span class="m">37706</span> <span class="c1">//study population  </span>
<span class="k">gen</span> bnt=<span class="nf">rbinomial</span>(<span class="m">1</span>,.<span class="m">5</span>) <span class="c1">//random 1:1 assignment</span>
<span class="k">lab</span> define Bnt <span class="cs">/// </span>
    <span class="m">0</span> <span class="s">&quot;Placebo&quot;</span> <span class="cs">/// group labels</span>
	<span class="m">1</span> <span class="s">&quot;BNT162b2&quot;</span>    
<span class="k">label</span> values bnt Bnt
<span class="k">tab</span> bnt

  <span class="c1">//row2: sex</span>
<span class="k">gen</span> female=<span class="nf">rbinomial</span>(<span class="m">1</span>, .<span class="m">494</span>)
<span class="k">label</span> define Female <span class="cs">///</span>
    <span class="m">0</span> <span class="s">&quot;Male&quot;</span> <span class="cs">///</span>
	<span class="m">1</span> <span class="s">&quot;Female&quot;</span>
<span class="k">label</span> values female Female
<span class="k">tab</span> female

  <span class="c1">//row3: race/ethnicity</span>
<span class="k">tempvar</span> dem <span class="c1">// temporarily need it</span>
<span class="k">gen</span> <span class="nv">`dem&#39;</span>=<span class="nf">round</span>(<span class="nf">runiform</span>(<span class="m">0</span>,<span class="m">100</span>),.<span class="m">1</span>) <span class="c1">// equal pr(sampled)</span>
<span class="k">recode</span> <span class="nv">`dem&#39;</span> <span class="cs">/// but not inform by race: </span>
    (<span class="m">0</span><span class="o">/</span><span class="m">82.9</span>=<span class="m">0</span>) <span class="cs">/// 82.9% white</span>
    (<span class="m">83.0</span><span class="o">/</span><span class="m">92.1</span>=<span class="m">1</span>) <span class="cs">/// 9.3% black</span>
    (<span class="m">92.2</span><span class="o">/</span><span class="m">96.51</span>=<span class="m">2</span>) <span class="cs">/// 4.3% asian  </span>
    (<span class="m">96.52</span><span class="o">/</span><span class="m">97.0</span>=<span class="m">3</span>) <span class="cs">/// 0.5% native american or alaskan</span>
    (<span class="m">97.1</span><span class="o">/</span><span class="m">97.2</span>=<span class="m">4</span>) <span class="cs">/// 0.2% native hawaiian/other pacific isl</span>
    (<span class="m">97.3</span><span class="o">/</span><span class="m">99.41</span>=<span class="m">5</span>) <span class="cs">/// 2.3% multiracial</span>
    (<span class="m">99.42</span><span class="o">/</span><span class="m">100</span>=<span class="m">6</span>) <span class="cs">/// 0.6% not reported</span>
     ,<span class="k"> gen</span>(race)
<span class="k">lab</span> define Race <span class="cs">///</span>
	<span class="m">0</span> <span class="s">&quot;White&quot;</span> <span class="cs">///    </span>
    <span class="m">1</span> <span class="s">&quot;Black or African American&quot;</span> <span class="cs">///</span>
	<span class="m">2</span> <span class="s">&quot;Asian&quot;</span> <span class="cs">///</span>
	<span class="m">3</span> <span class="s">&quot;Native American or Alsak Native&quot;</span> <span class="cs">///</span>
	<span class="m">4</span> <span class="s">&quot;Native Hawaiian or other Pacific Islander&quot;</span> <span class="cs">///</span>
	<span class="m">5</span> <span class="s">&quot;Multiracial&quot;</span> <span class="cs">///</span>
	<span class="m">6</span> <span class="s">&quot;Not reported&quot;</span>
<span class="k">label</span> values race Race
<span class="k">tab</span> race

    <span class="c1">//row4: ethnicity</span>
<span class="k">gen</span> ethnicity=<span class="nf">rbinomial</span>(<span class="m">1</span>,<span class="m">0.28</span>)
<span class="k">tostring</span> ethnicity,<span class="k"> replace</span>
<span class="k">replace</span> ethnicity=<span class="s">&quot;Latinx&quot;</span><span class="k"> if</span> ethnicity<span class="o">==</span><span class="s">&quot;1&quot;</span>
<span class="k">replace</span> ethnicity=<span class="s">&quot;Other&quot;</span><span class="k"> if</span> ethnicity<span class="o">==</span><span class="s">&quot;0&quot;</span>

     <span class="c1">//row5: country</span>
<span class="k">tempvar</span> country
<span class="k">gen</span> <span class="nv">`country&#39;</span>=<span class="nf">round</span>(<span class="nf">runiform</span>(<span class="m">0</span>,<span class="m">100</span>), .<span class="m">1</span>)
<span class="k">recode</span> <span class="nv">`country&#39;</span> <span class="cs">/// </span>
    (<span class="m">0</span><span class="o">/</span><span class="m">15.3</span>=<span class="m">0</span>) <span class="cs">/// 15.3% argentina</span>
	(<span class="m">15.4</span><span class="o">/</span><span class="m">21.5</span>=<span class="m">1</span>) <span class="cs">/// 6.1% brazil</span>
	(<span class="m">21.6</span><span class="o">/</span><span class="m">23.6</span>=<span class="m">2</span>) <span class="cs">/// 2.0% south africa</span>
	(<span class="m">23.7</span><span class="o">/</span><span class="m">100</span>=<span class="m">3</span>) <span class="cs">/// 76.7% united states</span>
	    ,<span class="k"> gen</span>(country) <span class="c1">// source populations</span>
<span class="k">label</span> define Country <span class="cs">///</span>
	<span class="m">0</span> <span class="s">&quot;Argentina&quot;</span> <span class="cs">///</span>
    <span class="m">1</span> <span class="s">&quot;Brazil&quot;</span> <span class="cs">///</span>
	<span class="m">2</span> <span class="s">&quot;South Africa&quot;</span> <span class="cs">///</span>
	<span class="m">3</span> <span class="s">&quot;United States&quot;</span>
<span class="k">label</span> values country Country
<span class="k">tab</span> country

    <span class="c1">//row7: age at vaccination</span>
<span class="k">gen</span> age=(<span class="nf">rt</span>(_N)<span class="o">*</span><span class="m">9.25</span>)<span class="o">+</span><span class="m">52</span> <span class="c1">//estimated mu,sigma from median/range</span>
<span class="k">replace</span> age=<span class="nf">runiform</span>(<span class="m">16</span>,<span class="m">91</span>) <span class="cs">/// range from table1 ~ 4*sigma </span>
<span class="k">    if</span> <span class="o">!</span><span class="nf">inrange</span>(age,<span class="m">16</span>,<span class="m">91</span>)
<span class="k">summ</span> age, detail
<span class="k">local</span> age_med=<span class="nf">r</span>(p50)
<span class="k">local</span> age_lb=<span class="nf">r</span>(min)
<span class="k">local</span> age_ub=<span class="nf">r</span>(max)
<span class="k">gen</span> dob =<span class="k"> d</span>(27jul2020) <span class="o">-</span>  <span class="cs">/// earliest recruitment into trial</span>
          (age<span class="o">*</span><span class="m">365.25</span>) <span class="c1">//  age at recruitment</span>
<span class="k">gen</span> dor = dob <span class="o">+</span> age<span class="o">*</span><span class="m">365.25</span> <span class="o">+</span> <span class="nf">runiform</span>(<span class="m">0</span>,<span class="m">4</span><span class="o">*</span><span class="m">30.25</span>)
	
    <span class="c1">//row6: age group can only be defined after age</span>
<span class="k">gen</span> over55=age<span class="o">&gt;</span><span class="m">55</span> <span class="c1">// actual population is 5.3% more</span>
<span class="k">tab</span> over55 <span class="c1">// suggesting skewness to left</span>

    <span class="c1">//row8: bmi</span>
<span class="k">gen</span> bmi=<span class="nf">rbinomial</span>(<span class="m">1</span>, .<span class="m">351</span>)
<span class="k">tab</span> bmi

<span class="c1">//figure 3: time-to-event data </span>
<span class="k">g</span> days=rweibull(.<span class="m">7</span>,<span class="m">17</span>,<span class="m">0</span>)<span class="k"> if</span> bnt<span class="o">==</span><span class="m">0</span> <span class="c1">//timing of covid for placebo</span>
<span class="k">g</span> covid=<span class="nf">rbinomial</span>(<span class="m">1</span>, <span class="m">162</span><span class="o">/</span><span class="m">21728</span>)<span class="k"> if</span> bnt<span class="o">==</span><span class="m">0</span> <span class="c1">//freq of covid event  </span>
<span class="c1">*replace days=rgamma(1/1.8,11) if bnt==1 //timing of covid for bnt</span>
<span class="k">replace</span> days=rweibull(.<span class="m">4</span>,.<span class="m">8</span>,<span class="m">0</span>)<span class="k"> if</span> bnt<span class="o">==</span><span class="m">1</span> <span class="c1">//timing of covid for bnt</span>

<span class="c1">*hist days if bnt==1 &amp; days&lt;114</span>

<span class="k">replace</span> covid=<span class="nf">rbinomial</span>(<span class="m">1</span>, <span class="m">14</span><span class="o">/</span><span class="m">21772</span>)<span class="k"> if</span> bnt<span class="o">==</span><span class="m">1</span>  <span class="c1">//freq of covid for bnt</span>

<span class="c1">//key dates </span>
<span class="k">gen</span> eft = dor <span class="o">+</span> days

<span class="c1">//date formats</span>
<span class="k">format</span> dob <span class="nx">%td</span>
<span class="k">format</span> dor <span class="nx">%td</span>
<span class="k">format</span> eft <span class="nx">%td</span>

 <span class="c1">//kaplan-meier curve</span>
<span class="k"> stset</span> days, fail(covid) 
<span class="k"> sts graph</span>, <span class="cs">/// kaplan-meier curve</span>
<span class="k">    by</span>(bnt) <span class="cs">/// stratifying variable</span>
    fail per(<span class="m">100</span>) <span class="cs">/// yscale in %</span>
    tmax(<span class="m">119</span>) <span class="cs">/// xscale limit</span>
    xlab(<span class="m">0</span>(<span class="m">7</span>)<span class="m">119</span>) <span class="cs">///</span>
    ylab(<span class="m">0</span>(.<span class="m">4</span>)<span class="m">2.4</span>, <span class="cs">///</span>
        angle(<span class="m">360</span>) <span class="cs">/// verticle/easy to read ylabs</span>
<span class="k">	    format</span>(<span class="s">&quot;%3.1f&quot;</span>)) <span class="cs">/// precision 1 decimal</span>
    xti(<span class="s">&quot;Days after Dose 1&quot;</span>) <span class="cs">///</span>
    legend(off) <span class="cs">///</span>
    text(<span class="m">2.3</span> <span class="m">100</span> <span class="s">&quot;Placebo&quot;</span>, <span class="cs">///</span>
	    col(navy)) <span class="cs">///</span>
    text(.<span class="m">5</span> <span class="m">100</span> <span class="s">&quot;BNT162b2&quot;</span>, <span class="cs">///</span>
	    col(maroon))
<span class="k">graph</span> export BNT162b2<span class="m">.</span>png,<span class="k"> replace</span>
<span class="k">stcox</span> bnt
<span class="k">drop</span> _<span class="o">*</span> age over55 days <span class="c1">//to be calculated by the student</span>
<span class="k">g</span> bnt_id=<span class="nf">round</span>(<span class="nf">runiform</span>(<span class="m">37</span>,<span class="m">37</span><span class="o">+</span>_N))
<span class="k">compress</span> <span class="c1">//change variables from float to byte if possible</span>

<span class="c1">//label variables</span>
<span class="k">lab var</span> bnt_id <span class="s">&quot;Participant Identifier&quot;</span>
<span class="k">lab var</span> bnt <span class="s">&quot;Random treatment assignment&quot;</span>
<span class="k">lab var</span> female <span class="s">&quot;Gender at birth&quot;</span>
<span class="k">lab var</span> race <span class="s">&quot;Self-identified race&quot;</span>
<span class="k">lab var</span> ethnicity <span class="s">&quot;Hispanic ethnicity&quot;</span>
<span class="k">lab var</span> country <span class="s">&quot;Country where trial was conducted&quot;</span>
<span class="k">lab var</span> dob <span class="s">&quot;Date of birth&quot;</span>
<span class="k">lab var</span> dor <span class="s">&quot;Date of recruitment into BNT162b2 trial&quot;</span>
<span class="k">lab var</span> eft <span class="s">&quot;Date of exit from BNT162b2 trial&quot;</span>
<span class="k">lab var</span> bmi <span class="s">&quot;Obese&quot;</span>
<span class="k">lab var</span> covid  <span class="s">&quot;Covid-19 status on eft date&quot;</span>

<span class="c1">//label data</span>
<span class="k">lab</span> data <span class="s">&quot;Safety and Efficacy of the BNT162b2 mRNA Covid-19 Vaccine&quot;</span>
<span class="k">describe</span>
<span class="k">order</span> bnt_id dob female race ethnicity country bmi bnt eft covid 
<span class="c1">***replace eft=. if eft&gt;d(15dec2020) //some folks lost to followup</span>
<span class="k">save</span> BNT162b2,<span class="k"> replace</span> 	  
<span class="k">log close</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="intervalcensoring">
<h2>15. intervalcensoring<a class="headerlink" href="#intervalcensoring" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="c1">** W. Werbel 7.20.20 HCV project stintreg code - darn I saved over this ESW code, not good</span>
<span class="c1">** Adapted from ESW project, curves still have that variable in place - swap out for relevant model and exp/outcome var</span>

<span class="k">use</span> steroid_ar_May_2020<span class="m">.</span>dta


<span class="c1">** change x axis from days to years</span>

<span class="k">gen</span> r_time_yrs= right_time<span class="o">/</span><span class="m">365</span>
<span class="k">gen</span> l_time_yrs= left_time<span class="o">/</span><span class="m">365</span>


<span class="c1">** set left time just a fraction beyond zero so that these people can enter interval censoring calculations and are not designated as being censored at time zero.</span>

<span class="k">replace</span> left_time=<span class="m">0.01</span><span class="k"> if</span> left_time<span class="o">==</span><span class="m">0</span>
<span class="k">replace</span> l_time_yrs=<span class="m">0.001</span><span class="k"> if</span> l_time_yrs<span class="o">==</span><span class="m">0</span>


<span class="c1">** example univariable code for rejection</span>

stintreg don_hcv_nat_numeric, interval(l_time_yrs r_time_yrs) distribution(weibull)


<span class="c1">** model checking, see if weibull fits ok</span>

<span class="k">estat</span> gofplot


<span class="c1">** survival curves; currently set up for ESW analysis, sub HCV!</span>

<span class="k">stcurve</span>, survival at1(Isteroid_maint=<span class="m">0</span>) at2(Isteroid_maint=<span class="m">1</span>) graphregion(<span class="nf">c</span>(white)) title(<span class="s">&quot;&quot;</span>) <span class="c1">// </span>
xtitle(<span class="s">&quot;Years post-transplantation&quot;</span>) xlabel(<span class="m">0</span> (<span class="m">1</span>) <span class="m">6</span>) xsca(titlegap(<span class="m">2</span>)) ytitle(<span class="s">&quot;Rejection-free survival&quot;</span> ) <span class="c1">//</span>
ysca(titlegap(<span class="m">2</span>)) ylabel(<span class="m">0</span> <span class="s">&quot;0%&quot;</span> <span class="m">0.25</span> <span class="s">&quot;25%&quot;</span> <span class="m">0.5</span> <span class="s">&quot;50%&quot;</span> <span class="m">0.75</span> <span class="s">&quot;75%&quot;</span> <span class="m">1</span> <span class="s">&quot;100%&quot;</span>) lpattern(dash) lwidth(<span class="o">*</span><span class="m">2</span>) legend (col(<span class="m">1</span>) <span class="c1">//</span>
<span class="k">order</span>( <span class="m">1</span> <span class="s">&quot;Early Steroid Withdrawal&quot;</span> <span class="m">2</span> <span class="s">&quot;Steroid Continuation&quot;</span>) nobox position(<span class="m">7</span>) ring(<span class="m">0</span>) region(lwidth(none)))

<span class="c1">** full model, sub HCV model! vars of interest are similar for rejection,</span>

stintreg Isteroid_maint don_age_decade recip_age_decade recip_black_race rec_hcv_numeric <span class="c1">//</span>
living_donor hla_0mismatch decile_rec_cpra dgf Ithymo_ind, interval(left_time right_time) distribution(weibull)

<span class="c1">** can flip the axis to make it nicer (no longer &quot;survival&quot; orientation)</span>

<span class="k">stcurve</span>, survival at1(Isteroid_maint=<span class="m">0</span>) at2(Isteroid_maint=<span class="m">1</span>) graphregion(<span class="nf">c</span>(white)) title(<span class="s">&quot;&quot;</span>) xtitle(<span class="s">&quot;Years post-transplantation&quot;</span>) <span class="c1">//</span>
xlabel(<span class="m">0</span> (<span class="m">1</span>) <span class="m">6</span>) xsca(titlegap(<span class="m">2</span>)) ytitle(<span class="s">&quot;Acute rejection&quot;</span> ) ysca(titlegap(<span class="m">2</span>)) ysc(reverse) ylabel(<span class="m">1</span> <span class="s">&quot;0%&quot;</span> <span class="m">0.9</span> <span class="s">&quot;10%&quot;</span> <span class="m">0.8</span> <span class="s">&quot;20%&quot;</span> <span class="m">0.7</span> <span class="s">&quot;30%&quot;</span>) <span class="c1">//</span>
lpattern(dash) lwidth(<span class="o">*</span><span class="m">2</span>) legend (col(<span class="m">1</span>)<span class="k"> order</span>( <span class="m">1</span> <span class="s">&quot;Early Steroid Withdrawal&quot;</span> <span class="m">2</span> <span class="s">&quot;Steroid Continuation&quot;</span>) nobox position(<span class="m">10</span>) ring(<span class="m">0</span>) region(lwidth(none)))

<span class="c1">** getting cumulative incidences</span>

<span class="k">replace</span> left_time=<span class="m">365</span> 
<span class="k">replace</span> right_time=<span class="m">365</span><span class="o">*</span><span class="m">2</span>
<span class="k"> </span>
<span class="k">predict</span> s1yr s2yr, surv
<span class="k"> </span>
<span class="k">replace</span> left_time=<span class="m">365</span><span class="o">*</span><span class="m">3</span>
<span class="k">replace</span> right_time=<span class="m">365</span><span class="o">*</span><span class="m">4</span>
<span class="k"> </span>
<span class="k">predict</span> s3yr s4yr, surv
<span class="k"> </span>
<span class="k">replace</span> left_time=<span class="m">365</span><span class="o">*</span><span class="m">5</span>
<span class="k">replace</span> right_time=<span class="m">365</span><span class="o">*</span><span class="m">6</span>
<span class="k"> </span>
<span class="k">predict</span> s5yr s6yr, surv
<span class="k"> </span>
<span class="k">list</span> Isteroid_maint s1yr s2yr s3yr s4yr s5yr s6yr, sepby(Isteroid_maint)
<span class="k"> </span>
<span class="k">tabstat</span> s1yr s2yr s3yr s4yr s5yr s6yr,<span class="k"> by</span>(Isteroid_maint) stats(mean)  <span class="c1">// subtract from 1</span>


<span class="c1">** other subanalyses to separate the curves</span>

<span class="c1">** black</span>

<span class="k">stcurve</span>, survival at1(recip_black_race=<span class="m">0</span>) at2(recip_black_race=<span class="m">1</span>) graphregion(<span class="nf">c</span>(white)) title(<span class="s">&quot;&quot;</span>) <span class="c1">//</span>
xtitle(<span class="s">&quot;Years post-transplantation&quot;</span>) xlabel(<span class="m">0</span> (<span class="m">1</span>) <span class="m">6</span>) xsca(titlegap(<span class="m">2</span>)) ytitle(<span class="s">&quot;Acute rejection&quot;</span> ) <span class="c1">//</span>
ysca(titlegap(<span class="m">2</span>)) ysc(reverse) ylabel(<span class="m">1</span> <span class="s">&quot;0%&quot;</span> <span class="m">0.9</span> <span class="s">&quot;10%&quot;</span> <span class="m">0.8</span> <span class="s">&quot;20%&quot;</span> <span class="m">0.7</span> <span class="s">&quot;30%&quot;</span>) lpattern(dash) lwidth(<span class="o">*</span><span class="m">2</span>) <span class="c1">//</span>
legend (col(<span class="m">1</span>)<span class="k"> order</span>( <span class="m">1</span> <span class="s">&quot;Non-black recipient&quot;</span> <span class="m">2</span> <span class="s">&quot;Black recipient&quot;</span>) nobox position(<span class="m">10</span>) ring(<span class="m">0</span>) region(lwidth(none)))

<span class="c1">** txp era</span>

<span class="k">stcurve</span>, survival at1(txp_era=<span class="m">0</span>) at2(txp_era=<span class="m">1</span>) at3(txp_era=<span class="m">2</span>) graphregion(<span class="nf">c</span>(white)) title(<span class="s">&quot;&quot;</span>) <span class="c1">//</span>
xtitle(<span class="s">&quot;Years post-transplantation&quot;</span>) xlabel(<span class="m">0</span> (<span class="m">1</span>) <span class="m">6</span>) xsca(titlegap(<span class="m">2</span>)) ytitle(<span class="s">&quot;Acute rejection&quot;</span> ) <span class="c1">//</span>
ysca(titlegap(<span class="m">2</span>)) ysc(reverse) ylabel(<span class="m">1</span> <span class="s">&quot;0%&quot;</span> <span class="m">0.9</span> <span class="s">&quot;10%&quot;</span> <span class="m">0.8</span> <span class="s">&quot;20%&quot;</span> <span class="m">0.7</span> <span class="s">&quot;30%&quot;</span>) lcolor (blue red black) <span class="c1">//</span>
lwidth(<span class="o">*</span><span class="m">2</span>) legend (col(<span class="m">1</span>)<span class="k"> order</span>( <span class="m">1</span> <span class="s">&quot;2000-2007&quot;</span> <span class="m">2</span> <span class="s">&quot;2008-2013&quot;</span> <span class="m">3</span> <span class="s">&quot;2014-2017&quot;</span>) nobox position(<span class="m">10</span>) ring(<span class="m">0</span>) region(lwidth(none)))

<span class="c1">** living donor</span>

<span class="k">stcurve</span>, survival at1(living_donor=<span class="m">0</span>) at2(living_donor=<span class="m">1</span>) graphregion(<span class="nf">c</span>(white)) title(<span class="s">&quot;&quot;</span>) <span class="c1">//</span>
xtitle(<span class="s">&quot;Years post-transplantation&quot;</span>) xlabel(<span class="m">0</span> (<span class="m">1</span>) <span class="m">6</span>) xsca(titlegap(<span class="m">2</span>)) ytitle(<span class="s">&quot;Acute rejection&quot;</span> ) <span class="c1">//</span>
ysca(titlegap(<span class="m">2</span>)) ysc(reverse) ylabel(<span class="m">1</span> <span class="s">&quot;0%&quot;</span> <span class="m">0.9</span> <span class="s">&quot;10%&quot;</span> <span class="m">0.8</span> <span class="s">&quot;20%&quot;</span> <span class="m">0.7</span> <span class="s">&quot;30%&quot;</span>) lcolor (blue red) lwidth(<span class="o">*</span><span class="m">2</span>) <span class="c1">//</span>
legend (col(<span class="m">1</span>)<span class="k"> order</span>( <span class="m">1</span> <span class="s">&quot;Deceased donor&quot;</span> <span class="m">2</span> <span class="s">&quot;Living donor&quot;</span>) nobox position(<span class="m">10</span>) ring(<span class="m">0</span>) region(lwidth(none)))

<span class="c1">** thymo</span>

<span class="k">stcurve</span>, survival at1(Ithymo_ind=<span class="m">0</span>) at2(Ithymo_ind=<span class="m">1</span>) graphregion(<span class="nf">c</span>(white)) title(<span class="s">&quot;&quot;</span>) <span class="c1">//</span>
xtitle(<span class="s">&quot;Years post-transplantation&quot;</span>) xlabel(<span class="m">0</span> (<span class="m">1</span>) <span class="m">6</span>) xsca(titlegap(<span class="m">2</span>)) ytitle(<span class="s">&quot;Acute rejection&quot;</span> ) <span class="c1">//</span>
ysca(titlegap(<span class="m">2</span>)) ysc(reverse) ylabel(<span class="m">1</span> <span class="s">&quot;0%&quot;</span> <span class="m">0.9</span> <span class="s">&quot;10%&quot;</span> <span class="m">0.8</span> <span class="s">&quot;20%&quot;</span> <span class="m">0.7</span> <span class="s">&quot;30%&quot;</span>) lcolor (blue red) lwidth(<span class="o">*</span><span class="m">2</span>) <span class="c1">//</span>
legend (col(<span class="m">1</span>)<span class="k"> order</span>( <span class="m">1</span> <span class="s">&quot;No thymoglobulin&quot;</span> <span class="m">2</span> <span class="s">&quot;Thymoglobulin&quot;</span>) nobox position(<span class="m">10</span>) ring(<span class="m">0</span>) region(lwidth(none)))
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="non-semi-para">
<h2>16. non-semi-para<a class="headerlink" href="#non-semi-para" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="c1">* to be presented on 03/14/22 to TRC analysts</span>
<span class="c1">* https://www.prb.org/usdata/indicator/deaths/table/</span>

<span class="c1">// cls</span>
<span class="k">use</span> 18_nhtable102feb2023<span class="m">.</span>dta,<span class="k"> clear</span> 

<span class="c1">//hazards: conditional risk </span>
     <span class="c1">//1. empirical</span>
<span class="k">     global</span> deathrate=(<span class="m">2854838</span><span class="o">/</span><span class="m">328300000</span>)


<span class="k">quietly</span> {
	 
	 <span class="c1">//exploration</span>
<span class="k">	 noi tab</span> female
<span class="k">	 sort</span> female 
<span class="k">	 sum</span> female 
<span class="k">	 global</span> lb:<span class="k"> di</span> <span class="nf">r</span>(N)<span class="o">*</span>(<span class="m">1</span><span class="o">-</span><span class="nf">r</span>(mean))<span class="o">-</span><span class="m">4</span>
<span class="k">	 global</span> ub:<span class="k"> di</span> <span class="nf">r</span>(N)<span class="o">*</span>(<span class="m">1</span><span class="o">-</span><span class="nf">r</span>(mean))<span class="o">+</span><span class="m">4</span>
<span class="k">	 g</span> years=permth_exm<span class="o">/</span><span class="m">12</span>
<span class="k">	 noi list</span> years mortstat female<span class="k"> in</span> <span class="vg">$lb</span><span class="o">/</span><span class="vg">$ub</span>
		 
	 <span class="c1">//analysis</span>
<span class="k">	 stset</span> years, fail(mortstat)

 
}



<span class="k">quietly</span> {
	
	<span class="c1">//2. nonparametric</span>
	 <span class="c1">// cls </span>
<span class="k">	 sts graph</span>, <span class="cs">///</span>
	     ha<span class="k"> by</span>(female) <span class="cs">///</span>
		 ylab(<span class="m">0</span>(.<span class="m">005</span>).<span class="m">03</span>, angle(<span class="m">360</span>)) <span class="cs">///</span>
		 yti(<span class="s">&quot;{&amp;lambda}&quot;</span>, size(<span class="m">6</span>) <span class="cs">///</span>
		     orient(horizontal)) <span class="cs">///</span>
		 xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
		 ti(<span class="s">&quot;Nonparametric&quot;</span>, size(<span class="m">3</span>)) <span class="cs">///</span>
		 legend(off ring(<span class="m">0</span>) <span class="cs">///</span>
		     pos(<span class="m">11</span>) <span class="cs">///</span>
<span class="k">			 order</span>(<span class="m">1</span> <span class="m">2</span>) <span class="cs">///</span>
			 row(<span class="m">2</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">1</span> <span class="s">&quot;Male&quot;</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">2</span> <span class="s">&quot;Female&quot;</span>) <span class="cs">///</span>
			 ) <span class="cs">///</span>
		 yline(<span class="vg">$deathrate</span>, <span class="cs">///</span>
		       lp(dash) <span class="cs">///</span>
			   lc(lime) <span class="cs">///</span>
			   ) 
<span class="k">	 graph save</span> ha_nonpar<span class="m">.</span>gph,<span class="k"> replace</span> 
		   
}



<span class="k">quietly</span>  {
	
	 <span class="c1">//2. survival, failure</span>
	 <span class="c1">// cls </span>
<span class="k">	 sts graph</span>, <span class="cs">///</span>
<span class="k">	 by</span>(female) <span class="cs">///</span>
		 fail <span class="cs">///</span>
		 per(<span class="m">100</span>) <span class="cs">///</span>
		 ylab(<span class="m">0</span>(<span class="m">20</span>)<span class="m">100</span>, angle(<span class="m">360</span>)<span class="k"> format</span>(<span class="nx">%3.0f</span>)) <span class="cs">///</span>
		 yti(<span class="s">&quot;%&quot;</span>, size(<span class="m">6</span>) <span class="cs">///</span>
		     orient(horizontal)) <span class="cs">///</span>
		 xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
		 ti(<span class="s">&quot;Nonparametric&quot;</span>, size(<span class="m">3</span>)) <span class="cs">///</span>
		 legend(on ring(<span class="m">0</span>) <span class="cs">///</span>
		     pos(<span class="m">11</span>) <span class="cs">///</span>
<span class="k">			 order</span>(<span class="m">1</span> <span class="m">2</span>) <span class="cs">///</span>
			 row(<span class="m">2</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">1</span> <span class="s">&quot;Male&quot;</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">2</span> <span class="s">&quot;Female&quot;</span>) <span class="cs">///</span>
			 ) <span class="cs">///</span>
		 yline(<span class="m">50</span>, <span class="cs">///</span>
		       lp(dash) <span class="cs">///</span>
			   lc(lime) <span class="cs">///</span>
			   ) 
<span class="k">			   </span>
<span class="k">	 graph save</span> surv_nonpar<span class="m">.</span>gph,<span class="k"> replace</span> 
		   
}


<span class="k">quietly</span>  {
	
	<span class="c1">//3. semiparametric</span>
	 <span class="c1">// cls </span>
<span class="k">	 stcox</span> female 
	 
	 <span class="c1">//baseline cumhaz</span>
<span class="k">	 predict</span> H, basec
<span class="k">	 sum</span> H
<span class="k">	 global</span> H=<span class="nf">r</span>(max)
	 
	 <span class="c1">//figure prep</span>
<span class="k">	 </span>
<span class="k">	 matrix</span> define a_mort=(<span class="m">0</span>,<span class="m">1</span>)
<span class="k">	 matrix</span> define b=<span class="nf">e</span>(b)
<span class="k">	 matrix</span> define V_mort=<span class="nf">e</span>(V)
<span class="k">	 matrix</span> b_mort = a_mort<span class="o">*</span>b&#39;
<span class="k">	 </span>
<span class="k">	 noi matrix list</span> b_mort
<span class="k">	 noi matrix list</span> V_mort
<span class="k">	 </span>
<span class="k">	 noi di</span> (<span class="m">1</span> <span class="o">-</span> <span class="nf">exp</span>(<span class="o">-</span><span class="vg">$H</span> <span class="o">*</span><span class="nf">exp</span>(b_mort[<span class="m">1</span>,<span class="m">1</span>])))<span class="o">*</span><span class="m">100</span>
<span class="k">	 noi di</span> (<span class="m">1</span> <span class="o">-</span> <span class="nf">exp</span>(<span class="o">-</span><span class="vg">$H</span> <span class="o">*</span><span class="nf">exp</span>(<span class="o">-</span><span class="m">1.78</span>)))<span class="o">*</span><span class="m">100</span>
<span class="k">	 </span>
<span class="k">	 g</span> risk0 = (<span class="m">1</span> <span class="o">-</span> <span class="nf">exp</span>(<span class="o">-</span>H <span class="o">*</span><span class="nf">exp</span>(b_mort[<span class="m">1</span>,<span class="m">1</span>])))<span class="o">*</span><span class="m">100</span>
<span class="k">	 g</span> risk1 = (<span class="m">1</span> <span class="o">-</span> <span class="nf">exp</span>(<span class="o">-</span>H <span class="o">*</span><span class="nf">exp</span>(b_mort[<span class="m">1</span>,<span class="m">2</span>])))<span class="o">*</span><span class="m">100</span>
<span class="k">	 </span>
<span class="k">	 local</span> complete=<span class="nf">e</span>(N)
<span class="k">	 local</span> complete:<span class="k"> di</span> <span class="nx">%2.0f</span> <span class="nv">`complete&#39;</span> <span class="s">&quot; of &quot;</span> <span class="nx">%2.0f</span> <span class="nv">`studypop&#39;</span>
<span class="k">	</span>
<span class="k">	 line</span> risk0 risk1 _t,<span class="k"> sort</span> <span class="cs">///</span>
	     ti(<span class="s">&quot;Semiparametric &quot;</span>, size(<span class="m">3</span>)) <span class="cs">///</span>
		 xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
		 yti(<span class="s">&quot;&quot;</span>,orient(horizontal)) <span class="cs">///</span>
		 ylab(<span class="m">0</span>(<span class="m">20</span>)<span class="m">100</span>, angle(<span class="m">360</span>)) <span class="cs">///</span>
		 xlab(<span class="m">0</span>(<span class="m">10</span>)<span class="m">30</span>) <span class="cs">///</span>
	     legend(off <span class="cs">///</span>
	         ring(<span class="m">0</span>) <span class="cs">////</span>
		     pos(<span class="m">11</span>) <span class="cs">///</span>
		     col(<span class="m">1</span>) <span class="cs">///</span>
<span class="k">		     lab</span>(<span class="m">1</span> <span class="s">&quot;Male&quot;</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">2</span> <span class="s">&quot;Female&quot;</span>) <span class="cs">///</span>
			 ) <span class="cs">///</span>
		 yline(<span class="m">50</span>, lp(dash) lc(lime))
<span class="k">		 </span>
<span class="k">	 graph save</span> surv_semipar<span class="m">.</span>gph,<span class="k"> replace</span> 
		   
}




<span class="k">quietly</span> {

<span class="k">     streg</span> female,<span class="k"> d</span>(weibull)
<span class="k">	 matrix</span> define h0 =<span class="k"> e</span>(b)
<span class="k">	 global</span> h0 = <span class="nf">exp</span>(_t<span class="o">*</span><span class="nf">exp</span>(h0[<span class="m">1</span>,<span class="m">2</span>]))
	 <span class="c1">//g h0 = exp(-1*_t*h0[1,2])</span>
<span class="k">     stcurve</span>, fail at(female= (<span class="m">0</span> <span class="m">1</span>)) <span class="cs">///</span>
		 ylab(<span class="m">0</span>(.<span class="m">2</span>)<span class="m">1</span>, <span class="cs">///</span>
		     angle(<span class="m">360</span>)) <span class="cs">///</span>
		 xlab(<span class="m">0</span>(<span class="m">10</span>)<span class="m">30</span>) <span class="cs">///</span>
		 yline(.<span class="m">5</span>, lc(lime) lp(dash)) <span class="cs">///</span>
		 yti(<span class="s">&quot;&quot;</span>) <span class="cs">///</span>
		 legend(off ring(<span class="m">0</span>) <span class="cs">///</span>
		     pos(<span class="m">11</span>) <span class="cs">///</span>
<span class="k">			 order</span>(<span class="m">1</span> <span class="m">2</span>) <span class="cs">///</span>
			 row(<span class="m">2</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">1</span> <span class="s">&quot;Male&quot;</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">2</span> <span class="s">&quot;Female&quot;</span>) <span class="cs">///</span>
			 ) <span class="cs">/// </span>
		 ti(<span class="s">&quot;Parametric&quot;</span>, size(<span class="m">3</span>))
<span class="k">		 </span>
<span class="k">	 graph save</span> surv_par<span class="m">.</span>gph,<span class="k"> replace</span> 
	 
}

<span class="k">quietly</span> {
	
	<span class="c1">//parametric vs. non-parametric </span>
	 <span class="c1">// cls </span>
<span class="k">	 sts graph</span>, <span class="cs">///</span>
	     ha<span class="k"> by</span>(female) <span class="cs">///</span>
		 ylab(<span class="m">0</span>(.<span class="m">005</span>).<span class="m">03</span>, angle(<span class="m">360</span>)) <span class="cs">///</span>
		 yti(<span class="s">&quot;&quot;</span>, size(<span class="m">6</span>) <span class="cs">///</span>
		     orient(horizontal)) <span class="cs">///</span>
		 xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
		 ti(<span class="s">&quot;Nonparametric&quot;</span>, size(<span class="m">3</span>)) <span class="cs">///</span>
		 legend(off ring(<span class="m">0</span>) <span class="cs">///</span>
		     pos(<span class="m">11</span>) <span class="cs">///</span>
<span class="k">			 order</span>(<span class="m">1</span> <span class="m">2</span>) <span class="cs">///</span>
			 row(<span class="m">2</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">1</span> <span class="s">&quot;Male&quot;</span>) <span class="cs">///</span>
<span class="k">			 lab</span>(<span class="m">2</span> <span class="s">&quot;Female&quot;</span>) <span class="cs">///</span>
			 ) <span class="cs">///</span>
		 yline(<span class="vg">$deathrate</span>, <span class="cs">///</span>
		       lp(dash) <span class="cs">///</span>
			   lc(lime) <span class="cs">///</span>
			   ) <span class="cs">///</span>
		 yline(<span class="vg">$h0</span>, <span class="cs">///</span>
		       lp(dash) <span class="cs">///</span>
			   lc(orange) <span class="cs">///</span>
			   )
<span class="k">			   </span>
<span class="k">	 graph save</span> ha_par<span class="m">.</span>gph,<span class="k"> replace</span> 
	 
}

<span class="k">graph</span> combine <span class="cs">///</span>
	 surv_nonpar<span class="m">.</span>gph <span class="cs">///</span>
	 surv_semipar<span class="m">.</span>gph <span class="cs">///</span>
	 surv_par<span class="m">.</span>gph <span class="cs">///</span>
	 ha_nonpar<span class="m">.</span>gph <span class="cs">///</span>
	 ha_par<span class="m">.</span>gph, <span class="cs">///</span>
	     row(<span class="m">2</span>)

<span class="k">graph</span> export nh_mort<span class="m">.</span>pdf,<span class="k"> replace</span> 
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="modelselection">
<h2>17. modelselection<a class="headerlink" href="#modelselection" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="k">quietly</span> {
	
	 cls 
<span class="k">	 clear</span>
<span class="k">	 noi di</span> <span class="s">&quot;and the winner is...&quot;</span>

<span class="k">	</span>
<span class="k">	if</span> <span class="m">1</span> {
		
		<span class="c1">//import data</span>
<span class="k">		use</span> 18_nhtable102feb2023<span class="m">.</span>dta
		
	}
<span class="k">	</span>
<span class="k">	if</span> <span class="m">2</span> {
		
		<span class="c1">//survival analysis</span>
<span class="k">		g</span> years=permth_exm<span class="o">/</span><span class="m">12</span>
<span class="k">		stset</span> years, fail(mortstat<span class="o">==</span><span class="m">1</span>)
		
	}	
<span class="k">	</span>
<span class="k">	if</span> <span class="m">0</span> {
		
		<span class="c1">//kaplan-meier</span>
<span class="k">		sts graph</span>, <span class="cs">///</span>
		     fail <span class="cs">///</span>
<span class="k">			 by</span>(htn) <span class="cs">///</span>
			 per(<span class="m">100</span>) <span class="cs">///</span>
			 ylab(, <span class="cs">///</span>
<span class="k">			     format</span>(<span class="nx">%3.0f</span>) angle(<span class="m">360</span>)) <span class="cs">///</span>
			 ti(<span class="s">&quot;Mortality in the United States, 1988-2018&quot;</span>) <span class="cs">///</span>
			 xti(<span class="s">&quot;Years&quot;</span>) <span class="cs">///</span>
			 yti(<span class="s">&quot;%&quot;</span>, <span class="cs">///</span>
			     orientation(horizontal)) <span class="cs">///</span>
			 legend(on <span class="cs">///</span>
			     ring(<span class="m">0</span>) <span class="cs">///</span>
				 pos(<span class="m">11</span>) <span class="cs">///</span>
				 col(<span class="m">1</span>) <span class="cs">///</span>
<span class="k">				 order</span>(<span class="m">2</span> <span class="m">1</span>) <span class="cs">///</span>
<span class="k">				 lab</span>(<span class="m">1</span> <span class="s">&quot;Normotensive&quot;</span>) <span class="cs">///</span>
<span class="k">				 lab</span>(<span class="m">2</span> <span class="s">&quot;Hypertensive&quot;</span>)) <span class="cs">///</span>
			 caption(<span class="s">&quot;Source: NHANES&quot;</span>)
		
	}
<span class="k">	</span>
<span class="k">	if</span> <span class="m">4</span> {
		
		<span class="c1">//nested models </span>
<span class="k">		global</span> demo age female i<span class="m">.</span>race i<span class="m">.</span>educ income 
<span class="k">		global</span> qa dm htn smk 
<span class="k">		global</span> exam sbp dbp bmi 
<span class="k">		global lab</span> hba1c acr glucose creat 
		
		<span class="c1">//cox regression</span>
<span class="k">		stcox</span> <span class="vg">$demo</span> 
<span class="k">		est</span> store demo 
<span class="k">		stcox</span> <span class="vg">$demo</span> <span class="vg">$qa</span>  
<span class="k">		est</span> store demoqa
<span class="k">		stcox</span> <span class="vg">$demo</span> <span class="vg">$qa</span> <span class="vg">$exam</span>  
<span class="k">		est</span> store demoqaexam
<span class="k">		stcox</span> <span class="vg">$demo</span> <span class="vg">$qa</span> <span class="vg">$exam</span> <span class="vg">$lab</span>
<span class="k">		est</span> store demoqaexamlab
		
		<span class="c1">//rank models </span>
<span class="k">		est</span> stat demo demoqa demoqaexam demoqaexamlab
		
		<span class="c1">//manipulate output</span>
<span class="k">		matrix</span> define models=<span class="nf">r</span>(S)
<span class="k">		noi matrix list</span> models
<span class="k">		svmat</span> models 
<span class="k">		keep</span> models<span class="o">*</span>
<span class="k">		rename</span> (models1 models2 models3 models4 models5 models6) <span class="cs">///</span>
		       (N ll0 ll df AIC BIC)
<span class="k">		egen</span> bestmodel=<span class="nf">min</span>(AIC)
<span class="k">		keep if</span> AIC<span class="o">==</span>bestmodel
<span class="k">		noi list</span> 
	}	
}
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="stsgraph">
<h2>18. stsgraph<a class="headerlink" href="#stsgraph" title="Permalink to this heading">#</a></h2>
<div class="highlight-stata notranslate"><div class="highlight"><pre><span></span><span class="k">qui</span> {
<span class="k">	</span>
<span class="k">	if</span> <span class="m">0</span> { <span class="c1">//background</span>
		
		<span class="m">1</span>. aesthetics<span class="k"> for sts graph</span> command
		<span class="m">2</span>. export .png or pdf and control width
		<span class="m">3</span>.<span class="k"> use</span> nh3andmort<span class="m">.</span>dta<span class="k"> for</span> illustration
		
	}
<span class="k">	</span>
<span class="k">	if</span> <span class="m">1</span> { <span class="c1">//methods</span>
<span class="k">		</span>
<span class="k">		use</span> nh3andmort<span class="m">.</span>dta,<span class="k"> clear</span> 
<span class="k">		g</span> years=permth_exm<span class="o">/</span><span class="m">12</span>
<span class="k">		stset</span> years, fail(mortstat)
		
	}
<span class="k">	</span>
<span class="k">    if</span> <span class="m">2</span> { <span class="c1">//results</span>
		
		        #delimit ;
<span class="k">        		sts graph if</span> <span class="nf">inrange</span>(hab1,<span class="m">1</span>,<span class="m">5</span>),
<span class="k">        		   by</span>(hab1)
        		   fail
        		   ti(<span class="s">&quot;Morality in NHANES III&quot;</span>,pos(<span class="m">11</span>))
        		   subti(<span class="s">&quot;Self-reported health status&quot;</span>,pos(<span class="m">11</span>))
        		   yti(<span class="s">&quot;%&quot;</span>,orientation(horizontal))
        		   xti(<span class="s">&quot;Years&quot;</span>)
        		   per(<span class="m">100</span>)
        		   ylab(<span class="m">0</span>(<span class="m">20</span>)<span class="m">80</span>,
<span class="k">        		       format</span>(<span class="nx">%3.0f</span>)
        		       angle(<span class="m">360</span>)
        		   )
        		   legend(on
				       size(<span class="m">2</span>)
					   region(margin(zero))
					   lpattern(blank)
<span class="k">        		       lab</span>(<span class="m">1</span> <span class="s">&quot;Excellent&quot;</span>)
<span class="k">        		       lab</span>(<span class="m">2</span> <span class="s">&quot;Good&quot;</span>)
<span class="k">        		       lab</span>(<span class="m">3</span> <span class="s">&quot;Fair&quot;</span>)
<span class="k">        		       lab</span>(<span class="m">4</span> <span class="s">&quot;Bad&quot;</span>)
<span class="k">        		       lab</span>(<span class="m">5</span> <span class="s">&quot;Poor&quot;</span>)
        		       ring(<span class="m">0</span>)
        		       pos(<span class="m">11</span>)
        		       col(<span class="m">1</span>)
<span class="k">        		       order</span>(<span class="m">5</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span>)
        		   )
<span class="k">        		   note</span>(<span class="s">&quot;Source: RDC/NCHS/CDC/DHHS&quot;</span>,
				       size(<span class="m">2</span>)
					   pos(<span class="m">7</span>)
					   )  
				   risktable(,
				       title(<span class="s">&quot;# at risk&quot;</span>,
					       size(<span class="m">2</span>))
					   size(<span class="m">2</span>)
<span class="k">					   order</span>(<span class="m">5</span> <span class="s">&quot; &quot;</span> <span class="m">4</span> <span class="s">&quot; &quot;</span> <span class="m">3</span> <span class="s">&quot; &quot;</span> <span class="m">2</span> <span class="s">&quot; &quot;</span> <span class="m">1</span> <span class="s">&quot; &quot;</span>)
				   )
				   risktable(,
				       group(#<span class="m">1</span>)
					   col(navy)
				   )
				   risktable(,
				       group(#<span class="m">2</span>)
					   col(maroon)
				   )	
				   risktable(,
				       group(#<span class="m">3</span>)
					   col(forest_green)
				   )	
				   risktable(,
				       group(#<span class="m">4</span>)
					   col(dkorange)
				   )
				   risktable(,
				       group(#<span class="m">5</span>)
					   col(teal)
				   )
				   ;
        		#delimit cr		
	}
<span class="k">	</span>
<span class="k">	if</span> <span class="m">3</span> { <span class="c1">//conclusion</span>
<span class="k">		</span>
<span class="k">        		graph</span> export nh3andmort<span class="m">.</span>png,replace width(<span class="m">2400</span>)
<span class="k">        		</span>
<span class="k">        		stcox</span> i<span class="m">.</span>hab1<span class="k"> if</span> <span class="nf">inrange</span>(hab1,<span class="m">1</span>,<span class="m">5</span>)
				
	}
	
}
</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./act_0/act_0_0/act_0_0_7"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coefplot">1. coefplot</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#matchrun">2. matchrun</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lungdx">3. lungdx</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhdemo">4. nhdemo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhexam">5. nhexam</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhmerge">6. nhmerge</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhmort">7. nhmort</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nhsurv">8. nhsurv</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table1">9. table1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kaplan-meier">10. kaplan-meier</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#r">11. r</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#intro">11.1 Intro</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">11.2 Methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#packages">11.3 Packages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#surv">11.4 Surv</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#results">11.5 Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">11.6 Conclusion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#table1-options">12. table1_options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#irmatch">13. irmatch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulatepopulation">14. simulatepopulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intervalcensoring">15. intervalcensoring</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-semi-para">16. non-semi-para</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelselection">17. modelselection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stsgraph">18. stsgraph</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Abimereki Muzaale, Vincent Jin, and JHU TRC
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>